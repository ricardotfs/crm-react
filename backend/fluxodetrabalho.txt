public static void SetWorkflow(JObject model)
{
    var IdConta = model["IdConta"].ToString();
    var IdUser = model["IdUser"].ToString();
    var IdModulo = model["IdModulo"].ToString();
    var Tipo = model["Tipo"].ToString();

    var dvWorkflow = new DataView(GVPFramework.RetornaDataTable(
        $"SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED SELECT Id FROM Workflow (NOLOCK) WHERE IdConta = {IdConta} AND IdModulo = {IdModulo} AND {Tipo} = 1"));

    if (dvWorkflow.Count > 0)
    {
        foreach (DataRowView item in dvWorkflow)
        {
            GVPFramework.ExecutaQuery(
                $@"INSERT INTO WorkflowRegua (IdWorkflow, IdUser, IdStatus, DataExecucao)
                VALUES ({item[0].ToString()}, {IdUser}, 0, GETDATE())
            ");
        }
    }
}


   private void timer1_Tick(object sender, EventArgs e)
        {
            timer1.Enabled = false;

            var isWorkFlowService = ckbIsWorkflow.Checked;

            string[] alertaArray = new string[] { "0", "5", "15", "60", "1440" };

            var query = $@"
                SELECT Conta.Id, Timezones.UTCOFFSET
                FROM Conta (NOLOCK)
	                INNER JOIN Timezones (NOLOCK) ON Timezones.TIMEZONEID = Conta.IdTimezone
                WHERE Id NOT IN (485, 1)
	                AND StatusId IN (1)
            ";

            if (!String.IsNullOrWhiteSpace(filtroPorConta))
                query += $" AND Conta.Id IN ({filtroPorConta})";

            if (!String.IsNullOrWhiteSpace(ignorarPorConta))
                query += $" AND Conta.Id NOT IN ({ignorarPorConta})";

            var dv = new DataView(GVPFramework.RetornaDataTable(query));
            var iTemp = 0;

            if (dv.Count > 0)
            {
                if (isWorkFlowService)
                {
                    //Foi separado a conta da Whirlpool / Serpro por conta do volume

                    if (!String.IsNullOrWhiteSpace(filtroPorConta))
                        filtro = $" AND IdConta IN ({filtroPorConta})";

                    if (!String.IsNullOrWhiteSpace(ignorarPorConta))
                        filtro = $" AND IdConta NOT IN ({ignorarPorConta})";

                    foreach (DataRowView dr in dv)
                    {
                        var strSplit = dr["UTCOFFSET"].ToString().Split(':');
                        var TimeZoneValue = double.Parse(strSplit[0] + "." + strSplit[1]);

                        lblContaLength.Text = iTemp + "/" + dv.Count;

                        #region Workflow
                        //	SERVIÇO QUE COLOCA NA REGUA O PRIMEIRO GATILHO

                        query = $@"
                            SELECT WorkflowRegua.Id, IdWorkflow
                            FROM WorkflowRegua (NOLOCK) 
                                INNER JOIN Workflow (NOLOCK) ON Workflow.Id = WorkflowRegua.IdWorkflow 
                            WHERE (IdStatus = 0 OR IdStatus IS NULL) 
                                {filtro}
                                {filtroDeWorkflow}
                        ";

                        var dvWorkflow = new DataView(GVPFramework.RetornaDataTable(query));

                        if (dvWorkflow.Count > 0)
                        {
                            foreach (DataRowView drWkf in dvWorkflow)
                            {
                                query = $@"
                                    SELECT TOP 1 Id 
                                    FROM WorkflowGatilhos (NOLOCK) 
                                    WHERE IdWorkflow = {drWkf["IdWorkflow"].ToString()}
                                    ORDER BY Id ASC
                                ";

                                var dvWorkflowGatilhos = new DataView(GVPFramework.RetornaDataTable(query));

                                if (dvWorkflowGatilhos.Count > 0)
                                {
                                    GVPFramework.ExecutaQuery("UPDATE WorkflowRegua SET IdStatus = 1 WHERE Id = " + drWkf["Id"].ToString());
                                    query = $@"
                                        INSERT INTO WorkflowReguaGatilhos (IdRegua, IdGatilho, IsConcluido, DataExecucao)
                                        VALUES ({drWkf["Id"].ToString()}, {dvWorkflowGatilhos[0]["Id"].ToString()}, 0, GETDATE())
                                    ";
                                    GVPFramework.ExecutaQuery(query);
                                }
                                else
                                {
                                    GVPFramework.ExecutaQuery("UPDATE WorkflowRegua SET IdStatus = 2 WHERE Id = " + drWkf["Id"].ToString());
                                }
                            }
                        }

                        //  SERVIÇO QUE EXECUTA A REGUA E CHAMA O PROXIMO GATILHO

                        query = $@"
	                        SELECT TOP(5000)
                                WorkflowReguaGatilhos.Id, 
		                        WorkflowReguaGatilhos.IdRegua, 
		                        WorkflowReguaGatilhos.IdGatilho,
		                        WorkflowGatilhos.IdWorkflow,
		                        WorkflowRegua.IdUser,
		                        Workflow.IdModulo,
		                        TipoCadastro.Nome,
		                        Workflow.IdConta
	                        FROM WorkflowReguaGatilhos (NOLOCK) 
		                        INNER JOIN WorkflowRegua (NOLOCK) ON WorkflowRegua.Id = WorkflowReguaGatilhos.IdRegua
		                        INNER JOIN WorkflowGatilhos (NOLOCK) ON WorkflowGatilhos.Id = WorkflowReguaGatilhos.IdGatilho
		                        INNER JOIN Workflow (NOLOCK) ON Workflow.Id = WorkflowGatilhos.IdWorkflow
		                        INNER JOIN TipoCadastro (NOLOCK) ON TipoCadastro.Id = Workflow.IdModulo
	                        WHERE WorkflowReguaGatilhos.IsConcluido = 0 
		                        AND WorkflowReguaGatilhos.DataExecucao BETWEEN DATEADD(MONTH, -1, GETDATE())  AND  GETDATE()
                                {filtro}
                                {filtroDeWorkflow}
                            ORDER BY WorkflowReguaGatilhos.DataExecucao ASC
                        ";

                        //query = $@"
                        //    SELECT TOP(5000)
                        //        WorkflowReguaGatilhos.Id, 
                        //        WorkflowReguaGatilhos.IdRegua, 
                        //        WorkflowReguaGatilhos.IdGatilho,
                        //        WorkflowGatilhos.IdWorkflow,
                        //        WorkflowRegua.IdUser,
                        //        Workflow.IdModulo,
                        //        TipoCadastro.Nome,
                        //        Workflow.IdConta
                        //    FROM WorkflowReguaGatilhos (NOLOCK) 
                        //        INNER JOIN WorkflowRegua (NOLOCK) ON WorkflowRegua.Id = WorkflowReguaGatilhos.IdRegua
                        //        INNER JOIN WorkflowGatilhos (NOLOCK) ON WorkflowGatilhos.Id = WorkflowReguaGatilhos.IdGatilho
                        //        INNER JOIN Workflow (NOLOCK) ON Workflow.Id = WorkflowGatilhos.IdWorkflow
                        //        INNER JOIN TipoCadastro (NOLOCK) ON TipoCadastro.Id = Workflow.IdModulo
                        //    WHERE WorkflowReguaGatilhos.Id = 425859213
                        //    ORDER BY WorkflowReguaGatilhos.DataExecucao ASC
                        //";

                        dvWorkflow = new DataView(GVPFramework.RetornaDataTable(isWorkFlowService ? query : ""));

                        if (dvWorkflow.Count > 0)
                        {
                            foreach (DataRowView drWkf in dvWorkflow)
                            {
                                var isTimeout = false;
                                var dateTimeout = DateTime.Now;

                                var passaCondicao = true;

                                //  EXECUTA O GATILHO

                                query = $@"
                                    SELECT WorkflowGatilhos.IdWorkflow, 
                                        WorkflowGatilhos.IdTipoGatilho, 
                                        WorkflowGatilhos.IdTipoAcao, 
                                        WorkflowGatilhos.Acao, 
                                        WorkflowGatilhos.Mensagem,
	                                    Workflow.IdConta, 
	                                    Workflow.IdModulo,
			                            Workflow.Nome
                                    FROM WorkflowGatilhos (NOLOCK) 
	                                    INNER JOIN Workflow (NOLOCK) ON Workflow.Id = WorkflowGatilhos.IdWorkflow
                                    WHERE WorkflowGatilhos.Id = {drWkf["IdGatilho"].ToString()}
                                ";
                                var executaAcao = new DataView(GVPFramework.RetornaDataTable(query));

                                if (executaAcao.Count > 0)
                                {
                                    if (executaAcao[0]["IdTipoGatilho"].ToString() == "3")
                                    {
                                        #region GatilhoLog
                                        GVPFramework.AdicionaLinhaTempo(executaAcao[0]["IdConta"].ToString(), executaAcao[0]["IdModulo"].ToString(), drWkf["IdUser"].ToString(), "5", executaAcao[0]["Acao"].ToString() + " (Workflow " + executaAcao[0]["Nome"].ToString() + ")", "1", DateTime.Now.AddHours(3).ToString("yyyy-MM-dd HH:mm:ss"));
                                        #endregion
                                    }
                                    else if (executaAcao[0]["IdTipoGatilho"].ToString() == "2")
                                    {
                                        #region GatilhoTimeOut
                                        isTimeout = true;
                                        try
                                        {
                                            var diasSplit = executaAcao[0]["Acao"].ToString().Split('|');
                                            if (diasSplit.Length > 1)
                                            {
                                                var diasUteis = diasSplit[0].ToString();
                                                var dias = diasSplit[1].ToString();

                                                if (diasUteis == "True")
                                                {
                                                    var t = TimeSpan.FromSeconds(double.Parse(dias));

                                                    var i = 0;
                                                    while (t.Days != i)
                                                    {
                                                        if (dateTimeout.DayOfWeek != DayOfWeek.Saturday && dateTimeout.DayOfWeek != DayOfWeek.Sunday)
                                                        {
                                                            dateTimeout = dateTimeout.AddDays(1);
                                                            i++;
                                                        }
                                                        else
                                                            dateTimeout = dateTimeout.AddDays(1);
                                                    }
                                                    dateTimeout = DateTime.Parse(dateTimeout.ToString("yyyy-MM-dd") + " 08:00:00");
                                                }
                                            }
                                            else
                                            {
                                                dateTimeout = dateTimeout.AddHours(3).AddSeconds(double.Parse(executaAcao[0]["Acao"].ToString()));
                                            }
                                        }
                                        catch (Exception ex)
                                        {

                                        }
                                        #endregion
                                    }
                                    else if (executaAcao[0]["IdTipoGatilho"].ToString() == "4")
                                    {
                                        #region GatilhoCondicao
                                        if (executaAcao[0]["Acao"].ToString() == "or")
                                            passaCondicao = false;

                                        var strCondicao = "";
                                        var passaParaCondicaoSistema = false;

                                        var dvCondicoes = new DataView(GVPFramework.RetornaDataTable("SELECT IdCondicao, IdCampo, Campo, Valor FROM WorkflowGatilhosAcoes (NOLOCK) WHERE IdGatilho = " + drWkf["IdGatilho"].ToString()));

                                        if (dvCondicoes.Count == 1)
                                        {
                                            if (dvCondicoes[0]["IdCampo"].ToString() != "" && dvCondicoes[0]["IdCampo"].ToString() != "-1")
                                                strCondicao = "AND IdPropriedade = " + dvCondicoes[0]["IdCampo"].ToString();
                                            else
                                                passaParaCondicaoSistema = true;
                                        }
                                        else
                                        {
                                            foreach (DataRowView cond in dvCondicoes)
                                            {
                                                if (cond["IdCampo"].ToString() != "" && cond["IdCampo"].ToString() != "-1")
                                                    strCondicao += (strCondicao.Length > 0 ? " OR " : "") + "IdPropriedade = " + cond["IdCampo"].ToString();
                                                else
                                                    passaParaCondicaoSistema = true;

                                            }

                                            if (strCondicao.Length > 0)
                                                strCondicao = "AND (" + strCondicao + ")";
                                        }

                                        if (strCondicao.Length > 0)
                                        {
                                            query = $@"
                                                SELECT IdPropriedade, Resposta  
                                                FROM PropriedadeResposta (NOLOCK)
                                                WHERE IdUser = {drWkf["IdUser"].ToString()}
	                                                {strCondicao}
                                            ";

                                            var dvCondicao = new DataView(GVPFramework.RetornaDataTable(query));

                                            if (dvCondicao.Count > 0)
                                            {
                                                foreach (DataRowView drCondicao in dvCondicao)
                                                {
                                                    if (dvCondicoes.Count > 0)
                                                    {
                                                        if (dvCondicoes.Count == 1)
                                                        {
                                                            if (dvCondicoes[0]["IdCondicao"].ToString() == "==")
                                                            {
                                                                if (drCondicao["Resposta"].ToString().Trim().ToLower() != dvCondicoes[0]["Valor"].ToString().Trim().ToLower())
                                                                    passaCondicao = false;
                                                            }
                                                            else if (dvCondicoes[0]["IdCondicao"].ToString() == "!=")
                                                            {
                                                                if (drCondicao["Resposta"].ToString().Trim().ToLower() == dvCondicoes[0]["Valor"].ToString().Trim().ToLower())
                                                                    passaCondicao = false;
                                                            }
                                                            else if (dvCondicoes[0]["IdCondicao"].ToString() == "LIKE")
                                                            {
                                                                if (drCondicao["Resposta"].ToString().Trim().ToLower().IndexOf(dvCondicoes[0]["Valor"].ToString().Trim().ToLower()) < 0)
                                                                    passaCondicao = false;
                                                            }
                                                        }
                                                        else
                                                        {
                                                            if (executaAcao[0]["Acao"].ToString() == "or")
                                                            {
                                                                foreach (DataRowView cond in dvCondicoes)
                                                                {
                                                                    if (drCondicao["IdPropriedade"].ToString() == cond["IdCampo"].ToString())
                                                                    {
                                                                        if (!passaCondicao)
                                                                        {
                                                                            if (cond["IdCondicao"].ToString() == "==")
                                                                            {
                                                                                if (drCondicao["Resposta"].ToString().Trim().ToLower() == cond["Valor"].ToString().Trim().ToLower())
                                                                                    passaCondicao = true;
                                                                            }
                                                                            else if (cond["IdCondicao"].ToString() == "!=")
                                                                            {
                                                                                if (drCondicao["Resposta"].ToString().Trim().ToLower() != cond["Valor"].ToString().Trim().ToLower())
                                                                                    passaCondicao = true;
                                                                            }
                                                                            else if (cond["IdCondicao"].ToString() == "LIKE")
                                                                            {
                                                                                if (drCondicao["Resposta"].ToString().Trim().ToLower().IndexOf(cond["Valor"].ToString().Trim().ToLower()) >= 0)
                                                                                    passaCondicao = true;
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                            else
                                                            {
                                                                foreach (DataRowView cond in dvCondicoes)
                                                                {
                                                                    if (drCondicao["IdPropriedade"].ToString() == cond["IdCampo"].ToString())
                                                                    {
                                                                        if (passaCondicao)
                                                                        {
                                                                            if (cond["IdCondicao"].ToString() == "==")
                                                                            {
                                                                                if (drCondicao["Resposta"].ToString().Trim().ToLower() != cond["Valor"].ToString().Trim().ToLower())
                                                                                    passaCondicao = false;
                                                                            }
                                                                            else if (cond["IdCondicao"].ToString() == "!=")
                                                                            {
                                                                                if (drCondicao["Resposta"].ToString().Trim().ToLower() == cond["Valor"].ToString().Trim().ToLower())
                                                                                    passaCondicao = false;
                                                                            }
                                                                            else if (cond["IdCondicao"].ToString() == "LIKE")
                                                                            {
                                                                                if (drCondicao["Resposta"].ToString().Trim().ToLower().IndexOf(cond["Valor"].ToString().Trim().ToLower()) < 0)
                                                                                    passaCondicao = false;
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                if (dvCondicoes[0]["IdCondicao"].ToString() == "!=" && dvCondicoes[0]["Valor"].ToString() != "")
                                                    passaCondicao = true;
                                                else if (dvCondicoes[0]["IdCondicao"].ToString() == "==" && dvCondicoes[0]["Valor"].ToString() == "")
                                                    passaCondicao = true;
                                                else if(dvCondicoes[0]["IdCondicao"].ToString() == "==" && dvCondicoes[0]["Valor"].ToString() == "SELECIONE")
                                                    passaCondicao = true;
                                                else
                                                    passaCondicao = false;
                                            }
                                        }

                                        if (passaParaCondicaoSistema)
                                        {
                                            if (dvCondicoes.Count == 1)
                                            {
                                                if (dvCondicoes[0]["IdCampo"].ToString() == "-1")
                                                {
                                                    if (dvCondicoes[0]["Campo"].ToString() == "Status")
                                                    {
                                                        var status = GVPFramework.getStatusByModel(executaAcao[0]["IdModulo"].ToString(), drWkf["IdUser"].ToString());

                                                        if (dvCondicoes[0]["IdCondicao"].ToString() == "==")
                                                        {
                                                            if (status.Trim().ToLower() != dvCondicoes[0]["Valor"].ToString().Trim().ToLower())
                                                                passaCondicao = false;
                                                        }
                                                        else if (dvCondicoes[0]["IdCondicao"].ToString() == "!=")
                                                        {
                                                            if (status.Trim().ToLower() == dvCondicoes[0]["Valor"].ToString().Trim().ToLower())
                                                                passaCondicao = false;
                                                        }
                                                        else if (dvCondicoes[0]["IdCondicao"].ToString() == "LIKE")
                                                        {
                                                            if (status.Trim().ToLower().IndexOf(dvCondicoes[0]["Valor"].ToString().Trim().ToLower()) < 0)
                                                                passaCondicao = false;
                                                        }
                                                    }
                                                    else if (dvCondicoes[0]["Campo"].ToString() == "Fila")
                                                    {
                                                        var status = GVPFramework.getFilaByModel(executaAcao[0]["IdModulo"].ToString(), drWkf["IdUser"].ToString());

                                                        if (dvCondicoes[0]["IdCondicao"].ToString() == "==")
                                                        {
                                                            if (status.Trim().ToLower() != dvCondicoes[0]["Valor"].ToString().Trim().ToLower())
                                                                passaCondicao = false;
                                                        }
                                                        else if (dvCondicoes[0]["IdCondicao"].ToString() == "!=")
                                                        {
                                                            if (status.Trim().ToLower() == dvCondicoes[0]["Valor"].ToString().Trim().ToLower())
                                                                passaCondicao = false;
                                                        }
                                                        else if (dvCondicoes[0]["IdCondicao"].ToString() == "LIKE")
                                                        {
                                                            if (status.Trim().ToLower().IndexOf(dvCondicoes[0]["Valor"].ToString().Trim().ToLower()) < 0)
                                                                passaCondicao = false;
                                                        }
                                                    }
                                                    else if (dvCondicoes[0]["Campo"].ToString() == "Empresa")
                                                    {
                                                        var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                            SELECT Empresa.Nome 
                                                            FROM vwEmpresa({executaAcao[0]["IdConta"].ToString()}) Empresa
                                                            WHERE Id = (SELECT IdEmpresa FROM Contato WHERE Id = {drWkf["IdUser"].ToString()})
                                                        "));
                                                        var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";

                                                        if (dvCondicoes[0]["IdCondicao"].ToString() == "==")
                                                        {
                                                            if (status.Trim().ToLower() != dvCondicoes[0]["Valor"].ToString().Trim().ToLower())
                                                                passaCondicao = false;
                                                        }
                                                        else if (dvCondicoes[0]["IdCondicao"].ToString() == "!=")
                                                        {
                                                            if (status.Trim().ToLower() == dvCondicoes[0]["Valor"].ToString().Trim().ToLower())
                                                                passaCondicao = false;
                                                        }
                                                        else if (dvCondicoes[0]["IdCondicao"].ToString() == "LIKE")
                                                        {
                                                            if (status.Trim().ToLower().IndexOf(dvCondicoes[0]["Valor"].ToString().Trim().ToLower()) < 0)
                                                                passaCondicao = false;
                                                        }
                                                    }
                                                    else if (dvCondicoes[0]["Campo"].ToString() == "Grupo empresarial")
                                                    {
                                                        var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                            SELECT Empresa.Nome 
                                                            FROM vwEmpresa({executaAcao[0]["IdConta"].ToString()}) Empresa
                                                            WHERE Id = (SELECT IdEmpresa FROM Empresa WHERE Id = {drWkf["IdUser"].ToString()})
                                                        "));
                                                        var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";

                                                        if (dvCondicoes[0]["IdCondicao"].ToString() == "==")
                                                        {
                                                            if (status.Trim().ToLower() != dvCondicoes[0]["Valor"].ToString().Trim().ToLower())
                                                                passaCondicao = false;
                                                        }
                                                        else if (dvCondicoes[0]["IdCondicao"].ToString() == "!=")
                                                        {
                                                            if (status.Trim().ToLower() == dvCondicoes[0]["Valor"].ToString().Trim().ToLower())
                                                                passaCondicao = false;
                                                        }
                                                        else if (dvCondicoes[0]["IdCondicao"].ToString() == "LIKE")
                                                        {
                                                            if (status.Trim().ToLower().IndexOf(dvCondicoes[0]["Valor"].ToString().Trim().ToLower()) < 0)
                                                                passaCondicao = false;
                                                        }
                                                    }
                                                    else if (dvCondicoes[0]["Campo"].ToString() == "Grupo")
                                                    {
                                                        var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                            SELECT Nome 
                                                            FROM PropriedadeGrupo
                                                            WHERE Id = (SELECT IdGrupo FROM Atributo WHERE Id = {drWkf["IdUser"].ToString()})
                                                        "));
                                                        var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";

                                                        if (dvCondicoes[0]["IdCondicao"].ToString() == "==")
                                                        {
                                                            if (status.Trim().ToLower() != dvCondicoes[0]["Valor"].ToString().Trim().ToLower())
                                                                passaCondicao = false;
                                                        }
                                                        else if (dvCondicoes[0]["IdCondicao"].ToString() == "!=")
                                                        {
                                                            if (status.Trim().ToLower() == dvCondicoes[0]["Valor"].ToString().Trim().ToLower())
                                                                passaCondicao = false;
                                                        }
                                                        else if (dvCondicoes[0]["IdCondicao"].ToString() == "LIKE")
                                                        {
                                                            if (status.Trim().ToLower().IndexOf(dvCondicoes[0]["Valor"].ToString().Trim().ToLower()) < 0)
                                                                passaCondicao = false;
                                                        }
                                                    }
                                                    else if (dvCondicoes[0]["Campo"].ToString() == "Canal de origem")
                                                    {
                                                        var status = GVPFramework.getCanalByModel(executaAcao[0]["IdModulo"].ToString(), drWkf["IdUser"].ToString());

                                                        if (dvCondicoes[0]["IdCondicao"].ToString() == "==")
                                                        {
                                                            if (status.Trim().ToLower() != dvCondicoes[0]["Valor"].ToString().Trim().ToLower())
                                                                passaCondicao = false;
                                                        }
                                                        else if (dvCondicoes[0]["IdCondicao"].ToString() == "!=")
                                                        {
                                                            if (status.Trim().ToLower() == dvCondicoes[0]["Valor"].ToString().Trim().ToLower())
                                                                passaCondicao = false;
                                                        }
                                                        else if (dvCondicoes[0]["IdCondicao"].ToString() == "LIKE")
                                                        {
                                                            if (status.Trim().ToLower().IndexOf(dvCondicoes[0]["Valor"].ToString().Trim().ToLower()) < 0)
                                                                passaCondicao = false;
                                                        }
                                                    }
                                                    else if (dvCondicoes[0]["Campo"].ToString() == "Etapa")
                                                    {
                                                        var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                            SELECT Oportunidade.Nome 
                                                            FROM Oportunidade (NOLOCK)
                                                                INNER JOIN OportunidadeStatus (NOLOCK) ON OportunidadeStatus.Id = Oportunidade.IdOportunidadeStatus
                                                            WHERE Oportunidade.Id = {drWkf["IdUser"].ToString()}
                                                        "));
                                                        var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";

                                                        if (dvCondicoes[0]["IdCondicao"].ToString() == "==")
                                                        {
                                                            if (status.Trim().ToLower() != dvCondicoes[0]["Valor"].ToString().Trim().ToLower())
                                                                passaCondicao = false;
                                                        }
                                                        else if (dvCondicoes[0]["IdCondicao"].ToString() == "!=")
                                                        {
                                                            if (status.Trim().ToLower() == dvCondicoes[0]["Valor"].ToString().Trim().ToLower())
                                                                passaCondicao = false;
                                                        }
                                                        else if (dvCondicoes[0]["IdCondicao"].ToString() == "LIKE")
                                                        {
                                                            if (status.Trim().ToLower().IndexOf(dvCondicoes[0]["Valor"].ToString().Trim().ToLower()) < 0)
                                                                passaCondicao = false;
                                                        }
                                                    }
                                                    else if (dvCondicoes[0]["Campo"].ToString() == "Empresa do contato")
                                                    {
                                                        var status = GVPFramework.getEmpresaDoContatoByModel(executaAcao[0]["IdConta"].ToString(), executaAcao[0]["IdModulo"].ToString(), drWkf["IdUser"].ToString());

                                                        if (dvCondicoes[0]["IdCondicao"].ToString() == "==")
                                                        {
                                                            if (status.Trim().ToLower() != dvCondicoes[0]["Valor"].ToString().Trim().ToLower())
                                                                passaCondicao = false;
                                                        }
                                                        else if (dvCondicoes[0]["IdCondicao"].ToString() == "!=")
                                                        {
                                                            if (status.Trim().ToLower() == dvCondicoes[0]["Valor"].ToString().Trim().ToLower())
                                                                passaCondicao = false;
                                                        }
                                                        else if (dvCondicoes[0]["IdCondicao"].ToString() == "LIKE")
                                                        {
                                                            if (status.Trim().ToLower().IndexOf(dvCondicoes[0]["Valor"].ToString().Trim().ToLower()) < 0)
                                                                passaCondicao = false;
                                                        }
                                                    }
                                                    else if (dvCondicoes[0]["Campo"].ToString() == "Nome do contato")
                                                    {
                                                        var status = GVPFramework.getContatoByModel(executaAcao[0]["IdConta"].ToString(), executaAcao[0]["IdModulo"].ToString(), drWkf["IdUser"].ToString());

                                                        if (dvCondicoes[0]["IdCondicao"].ToString() == "==")
                                                        {
                                                            if (status.Trim().ToLower() != dvCondicoes[0]["Valor"].ToString().Trim().ToLower())
                                                                passaCondicao = false;
                                                        }
                                                        else if (dvCondicoes[0]["IdCondicao"].ToString() == "!=")
                                                        {
                                                            if (status.Trim().ToLower() == dvCondicoes[0]["Valor"].ToString().Trim().ToLower())
                                                                passaCondicao = false;
                                                        }
                                                        else if (dvCondicoes[0]["IdCondicao"].ToString() == "LIKE")
                                                        {
                                                            if (status.Trim().ToLower().IndexOf(dvCondicoes[0]["Valor"].ToString().Trim().ToLower()) < 0)
                                                                passaCondicao = false;
                                                        }
                                                    }
                                                    else if (dvCondicoes[0]["Campo"].ToString() == "Cidade do contato")
                                                    {
                                                        var status = GVPFramework.getCamposContatoByModel(executaAcao[0]["IdConta"].ToString(), executaAcao[0]["IdModulo"].ToString(), drWkf["IdUser"].ToString(), "Cidade");

                                                        if (dvCondicoes[0]["IdCondicao"].ToString() == "==")
                                                        {
                                                            if (status.Trim().ToLower() != dvCondicoes[0]["Valor"].ToString().Trim().ToLower())
                                                                passaCondicao = false;
                                                        }
                                                        else if (dvCondicoes[0]["IdCondicao"].ToString() == "!=")
                                                        {
                                                            if (status.Trim().ToLower() == dvCondicoes[0]["Valor"].ToString().Trim().ToLower())
                                                                passaCondicao = false;
                                                        }
                                                        else if (dvCondicoes[0]["IdCondicao"].ToString() == "LIKE")
                                                        {
                                                            if (status.Trim().ToLower().IndexOf(dvCondicoes[0]["Valor"].ToString().Trim().ToLower()) < 0)
                                                                passaCondicao = false;
                                                        }
                                                    }
                                                    else if (dvCondicoes[0]["Campo"].ToString() == "Estado do contato")
                                                    {
                                                        var status = GVPFramework.getCamposContatoByModel(executaAcao[0]["IdConta"].ToString(), executaAcao[0]["IdModulo"].ToString(), drWkf["IdUser"].ToString(), "Estado");

                                                        if (dvCondicoes[0]["IdCondicao"].ToString() == "==")
                                                        {
                                                            if (status.Trim().ToLower() != dvCondicoes[0]["Valor"].ToString().Trim().ToLower())
                                                                passaCondicao = false;
                                                        }
                                                        else if (dvCondicoes[0]["IdCondicao"].ToString() == "!=")
                                                        {
                                                            if (status.Trim().ToLower() == dvCondicoes[0]["Valor"].ToString().Trim().ToLower())
                                                                passaCondicao = false;
                                                        }
                                                        else if (dvCondicoes[0]["IdCondicao"].ToString() == "LIKE")
                                                        {
                                                            if (status.Trim().ToLower().IndexOf(dvCondicoes[0]["Valor"].ToString().Trim().ToLower()) < 0)
                                                                passaCondicao = false;
                                                        }
                                                    }
                                                    else if (dvCondicoes[0]["Campo"].ToString() == "Sobrenome do contato")
                                                    {
                                                        var status = GVPFramework.getCamposContatoByModel(executaAcao[0]["IdConta"].ToString(), executaAcao[0]["IdModulo"].ToString(), drWkf["IdUser"].ToString(), "Sobrenome");

                                                        if (dvCondicoes[0]["IdCondicao"].ToString() == "==")
                                                        {
                                                            if (status.Trim().ToLower() != dvCondicoes[0]["Valor"].ToString().Trim().ToLower())
                                                                passaCondicao = false;
                                                        }
                                                        else if (dvCondicoes[0]["IdCondicao"].ToString() == "!=")
                                                        {
                                                            if (status.Trim().ToLower() == dvCondicoes[0]["Valor"].ToString().Trim().ToLower())
                                                                passaCondicao = false;
                                                        }
                                                        else if (dvCondicoes[0]["IdCondicao"].ToString() == "LIKE")
                                                        {
                                                            if (status.Trim().ToLower().IndexOf(dvCondicoes[0]["Valor"].ToString().Trim().ToLower()) < 0)
                                                                passaCondicao = false;
                                                        }
                                                    }
                                                    else if (dvCondicoes[0]["Campo"].ToString() == "Grupo de chat")
                                                    {
                                                        var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                            SELECT GrupoChat.Nome 
                                                            FROM Chat (NOLOCK)
                                                                INNER JOIN GrupoChat (NOLOCK) ON GrupoChat.Id = Chat.IdGrupoChat
                                                            WHERE Chat.Id = {drWkf["IdUser"].ToString()}
                                                        "));
                                                        var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";

                                                        if (dvCondicoes[0]["IdCondicao"].ToString() == "==")
                                                        {
                                                            if (status.Trim().ToLower() != dvCondicoes[0]["Valor"].ToString().Trim().ToLower())
                                                                passaCondicao = false;
                                                        }
                                                        else if (dvCondicoes[0]["IdCondicao"].ToString() == "!=")
                                                        {
                                                            if (status.Trim().ToLower() == dvCondicoes[0]["Valor"].ToString().Trim().ToLower())
                                                                passaCondicao = false;
                                                        }
                                                        else if (dvCondicoes[0]["IdCondicao"].ToString() == "LIKE")
                                                        {
                                                            if (status.Trim().ToLower().IndexOf(dvCondicoes[0]["Valor"].ToString().Trim().ToLower()) < 0)
                                                                passaCondicao = false;
                                                        }
                                                    }
                                                    else if (dvCondicoes[0]["Campo"].ToString() == "Grupo de WhatsApp")
                                                    {
                                                        var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                            SELECT GrupoWhatsApp.Nome + ' (' + Numero + ')'
                                                            FROM WhatsApp (NOLOCK)
                                                                INNER JOIN GrupoWhatsApp (NOLOCK) ON GrupoWhatsApp.Id = WhatsApp.IdGrupoWhatsApp
                                                            WHERE WhatsApp.Id = {drWkf["IdUser"].ToString()}
                                                        "));
                                                        var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";

                                                        if (dvCondicoes[0]["IdCondicao"].ToString() == "==")
                                                        {
                                                            if (status.Trim().ToLower() != dvCondicoes[0]["Valor"].ToString().Trim().ToLower())
                                                                passaCondicao = false;
                                                        }
                                                        else if (dvCondicoes[0]["IdCondicao"].ToString() == "!=")
                                                        {
                                                            if (status.Trim().ToLower() == dvCondicoes[0]["Valor"].ToString().Trim().ToLower())
                                                                passaCondicao = false;
                                                        }
                                                        else if (dvCondicoes[0]["IdCondicao"].ToString() == "LIKE")
                                                        {
                                                            if (status.Trim().ToLower().IndexOf(dvCondicoes[0]["Valor"].ToString().Trim().ToLower()) < 0)
                                                                passaCondicao = false;
                                                        }
                                                    }
                                                    else if (dvCondicoes[0]["Campo"].ToString() == "Caixa de entrada")
                                                    {
                                                        var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                            SELECT GrupoEmail.Nome
                                                            FROM Email (NOLOCK)
                                                                INNER JOIN GrupoEmail (NOLOCK) ON GrupoEmail.Id = Email.IdGrupoEmail
                                                            WHERE Email.Id = {drWkf["IdUser"].ToString()}
                                                        "));
                                                        var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";

                                                        if (dvCondicoes[0]["IdCondicao"].ToString() == "==")
                                                        {
                                                            if (status.Trim().ToLower() != dvCondicoes[0]["Valor"].ToString().Trim().ToLower())
                                                                passaCondicao = false;
                                                        }
                                                        else if (dvCondicoes[0]["IdCondicao"].ToString() == "!=")
                                                        {
                                                            if (status.Trim().ToLower() == dvCondicoes[0]["Valor"].ToString().Trim().ToLower())
                                                                passaCondicao = false;
                                                        }
                                                        else if (dvCondicoes[0]["IdCondicao"].ToString() == "LIKE")
                                                        {
                                                            if (status.Trim().ToLower().IndexOf(dvCondicoes[0]["Valor"].ToString().Trim().ToLower()) < 0)
                                                                passaCondicao = false;
                                                        }
                                                    }
                                                    else if (dvCondicoes[0]["Campo"].ToString() == "De")
                                                    {
                                                        var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                            SELECT Email.De
                                                            FROM Email (NOLOCK)
                                                            WHERE Email.Id = {drWkf["IdUser"].ToString()}
                                                        "));
                                                        var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";

                                                        if (dvCondicoes[0]["IdCondicao"].ToString() == "==")
                                                        {
                                                            if (status.Trim().ToLower() != dvCondicoes[0]["Valor"].ToString().Trim().ToLower())
                                                                passaCondicao = false;
                                                        }
                                                        else if (dvCondicoes[0]["IdCondicao"].ToString() == "!=")
                                                        {
                                                            if (status.Trim().ToLower() == dvCondicoes[0]["Valor"].ToString().Trim().ToLower())
                                                                passaCondicao = false;
                                                        }
                                                        else if (dvCondicoes[0]["IdCondicao"].ToString() == "LIKE")
                                                        {
                                                            if (status.Trim().ToLower().IndexOf(dvCondicoes[0]["Valor"].ToString().Trim().ToLower()) < 0)
                                                                passaCondicao = false;
                                                        }
                                                    }
                                                    else if (dvCondicoes[0]["Campo"].ToString() == "Para")
                                                    {
                                                        var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                            SELECT Email.Para
                                                            FROM Email (NOLOCK)
                                                            WHERE Email.Id = {drWkf["IdUser"].ToString()}
                                                        "));
                                                        var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";

                                                        if (dvCondicoes[0]["IdCondicao"].ToString() == "==")
                                                        {
                                                            if (status.Trim().ToLower() != dvCondicoes[0]["Valor"].ToString().Trim().ToLower())
                                                                passaCondicao = false;
                                                        }
                                                        else if (dvCondicoes[0]["IdCondicao"].ToString() == "!=")
                                                        {
                                                            if (status.Trim().ToLower() == dvCondicoes[0]["Valor"].ToString().Trim().ToLower())
                                                                passaCondicao = false;
                                                        }
                                                        else if (dvCondicoes[0]["IdCondicao"].ToString() == "LIKE")
                                                        {
                                                            if (status.Trim().ToLower().IndexOf(dvCondicoes[0]["Valor"].ToString().Trim().ToLower()) < 0)
                                                                passaCondicao = false;
                                                        }
                                                    }
                                                    else if (dvCondicoes[0]["Campo"].ToString() == "Cópia")
                                                    {
                                                        var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                            SELECT Email.Copia
                                                            FROM Email (NOLOCK)
                                                            WHERE Email.Id = {drWkf["IdUser"].ToString()}
                                                        "));
                                                        var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";

                                                        if (dvCondicoes[0]["IdCondicao"].ToString() == "==")
                                                        {
                                                            if (status.Trim().ToLower() != dvCondicoes[0]["Valor"].ToString().Trim().ToLower())
                                                                passaCondicao = false;
                                                        }
                                                        else if (dvCondicoes[0]["IdCondicao"].ToString() == "!=")
                                                        {
                                                            if (status.Trim().ToLower() == dvCondicoes[0]["Valor"].ToString().Trim().ToLower())
                                                                passaCondicao = false;
                                                        }
                                                        else if (dvCondicoes[0]["IdCondicao"].ToString() == "LIKE")
                                                        {
                                                            if (status.Trim().ToLower().IndexOf(dvCondicoes[0]["Valor"].ToString().Trim().ToLower()) < 0)
                                                                passaCondicao = false;
                                                        }
                                                    }
                                                    else if (dvCondicoes[0]["Campo"].ToString() == "Cópia oculta")
                                                    {
                                                        var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                            SELECT Email.CopiaOculta
                                                            FROM Email (NOLOCK)
                                                            WHERE Email.Id = {drWkf["IdUser"].ToString()}
                                                        "));
                                                        var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";

                                                        if (dvCondicoes[0]["IdCondicao"].ToString() == "==")
                                                        {
                                                            if (status.Trim().ToLower() != dvCondicoes[0]["Valor"].ToString().Trim().ToLower())
                                                                passaCondicao = false;
                                                        }
                                                        else if (dvCondicoes[0]["IdCondicao"].ToString() == "!=")
                                                        {
                                                            if (status.Trim().ToLower() == dvCondicoes[0]["Valor"].ToString().Trim().ToLower())
                                                                passaCondicao = false;
                                                        }
                                                        else if (dvCondicoes[0]["IdCondicao"].ToString() == "LIKE")
                                                        {
                                                            if (status.Trim().ToLower().IndexOf(dvCondicoes[0]["Valor"].ToString().Trim().ToLower()) < 0)
                                                                passaCondicao = false;
                                                        }
                                                    }
                                                    else if (dvCondicoes[0]["Campo"].ToString() == "Texto")
                                                    {
                                                        var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                            SELECT Email.Texto
                                                            FROM Email (NOLOCK)
                                                            WHERE Email.Id = {drWkf["IdUser"].ToString()}
                                                        "));
                                                        var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";

                                                        if (dvCondicoes[0]["IdCondicao"].ToString() == "==")
                                                        {
                                                            if (status.Trim().ToLower() != dvCondicoes[0]["Valor"].ToString().Trim().ToLower())
                                                                passaCondicao = false;
                                                        }
                                                        else if (dvCondicoes[0]["IdCondicao"].ToString() == "!=")
                                                        {
                                                            if (status.Trim().ToLower() == dvCondicoes[0]["Valor"].ToString().Trim().ToLower())
                                                                passaCondicao = false;
                                                        }
                                                        else if (dvCondicoes[0]["IdCondicao"].ToString() == "LIKE")
                                                        {
                                                            if (status.Trim().ToLower().IndexOf(dvCondicoes[0]["Valor"].ToString().Trim().ToLower()) < 0)
                                                                passaCondicao = false;
                                                        }
                                                    }
                                                    else if (dvCondicoes[0]["Campo"].ToString() == "Departamento do proprietário")
                                                    {
                                                        var status = GVPFramework.getDepartamentoProprietarioByModel(executaAcao[0]["IdModulo"].ToString(), drWkf["IdUser"].ToString());

                                                        if (dvCondicoes[0]["IdCondicao"].ToString() == "==")
                                                        {
                                                            if (status.Trim().ToLower() != dvCondicoes[0]["Valor"].ToString().Trim().ToLower())
                                                                passaCondicao = false;
                                                        }
                                                        else if (dvCondicoes[0]["IdCondicao"].ToString() == "!=")
                                                        {
                                                            if (status.Trim().ToLower() == dvCondicoes[0]["Valor"].ToString().Trim().ToLower())
                                                                passaCondicao = false;
                                                        }
                                                        else if (dvCondicoes[0]["IdCondicao"].ToString() == "LIKE")
                                                        {
                                                            if (status.Trim().ToLower().IndexOf(dvCondicoes[0]["Valor"].ToString().Trim().ToLower()) < 0)
                                                                passaCondicao = false;
                                                        }
                                                    }
                                                    else if (dvCondicoes[0]["Campo"].ToString() == "Departamento de quem cadastrou")
                                                    {
                                                        var status = GVPFramework.getDepartamentoUsuarioCadastroByModel(executaAcao[0]["IdModulo"].ToString(), drWkf["IdUser"].ToString());

                                                        if (dvCondicoes[0]["IdCondicao"].ToString() == "==")
                                                        {
                                                            if (status.Trim().ToLower() != dvCondicoes[0]["Valor"].ToString().Trim().ToLower())
                                                                passaCondicao = false;
                                                        }
                                                        else if (dvCondicoes[0]["IdCondicao"].ToString() == "!=")
                                                        {
                                                            if (status.Trim().ToLower() == dvCondicoes[0]["Valor"].ToString().Trim().ToLower())
                                                                passaCondicao = false;
                                                        }
                                                        else if (dvCondicoes[0]["IdCondicao"].ToString() == "LIKE")
                                                        {
                                                            if (status.Trim().ToLower().IndexOf(dvCondicoes[0]["Valor"].ToString().Trim().ToLower()) < 0)
                                                                passaCondicao = false;
                                                        }
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                if (executaAcao[0]["Acao"].ToString() == "or")
                                                {
                                                    foreach (DataRowView cond in dvCondicoes)
                                                    {
                                                        if (!passaCondicao)
                                                        {
                                                            if (cond["Campo"].ToString() == "Status")
                                                            {
                                                                var status = GVPFramework.getStatusByModel(executaAcao[0]["IdModulo"].ToString(), drWkf["IdUser"].ToString());

                                                                if (cond["IdCondicao"].ToString() == "==")
                                                                {
                                                                    if (status.Trim().ToLower() == cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = true;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "!=")
                                                                {
                                                                    if (status.Trim().ToLower() != cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = true;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "LIKE")
                                                                {
                                                                    if (status.Trim().ToLower().IndexOf(cond["Valor"].ToString().Trim().ToLower()) >= 0)
                                                                        passaCondicao = true;
                                                                }
                                                            }
                                                            else if (cond["Campo"].ToString() == "Fila")
                                                            {
                                                                var status = GVPFramework.getFilaByModel(executaAcao[0]["IdModulo"].ToString(), drWkf["IdUser"].ToString());

                                                                if (cond["IdCondicao"].ToString() == "==")
                                                                {
                                                                    if (status.Trim().ToLower() == cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = true;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "!=")
                                                                {
                                                                    if (status.Trim().ToLower() != cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = true;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "LIKE")
                                                                {
                                                                    if (status.Trim().ToLower().IndexOf(cond["Valor"].ToString().Trim().ToLower()) >= 0)
                                                                        passaCondicao = true;
                                                                }
                                                            }
                                                            else if (cond["Campo"].ToString() == "Empresa")
                                                            {
                                                                var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                                    SELECT Empresa.Nome 
                                                                    FROM vwEmpresa({executaAcao[0]["IdConta"].ToString()}) Empresa
                                                                    WHERE Id = (SELECT IdEmpresa FROM Contato WHERE Id = {drWkf["IdUser"].ToString()})
                                                                "));
                                                                var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";

                                                                if (cond["IdCondicao"].ToString() == "==")
                                                                {
                                                                    if (status.Trim().ToLower() == cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = true;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "!=")
                                                                {
                                                                    if (status.Trim().ToLower() != cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = true;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "LIKE")
                                                                {
                                                                    if (status.Trim().ToLower().IndexOf(cond["Valor"].ToString().Trim().ToLower()) >= 0)
                                                                        passaCondicao = true;
                                                                }
                                                            }
                                                            else if (cond["Campo"].ToString() == "Grupo empresarial")
                                                            {
                                                                var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                                    SELECT Empresa.Nome 
                                                                    FROM vwEmpresa({executaAcao[0]["IdConta"].ToString()}) Empresa
                                                                    WHERE Id = (SELECT IdEmpresa FROM Empresa WHERE Id = {drWkf["IdUser"].ToString()})
                                                                "));
                                                                var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";

                                                                if (cond["IdCondicao"].ToString() == "==")
                                                                {
                                                                    if (status.Trim().ToLower() == cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = true;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "!=")
                                                                {
                                                                    if (status.Trim().ToLower() != cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = true;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "LIKE")
                                                                {
                                                                    if (status.Trim().ToLower().IndexOf(cond["Valor"].ToString().Trim().ToLower()) >= 0)
                                                                        passaCondicao = true;
                                                                }
                                                            }
                                                            else if (cond["Campo"].ToString() == "Grupo")
                                                            {
                                                                var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                                    SELECT Nome 
                                                                    FROM PropriedadeGrupo
                                                                    WHERE Id = (SELECT IdGrupo FROM Atributo WHERE Id = {drWkf["IdUser"].ToString()})
                                                                "));
                                                                var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";

                                                                if (cond["IdCondicao"].ToString() == "==")
                                                                {
                                                                    if (status.Trim().ToLower() == cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = true;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "!=")
                                                                {
                                                                    if (status.Trim().ToLower() != cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = true;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "LIKE")
                                                                {
                                                                    if (status.Trim().ToLower().IndexOf(cond["Valor"].ToString().Trim().ToLower()) >= 0)
                                                                        passaCondicao = true;
                                                                }
                                                            }
                                                            else if (cond["Campo"].ToString() == "Canal de origem")
                                                            {
                                                                var status = GVPFramework.getCanalByModel(executaAcao[0]["IdModulo"].ToString(), drWkf["IdUser"].ToString());

                                                                if (cond["IdCondicao"].ToString() == "==")
                                                                {
                                                                    if (status.Trim().ToLower() == cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = true;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "!=")
                                                                {
                                                                    if (status.Trim().ToLower() != cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = true;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "LIKE")
                                                                {
                                                                    if (status.Trim().ToLower().IndexOf(cond["Valor"].ToString().Trim().ToLower()) >= 0)
                                                                        passaCondicao = true;
                                                                }
                                                            }
                                                            else if (cond["Campo"].ToString() == "Etapa")
                                                            {
                                                                var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                                    SELECT Oportunidade.Nome 
                                                                    FROM Oportunidade (NOLOCK)
                                                                        INNER JOIN OportunidadeStatus (NOLOCK) ON OportunidadeStatus.Id = Oportunidade.IdOportunidadeStatus
                                                                    WHERE Oportunidade.Id = {drWkf["IdUser"].ToString()}
                                                                "));
                                                                var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";

                                                                if (cond["IdCondicao"].ToString() == "==")
                                                                {
                                                                    if (status.Trim().ToLower() == cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = true;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "!=")
                                                                {
                                                                    if (status.Trim().ToLower() != cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = true;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "LIKE")
                                                                {
                                                                    if (status.Trim().ToLower().IndexOf(cond["Valor"].ToString().Trim().ToLower()) >= 0)
                                                                        passaCondicao = true;
                                                                }
                                                            }
                                                            else if (cond["Campo"].ToString() == "Empresa do contato")
                                                            {
                                                                var status = GVPFramework.getEmpresaDoContatoByModel(executaAcao[0]["IdConta"].ToString(), executaAcao[0]["IdModulo"].ToString(), drWkf["IdUser"].ToString());

                                                                if (cond["IdCondicao"].ToString() == "==")
                                                                {
                                                                    if (status.Trim().ToLower() == cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = true;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "!=")
                                                                {
                                                                    if (status.Trim().ToLower() != cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = true;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "LIKE")
                                                                {
                                                                    if (status.Trim().ToLower().IndexOf(cond["Valor"].ToString().Trim().ToLower()) >= 0)
                                                                        passaCondicao = true;
                                                                }
                                                            }
                                                            else if (cond["Campo"].ToString() == "Nome do contato")
                                                            {
                                                                var status = GVPFramework.getContatoByModel(executaAcao[0]["IdConta"].ToString(), executaAcao[0]["IdModulo"].ToString(), drWkf["IdUser"].ToString());

                                                                if (cond["IdCondicao"].ToString() == "==")
                                                                {
                                                                    if (status.Trim().ToLower() == cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = true;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "!=")
                                                                {
                                                                    if (status.Trim().ToLower() != cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = true;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "LIKE")
                                                                {
                                                                    if (status.Trim().ToLower().IndexOf(cond["Valor"].ToString().Trim().ToLower()) >= 0)
                                                                        passaCondicao = true;
                                                                }
                                                            }
                                                            else if (cond["Campo"].ToString() == "Cidade do contato")
                                                            {
                                                                var status = GVPFramework.getCamposContatoByModel(executaAcao[0]["IdConta"].ToString(), executaAcao[0]["IdModulo"].ToString(), drWkf["IdUser"].ToString(), "Cidade");

                                                                if (cond["IdCondicao"].ToString() == "==")
                                                                {
                                                                    if (status.Trim().ToLower() == cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = true;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "!=")
                                                                {
                                                                    if (status.Trim().ToLower() != cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = true;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "LIKE")
                                                                {
                                                                    if (status.Trim().ToLower().IndexOf(cond["Valor"].ToString().Trim().ToLower()) >= 0)
                                                                        passaCondicao = true;
                                                                }
                                                            }
                                                            else if (cond["Campo"].ToString() == "Estado do contato")
                                                            {
                                                                var status = GVPFramework.getCamposContatoByModel(executaAcao[0]["IdConta"].ToString(), executaAcao[0]["IdModulo"].ToString(), drWkf["IdUser"].ToString(), "Estado");

                                                                if (cond["IdCondicao"].ToString() == "==")
                                                                {
                                                                    if (status.Trim().ToLower() == cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = true;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "!=")
                                                                {
                                                                    if (status.Trim().ToLower() != cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = true;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "LIKE")
                                                                {
                                                                    if (status.Trim().ToLower().IndexOf(cond["Valor"].ToString().Trim().ToLower()) >= 0)
                                                                        passaCondicao = true;
                                                                }
                                                            }
                                                            else if (cond["Campo"].ToString() == "Sobrenome do contato")
                                                            {
                                                                var status = GVPFramework.getCamposContatoByModel(executaAcao[0]["IdConta"].ToString(), executaAcao[0]["IdModulo"].ToString(), drWkf["IdUser"].ToString(), "Sobrenome");

                                                                if (cond["IdCondicao"].ToString() == "==")
                                                                {
                                                                    if (status.Trim().ToLower() == cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = true;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "!=")
                                                                {
                                                                    if (status.Trim().ToLower() != cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = true;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "LIKE")
                                                                {
                                                                    if (status.Trim().ToLower().IndexOf(cond["Valor"].ToString().Trim().ToLower()) >= 0)
                                                                        passaCondicao = true;
                                                                }
                                                            }
                                                            else if (cond["Campo"].ToString() == "Grupo de chat")
                                                            {
                                                                var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                                    SELECT GrupoChat.Nome 
                                                                    FROM Chat (NOLOCK)
                                                                        INNER JOIN GrupoChat (NOLOCK) ON GrupoChat.Id = Chat.IdGrupoChat
                                                                    WHERE Chat.Id = {drWkf["IdUser"].ToString()}
                                                                "));
                                                                var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";

                                                                if (cond["IdCondicao"].ToString() == "==")
                                                                {
                                                                    if (status.Trim().ToLower() == cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = true;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "!=")
                                                                {
                                                                    if (status.Trim().ToLower() != cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = true;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "LIKE")
                                                                {
                                                                    if (status.Trim().ToLower().IndexOf(cond["Valor"].ToString().Trim().ToLower()) >= 0)
                                                                        passaCondicao = true;
                                                                }
                                                            }
                                                            else if (cond["Campo"].ToString() == "Grupo de WhatsApp")
                                                            {
                                                                var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                                    SELECT GrupoWhatsApp.Nome + ' (' + Numero + ')'
                                                                    FROM WhatsApp (NOLOCK)
                                                                        INNER JOIN GrupoWhatsApp (NOLOCK) ON GrupoWhatsApp.Id = WhatsApp.IdGrupoWhatsApp
                                                                    WHERE WhatsApp.Id = {drWkf["IdUser"].ToString()}
                                                                "));
                                                                var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";

                                                                if (cond["IdCondicao"].ToString() == "==")
                                                                {
                                                                    if (status.Trim().ToLower() == cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = true;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "!=")
                                                                {
                                                                    if (status.Trim().ToLower() != cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = true;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "LIKE")
                                                                {
                                                                    if (status.Trim().ToLower().IndexOf(cond["Valor"].ToString().Trim().ToLower()) >= 0)
                                                                        passaCondicao = true;
                                                                }
                                                            }
                                                            else if (cond["Campo"].ToString() == "Caixa de entrada")
                                                            {
                                                                var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                                    SELECT GrupoEmail.Nome
                                                                    FROM Email (NOLOCK)
                                                                        INNER JOIN GrupoEmail (NOLOCK) ON GrupoEmail.Id = Email.IdGrupoEmail
                                                                    WHERE Email.Id = {drWkf["IdUser"].ToString()}
                                                                "));
                                                                var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";

                                                                if (cond["IdCondicao"].ToString() == "==")
                                                                {
                                                                    if (status.Trim().ToLower() == cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = true;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "!=")
                                                                {
                                                                    if (status.Trim().ToLower() != cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = true;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "LIKE")
                                                                {
                                                                    if (status.Trim().ToLower().IndexOf(cond["Valor"].ToString().Trim().ToLower()) >= 0)
                                                                        passaCondicao = true;
                                                                }
                                                            }
                                                            else if (cond["Campo"].ToString() == "De")
                                                            {
                                                                var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                                    SELECT Email.De
                                                                    FROM Email (NOLOCK)
                                                                    WHERE Email.Id = {drWkf["IdUser"].ToString()}
                                                                "));
                                                                var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";

                                                                if (cond["IdCondicao"].ToString() == "==")
                                                                {
                                                                    if (status.Trim().ToLower() == cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = true;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "!=")
                                                                {
                                                                    if (status.Trim().ToLower() != cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = true;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "LIKE")
                                                                {
                                                                    if (status.Trim().ToLower().IndexOf(cond["Valor"].ToString().Trim().ToLower()) >= 0)
                                                                        passaCondicao = true;
                                                                }
                                                            }
                                                            else if (cond["Campo"].ToString() == "Para")
                                                            {
                                                                var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                                    SELECT Email.Para
                                                                    FROM Email (NOLOCK)
                                                                    WHERE Email.Id = {drWkf["IdUser"].ToString()}
                                                                "));
                                                                var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";

                                                                if (cond["IdCondicao"].ToString() == "==")
                                                                {
                                                                    if (status.Trim().ToLower() == cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = true;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "!=")
                                                                {
                                                                    if (status.Trim().ToLower() != cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = true;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "LIKE")
                                                                {
                                                                    if (status.Trim().ToLower().IndexOf(cond["Valor"].ToString().Trim().ToLower()) >= 0)
                                                                        passaCondicao = true;
                                                                }
                                                            }
                                                            else if (cond["Campo"].ToString() == "Cópia")
                                                            {
                                                                var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                                    SELECT Email.Copia
                                                                    FROM Email (NOLOCK)
                                                                    WHERE Email.Id = {drWkf["IdUser"].ToString()}
                                                                "));
                                                                var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";

                                                                if (cond["IdCondicao"].ToString() == "==")
                                                                {
                                                                    if (status.Trim().ToLower() == cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = true;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "!=")
                                                                {
                                                                    if (status.Trim().ToLower() != cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = true;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "LIKE")
                                                                {
                                                                    if (status.Trim().ToLower().IndexOf(cond["Valor"].ToString().Trim().ToLower()) >= 0)
                                                                        passaCondicao = true;
                                                                }
                                                            }
                                                            else if (cond["Campo"].ToString() == "Cópia oculta")
                                                            {
                                                                var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                                    SELECT Email.CopiaOculta
                                                                    FROM Email (NOLOCK)
                                                                    WHERE Email.Id = {drWkf["IdUser"].ToString()}
                                                                "));
                                                                var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";

                                                                if (cond["IdCondicao"].ToString() == "==")
                                                                {
                                                                    if (status.Trim().ToLower() == cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = true;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "!=")
                                                                {
                                                                    if (status.Trim().ToLower() != cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = true;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "LIKE")
                                                                {
                                                                    if (status.Trim().ToLower().IndexOf(cond["Valor"].ToString().Trim().ToLower()) >= 0)
                                                                        passaCondicao = true;
                                                                }
                                                            }
                                                            else if (cond["Campo"].ToString() == "Texto")
                                                            {
                                                                var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                                    SELECT Email.Texto
                                                                    FROM Email (NOLOCK)
                                                                    WHERE Email.Id = {drWkf["IdUser"].ToString()}
                                                                "));
                                                                var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";

                                                                if (cond["IdCondicao"].ToString() == "==")
                                                                {
                                                                    if (status.Trim().ToLower() == cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = true;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "!=")
                                                                {
                                                                    if (status.Trim().ToLower() != cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = true;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "LIKE")
                                                                {
                                                                    if (status.Trim().ToLower().IndexOf(cond["Valor"].ToString().Trim().ToLower()) >= 0)
                                                                        passaCondicao = true;
                                                                }
                                                            }
                                                            else if (cond["Campo"].ToString() == "Departamento do proprietário")
                                                            {
                                                                var status = GVPFramework.getDepartamentoProprietarioByModel(executaAcao[0]["IdModulo"].ToString(), drWkf["IdUser"].ToString());

                                                                if (cond["IdCondicao"].ToString() == "==")
                                                                {
                                                                    if (status.Trim().ToLower() == cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = true;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "!=")
                                                                {
                                                                    if (status.Trim().ToLower() != cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = true;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "LIKE")
                                                                {
                                                                    if (status.Trim().ToLower().IndexOf(cond["Valor"].ToString().Trim().ToLower()) >= 0)
                                                                        passaCondicao = true;
                                                                }
                                                            }
                                                            else if (cond["Campo"].ToString() == "Departamento de quem cadastrou")
                                                            {
                                                                var status = GVPFramework.getDepartamentoUsuarioCadastroByModel(executaAcao[0]["IdModulo"].ToString(), drWkf["IdUser"].ToString());

                                                                if (cond["IdCondicao"].ToString() == "==")
                                                                {
                                                                    if (status.Trim().ToLower() == cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = true;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "!=")
                                                                {
                                                                    if (status.Trim().ToLower() != cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = true;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "LIKE")
                                                                {
                                                                    if (status.Trim().ToLower().IndexOf(cond["Valor"].ToString().Trim().ToLower()) >= 0)
                                                                        passaCondicao = true;
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                                else
                                                {
                                                    foreach (DataRowView cond in dvCondicoes)
                                                    {
                                                        if (passaCondicao)
                                                        {
                                                            if (cond["Campo"].ToString() == "Status")
                                                            {
                                                                var status = GVPFramework.getStatusByModel(executaAcao[0]["IdModulo"].ToString(), drWkf["IdUser"].ToString());

                                                                if (cond["IdCondicao"].ToString() == "==")
                                                                {
                                                                    if (status.Trim().ToLower() != cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = false;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "!=")
                                                                {
                                                                    if (status.Trim().ToLower() == cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = false;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "LIKE")
                                                                {
                                                                    if (status.Trim().ToLower().IndexOf(cond["Valor"].ToString().Trim().ToLower()) < 0)
                                                                        passaCondicao = false;
                                                                }
                                                            }
                                                            else if (cond["Campo"].ToString() == "Fila")
                                                            {
                                                                var status = GVPFramework.getFilaByModel(executaAcao[0]["IdModulo"].ToString(), drWkf["IdUser"].ToString());

                                                                if (cond["IdCondicao"].ToString() == "==")
                                                                {
                                                                    if (status.Trim().ToLower() != cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = false;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "!=")
                                                                {
                                                                    if (status.Trim().ToLower() == cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = false;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "LIKE")
                                                                {
                                                                    if (status.Trim().ToLower().IndexOf(cond["Valor"].ToString().Trim().ToLower()) < 0)
                                                                        passaCondicao = false;
                                                                }
                                                            }
                                                            else if (cond["Campo"].ToString() == "Empresa")
                                                            {
                                                                var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                                    SELECT Empresa.Nome 
                                                                    FROM vwEmpresa({executaAcao[0]["IdConta"].ToString()}) Empresa
                                                                    WHERE Id = (SELECT IdEmpresa FROM Contato WHERE Id = {drWkf["IdUser"].ToString()})
                                                                "));
                                                                var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";

                                                                if (cond["IdCondicao"].ToString() == "==")
                                                                {
                                                                    if (status.Trim().ToLower() != cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = false;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "!=")
                                                                {
                                                                    if (status.Trim().ToLower() == cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = false;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "LIKE")
                                                                {
                                                                    if (status.Trim().ToLower().IndexOf(cond["Valor"].ToString().Trim().ToLower()) < 0)
                                                                        passaCondicao = false;
                                                                }
                                                            }
                                                            else if (cond["Campo"].ToString() == "Grupo empresarial")
                                                            {
                                                                var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                                    SELECT Empresa.Nome 
                                                                    FROM vwEmpresa({executaAcao[0]["IdConta"].ToString()}) Empresa
                                                                    WHERE Id = (SELECT IdEmpresa FROM Empresa WHERE Id = {drWkf["IdUser"].ToString()})
                                                                "));
                                                                var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";

                                                                if (cond["IdCondicao"].ToString() == "==")
                                                                {
                                                                    if (status.Trim().ToLower() != cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = false;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "!=")
                                                                {
                                                                    if (status.Trim().ToLower() == cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = false;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "LIKE")
                                                                {
                                                                    if (status.Trim().ToLower().IndexOf(cond["Valor"].ToString().Trim().ToLower()) < 0)
                                                                        passaCondicao = false;
                                                                }
                                                            }
                                                            else if (cond["Campo"].ToString() == "Grupo")
                                                            {
                                                                var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                                    SELECT Nome 
                                                                    FROM PropriedadeGrupo
                                                                    WHERE Id = (SELECT IdGrupo FROM Atributo WHERE Id = {drWkf["IdUser"].ToString()})
                                                                "));
                                                                var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";

                                                                if (cond["IdCondicao"].ToString() == "==")
                                                                {
                                                                    if (status.Trim().ToLower() != cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = false;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "!=")
                                                                {
                                                                    if (status.Trim().ToLower() == cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = false;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "LIKE")
                                                                {
                                                                    if (status.Trim().ToLower().IndexOf(cond["Valor"].ToString().Trim().ToLower()) < 0)
                                                                        passaCondicao = false;
                                                                }
                                                            }
                                                            else if (cond["Campo"].ToString() == "Canal de origem")
                                                            {
                                                                var status = GVPFramework.getCanalByModel(executaAcao[0]["IdModulo"].ToString(), drWkf["IdUser"].ToString());

                                                                if (cond["IdCondicao"].ToString() == "==")
                                                                {
                                                                    if (status.Trim().ToLower() != cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = false;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "!=")
                                                                {
                                                                    if (status.Trim().ToLower() == cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = false;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "LIKE")
                                                                {
                                                                    if (status.Trim().ToLower().IndexOf(cond["Valor"].ToString().Trim().ToLower()) < 0)
                                                                        passaCondicao = false;
                                                                }
                                                            }
                                                            else if (cond["Campo"].ToString() == "Etapa")
                                                            {
                                                                var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                                    SELECT Oportunidade.Nome 
                                                                    FROM Oportunidade (NOLOCK)
                                                                        INNER JOIN OportunidadeStatus (NOLOCK) ON OportunidadeStatus.Id = Oportunidade.IdOportunidadeStatus
                                                                    WHERE Oportunidade.Id = {drWkf["IdUser"].ToString()}
                                                                "));
                                                                var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";

                                                                if (cond["IdCondicao"].ToString() == "==")
                                                                {
                                                                    if (status.Trim().ToLower() != cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = false;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "!=")
                                                                {
                                                                    if (status.Trim().ToLower() == cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = false;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "LIKE")
                                                                {
                                                                    if (status.Trim().ToLower().IndexOf(cond["Valor"].ToString().Trim().ToLower()) < 0)
                                                                        passaCondicao = false;
                                                                }
                                                            }
                                                            else if (cond["Campo"].ToString() == "Empresa do contato")
                                                            {
                                                                var status = GVPFramework.getEmpresaDoContatoByModel(executaAcao[0]["IdConta"].ToString(), executaAcao[0]["IdModulo"].ToString(), drWkf["IdUser"].ToString());

                                                                if (cond["IdCondicao"].ToString() == "==")
                                                                {
                                                                    if (status.Trim().ToLower() != cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = false;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "!=")
                                                                {
                                                                    if (status.Trim().ToLower() == cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = false;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "LIKE")
                                                                {
                                                                    if (status.Trim().ToLower().IndexOf(cond["Valor"].ToString().Trim().ToLower()) < 0)
                                                                        passaCondicao = false;
                                                                }
                                                            }
                                                            else if (cond["Campo"].ToString() == "Nome do contato")
                                                            {
                                                                var status = GVPFramework.getContatoByModel(executaAcao[0]["IdConta"].ToString(), executaAcao[0]["IdModulo"].ToString(), drWkf["IdUser"].ToString());

                                                                if (cond["IdCondicao"].ToString() == "==")
                                                                {
                                                                    if (status.Trim().ToLower() != cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = false;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "!=")
                                                                {
                                                                    if (status.Trim().ToLower() == cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = false;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "LIKE")
                                                                {
                                                                    if (status.Trim().ToLower().IndexOf(cond["Valor"].ToString().Trim().ToLower()) < 0)
                                                                        passaCondicao = false;
                                                                }
                                                            }
                                                            else if (cond["Campo"].ToString() == "Cidade do contato")
                                                            {
                                                                var status = GVPFramework.getCamposContatoByModel(executaAcao[0]["IdConta"].ToString(), executaAcao[0]["IdModulo"].ToString(), drWkf["IdUser"].ToString(), "Cidade");

                                                                if (cond["IdCondicao"].ToString() == "==")
                                                                {
                                                                    if (status.Trim().ToLower() != cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = false;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "!=")
                                                                {
                                                                    if (status.Trim().ToLower() == cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = false;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "LIKE")
                                                                {
                                                                    if (status.Trim().ToLower().IndexOf(cond["Valor"].ToString().Trim().ToLower()) < 0)
                                                                        passaCondicao = false;
                                                                }
                                                            }
                                                            else if (cond["Campo"].ToString() == "Estado do contato")
                                                            {
                                                                var status = GVPFramework.getCamposContatoByModel(executaAcao[0]["IdConta"].ToString(), executaAcao[0]["IdModulo"].ToString(), drWkf["IdUser"].ToString(), "Estado");

                                                                if (cond["IdCondicao"].ToString() == "==")
                                                                {
                                                                    if (status.Trim().ToLower() != cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = false;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "!=")
                                                                {
                                                                    if (status.Trim().ToLower() == cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = false;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "LIKE")
                                                                {
                                                                    if (status.Trim().ToLower().IndexOf(cond["Valor"].ToString().Trim().ToLower()) < 0)
                                                                        passaCondicao = false;
                                                                }
                                                            }
                                                            else if (cond["Campo"].ToString() == "Sobrenome do contato")
                                                            {
                                                                var status = GVPFramework.getCamposContatoByModel(executaAcao[0]["IdConta"].ToString(), executaAcao[0]["IdModulo"].ToString(), drWkf["IdUser"].ToString(), "Sobrenome");

                                                                if (cond["IdCondicao"].ToString() == "==")
                                                                {
                                                                    if (status.Trim().ToLower() != cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = false;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "!=")
                                                                {
                                                                    if (status.Trim().ToLower() == cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = false;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "LIKE")
                                                                {
                                                                    if (status.Trim().ToLower().IndexOf(cond["Valor"].ToString().Trim().ToLower()) < 0)
                                                                        passaCondicao = false;
                                                                }
                                                            }
                                                            else if (cond["Campo"].ToString() == "Grupo de chat")
                                                            {
                                                                var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                                    SELECT GrupoChat.Nome 
                                                                    FROM Chat (NOLOCK)
                                                                        INNER JOIN GrupoChat (NOLOCK) ON GrupoChat.Id = Chat.IdGrupoChat
                                                                    WHERE Chat.Id = {drWkf["IdUser"].ToString()}
                                                                "));
                                                                var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";

                                                                if (cond["IdCondicao"].ToString() == "==")
                                                                {
                                                                    if (status.Trim().ToLower() != cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = false;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "!=")
                                                                {
                                                                    if (status.Trim().ToLower() == cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = false;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "LIKE")
                                                                {
                                                                    if (status.Trim().ToLower().IndexOf(cond["Valor"].ToString().Trim().ToLower()) < 0)
                                                                        passaCondicao = false;
                                                                }
                                                            }
                                                            else if (cond["Campo"].ToString() == "Grupo de WhatsApp")
                                                            {
                                                                var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                                    SELECT GrupoWhatsApp.Nome + ' (' + Numero + ')'
                                                                    FROM WhatsApp (NOLOCK)
                                                                        INNER JOIN GrupoWhatsApp (NOLOCK) ON GrupoWhatsApp.Id = WhatsApp.IdGrupoWhatsApp
                                                                    WHERE WhatsApp.Id = {drWkf["IdUser"].ToString()}
                                                                "));
                                                                var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";

                                                                if (cond["IdCondicao"].ToString() == "==")
                                                                {
                                                                    if (status.Trim().ToLower() != cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = false;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "!=")
                                                                {
                                                                    if (status.Trim().ToLower() == cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = false;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "LIKE")
                                                                {
                                                                    if (status.Trim().ToLower().IndexOf(cond["Valor"].ToString().Trim().ToLower()) < 0)
                                                                        passaCondicao = false;
                                                                }
                                                            }
                                                            else if (cond["Campo"].ToString() == "Caixa de entrada")
                                                            {
                                                                var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                                    SELECT GrupoEmail.Nome
                                                                    FROM Email (NOLOCK)
                                                                        INNER JOIN GrupoEmail (NOLOCK) ON GrupoEmail.Id = Email.IdGrupoEmail
                                                                    WHERE Email.Id = {drWkf["IdUser"].ToString()}
                                                                "));
                                                                var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";

                                                                if (cond["IdCondicao"].ToString() == "==")
                                                                {
                                                                    if (status.Trim().ToLower() != cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = false;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "!=")
                                                                {
                                                                    if (status.Trim().ToLower() == cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = false;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "LIKE")
                                                                {
                                                                    if (status.Trim().ToLower().IndexOf(cond["Valor"].ToString().Trim().ToLower()) < 0)
                                                                        passaCondicao = false;
                                                                }
                                                            }
                                                            else if (cond["Campo"].ToString() == "De")
                                                            {
                                                                var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                                    SELECT Email.De
                                                                    FROM Email (NOLOCK)
                                                                    WHERE Email.Id = {drWkf["IdUser"].ToString()}
                                                                "));
                                                                var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";

                                                                if (cond["IdCondicao"].ToString() == "==")
                                                                {
                                                                    if (status.Trim().ToLower() != cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = false;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "!=")
                                                                {
                                                                    if (status.Trim().ToLower() == cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = false;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "LIKE")
                                                                {
                                                                    if (status.Trim().ToLower().IndexOf(cond["Valor"].ToString().Trim().ToLower()) < 0)
                                                                        passaCondicao = false;
                                                                }
                                                            }
                                                            else if (cond["Campo"].ToString() == "Para")
                                                            {
                                                                var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                                    SELECT Email.Para
                                                                    FROM Email (NOLOCK)
                                                                    WHERE Email.Id = {drWkf["IdUser"].ToString()}
                                                                "));
                                                                var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";

                                                                if (cond["IdCondicao"].ToString() == "==")
                                                                {
                                                                    if (status.Trim().ToLower() != cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = false;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "!=")
                                                                {
                                                                    if (status.Trim().ToLower() == cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = false;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "LIKE")
                                                                {
                                                                    if (status.Trim().ToLower().IndexOf(cond["Valor"].ToString().Trim().ToLower()) < 0)
                                                                        passaCondicao = false;
                                                                }
                                                            }
                                                            else if (cond["Campo"].ToString() == "Cópia")
                                                            {
                                                                var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                                    SELECT Email.Copia
                                                                    FROM Email (NOLOCK)
                                                                    WHERE Email.Id = {drWkf["IdUser"].ToString()}
                                                                "));
                                                                var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";

                                                                if (cond["IdCondicao"].ToString() == "==")
                                                                {
                                                                    if (status.Trim().ToLower() != cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = false;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "!=")
                                                                {
                                                                    if (status.Trim().ToLower() == cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = false;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "LIKE")
                                                                {
                                                                    if (status.Trim().ToLower().IndexOf(cond["Valor"].ToString().Trim().ToLower()) < 0)
                                                                        passaCondicao = false;
                                                                }
                                                            }
                                                            else if (cond["Campo"].ToString() == "Cópia oculta")
                                                            {
                                                                var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                                    SELECT Email.CopiaOculta
                                                                    FROM Email (NOLOCK)
                                                                    WHERE Email.Id = {drWkf["IdUser"].ToString()}
                                                                "));
                                                                var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";

                                                                if (cond["IdCondicao"].ToString() == "==")
                                                                {
                                                                    if (status.Trim().ToLower() != cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = false;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "!=")
                                                                {
                                                                    if (status.Trim().ToLower() == cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = false;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "LIKE")
                                                                {
                                                                    if (status.Trim().ToLower().IndexOf(cond["Valor"].ToString().Trim().ToLower()) < 0)
                                                                        passaCondicao = false;
                                                                }
                                                            }
                                                            else if (cond["Campo"].ToString() == "Texto")
                                                            {
                                                                var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                                    SELECT Email.Texto
                                                                    FROM Email (NOLOCK)
                                                                    WHERE Email.Id = {drWkf["IdUser"].ToString()}
                                                                "));
                                                                var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";

                                                                if (cond["IdCondicao"].ToString() == "==")
                                                                {
                                                                    if (status.Trim().ToLower() != cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = false;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "!=")
                                                                {
                                                                    if (status.Trim().ToLower() == cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = false;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "LIKE")
                                                                {
                                                                    if (status.Trim().ToLower().IndexOf(cond["Valor"].ToString().Trim().ToLower()) < 0)
                                                                        passaCondicao = false;
                                                                }
                                                            }
                                                            else if (cond["Campo"].ToString() == "Departamento do proprietário")
                                                            {
                                                                var status = GVPFramework.getDepartamentoProprietarioByModel(executaAcao[0]["IdModulo"].ToString(), drWkf["IdUser"].ToString());

                                                                if (cond["IdCondicao"].ToString() == "==")
                                                                {
                                                                    if (status.Trim().ToLower() != cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = false;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "!=")
                                                                {
                                                                    if (status.Trim().ToLower() == cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = false;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "LIKE")
                                                                {
                                                                    if (status.Trim().ToLower().IndexOf(cond["Valor"].ToString().Trim().ToLower()) < 0)
                                                                        passaCondicao = false;
                                                                }
                                                            }
                                                            else if (cond["Campo"].ToString() == "Departamento de quem cadastrou")
                                                            {
                                                                var status = GVPFramework.getDepartamentoUsuarioCadastroByModel(executaAcao[0]["IdModulo"].ToString(), drWkf["IdUser"].ToString());

                                                                if (cond["IdCondicao"].ToString() == "==")
                                                                {
                                                                    if (status.Trim().ToLower() != cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = false;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "!=")
                                                                {
                                                                    if (status.Trim().ToLower() == cond["Valor"].ToString().Trim().ToLower())
                                                                        passaCondicao = false;
                                                                }
                                                                else if (cond["IdCondicao"].ToString() == "LIKE")
                                                                {
                                                                    if (status.Trim().ToLower().IndexOf(cond["Valor"].ToString().Trim().ToLower()) < 0)
                                                                        passaCondicao = false;
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        #endregion
                                    }
                                    else if (executaAcao[0]["IdTipoGatilho"].ToString() == "1")
                                    {
                                        #region GatilhoAcao
                                        if (executaAcao[0]["IdTipoAcao"].ToString() == "4")
                                        {
                                            #region MandaEmail
                                            var table = executaAcao[0]["IdModulo"].ToString() == "1" ? "Contato" :
                                                executaAcao[0]["IdModulo"].ToString() == "2" ? "Empresa" :
                                                executaAcao[0]["IdModulo"].ToString() == "4" ? "Oportunidade" :
                                                executaAcao[0]["IdModulo"].ToString() == "5" ? "Telefone" :
                                                executaAcao[0]["IdModulo"].ToString() == "6" ? "Ticket" :
                                                executaAcao[0]["IdModulo"].ToString() == "9" ? "Tarefa" :
                                                executaAcao[0]["IdModulo"].ToString() == "10" ? "Chat" :
                                                executaAcao[0]["IdModulo"].ToString() == "11" ? "Email" :
                                                executaAcao[0]["IdModulo"].ToString() == "17" ? "Atributo" :
                                                executaAcao[0]["IdModulo"].ToString() == "12" ? "WhatsApp" : "";

                                            var mensagem = "";
                                            var destinatario = "";

                                            var dvCampos = new DataView(GVPFramework.RetornaDataTable("SELECT IdCampo, Campo, Valor FROM WorkflowGatilhosAcoes WHERE IdGatilho = " + drWkf["IdGatilho"].ToString()));

                                            if (dvCampos.Count > 0)
                                            {
                                                var tempoI = 0;
                                                mensagem = executaAcao[0]["Mensagem"].ToString();

                                                foreach (DataRowView drCampo in dvCampos)
                                                {
                                                    if (drCampo["IdCampo"].ToString() != "" && drCampo["IdCampo"].ToString() != "-1")
                                                    {
                                                        var campo = new DataView(GVPFramework.RetornaDataTable($@"
                                                            SELECT Resposta
                                                            FROM PropriedadeResposta (NOLOCK)
                                                            WHERE IdUser = {drWkf["IdUser"].ToString()}
                                                                AND IdPropriedade = {drCampo["IdCampo"].ToString()}
                                                        "));

                                                        if (campo.Count > 0)
                                                            mensagem = mensagem.Replace("{" + tempoI + "}", campo[0][0].ToString());
                                                        else
                                                            mensagem = mensagem.Replace("{" + tempoI + "}", drCampo["Campo"].ToString());
                                                    }
                                                    else
                                                    {
                                                        if (drCampo["Campo"].ToString() == "Status")
                                                        {
                                                            var status = GVPFramework.getStatusByModel(executaAcao[0]["IdModulo"].ToString(), drWkf["IdUser"].ToString());
                                                            mensagem = mensagem.Replace("{" + tempoI + "}", status);
                                                        }
                                                        else if (drCampo["Campo"].ToString() == "Fila")
                                                        {
                                                            var status = GVPFramework.getFilaByModel(executaAcao[0]["IdModulo"].ToString(), drWkf["IdUser"].ToString());
                                                            mensagem = mensagem.Replace("{" + tempoI + "}", status);
                                                        }
                                                        else if (drCampo["Campo"].ToString() == "Empresa")
                                                        {
                                                            var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                                SELECT Empresa.Nome 
                                                                FROM vwEmpresa({executaAcao[0]["IdConta"].ToString()}) Empresa
                                                                WHERE Id = (SELECT IdEmpresa FROM Contato WHERE Id = {drWkf["IdUser"].ToString()})
                                                            "));
                                                            var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";
                                                            mensagem = mensagem.Replace("{" + tempoI + "}", status);
                                                        }
                                                        else if (drCampo["Campo"].ToString() == "Grupo empresarial")
                                                        {
                                                            var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                                SELECT Empresa.Nome 
                                                                FROM vwEmpresa({executaAcao[0]["IdConta"].ToString()}) Empresa
                                                                WHERE Id = (SELECT IdEmpresa FROM Empresa WHERE Id = {drWkf["IdUser"].ToString()})
                                                            "));
                                                            var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";
                                                            mensagem = mensagem.Replace("{" + tempoI + "}", status);
                                                        }
                                                        else if (drCampo["Campo"].ToString() == "Grupo")
                                                        {
                                                            var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                                SELECT Nome 
                                                                FROM PropriedadeGrupo
                                                                WHERE Id = (SELECT IdGrupo FROM Atributo WHERE Id = {drWkf["IdUser"].ToString()})
                                                            "));
                                                            var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";
                                                            mensagem = mensagem.Replace("{" + tempoI + "}", status);
                                                        }
                                                        else if (drCampo["Campo"].ToString() == "Canal de origem")
                                                        {
                                                            var status = GVPFramework.getCanalByModel(executaAcao[0]["IdModulo"].ToString(), drWkf["IdUser"].ToString());
                                                            mensagem = mensagem.Replace("{" + tempoI + "}", status);
                                                        }
                                                        else if (drCampo["Campo"].ToString() == "Etapa")
                                                        {
                                                            var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                                SELECT Oportunidade.Nome 
                                                                FROM Oportunidade (NOLOCK)
                                                                    INNER JOIN OportunidadeStatus (NOLOCK) ON OportunidadeStatus.Id = Oportunidade.IdOportunidadeStatus
                                                                WHERE Oportunidade.Id = {drWkf["IdUser"].ToString()}
                                                            "));
                                                            var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";
                                                            mensagem = mensagem.Replace("{" + tempoI + "}", status);
                                                        }
                                                        else if (drCampo["Campo"].ToString() == "Empresa do contato")
                                                        {
                                                            var status = GVPFramework.getEmpresaDoContatoByModel(executaAcao[0]["IdConta"].ToString(), executaAcao[0]["IdModulo"].ToString(), drWkf["IdUser"].ToString());
                                                            mensagem = mensagem.Replace("{" + tempoI + "}", status);
                                                        }
                                                        else if (drCampo["Campo"].ToString() == "Nome do contato")
                                                        {
                                                            var status = GVPFramework.getContatoByModel(executaAcao[0]["IdConta"].ToString(), executaAcao[0]["IdModulo"].ToString(), drWkf["IdUser"].ToString());
                                                            mensagem = mensagem.Replace("{" + tempoI + "}", status);
                                                        }
                                                        else if (drCampo["Campo"].ToString() == "Cidade do contato")
                                                        {
                                                            var status = GVPFramework.getCamposContatoByModel(executaAcao[0]["IdConta"].ToString(), executaAcao[0]["IdModulo"].ToString(), drWkf["IdUser"].ToString(), "Cidade");
                                                            mensagem = mensagem.Replace("{" + tempoI + "}", status);
                                                        }
                                                        else if (drCampo["Campo"].ToString() == "Estado do contato")
                                                        {
                                                            var status = GVPFramework.getCamposContatoByModel(executaAcao[0]["IdConta"].ToString(), executaAcao[0]["IdModulo"].ToString(), drWkf["IdUser"].ToString(), "Estado");
                                                            mensagem = mensagem.Replace("{" + tempoI + "}", status);
                                                        }
                                                        else if (drCampo["Campo"].ToString() == "Sobrenome do contato")
                                                        {
                                                            var status = GVPFramework.getCamposContatoByModel(executaAcao[0]["IdConta"].ToString(), executaAcao[0]["IdModulo"].ToString(), drWkf["IdUser"].ToString(), "Sobrenome");
                                                            mensagem = mensagem.Replace("{" + tempoI + "}", status);
                                                        }
                                                        else if (drCampo["Campo"].ToString() == "Grupo de chat")
                                                        {
                                                            var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                                SELECT GrupoChat.Nome 
                                                                FROM Chat (NOLOCK)
                                                                    INNER JOIN GrupoChat (NOLOCK) ON GrupoChat.Id = Chat.IdGrupoChat
                                                                WHERE Chat.Id = {drWkf["IdUser"].ToString()}
                                                            "));
                                                            var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";
                                                            mensagem = mensagem.Replace("{" + tempoI + "}", status);
                                                        }
                                                        else if (drCampo["Campo"].ToString() == "Grupo de WhatsApp")
                                                        {
                                                            var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                                SELECT GrupoWhatsApp.Nome + ' (' + Numero + ')'
                                                                FROM WhatsApp (NOLOCK)
                                                                    INNER JOIN GrupoWhatsApp (NOLOCK) ON GrupoWhatsApp.Id = WhatsApp.IdGrupoWhatsApp
                                                                WHERE WhatsApp.Id = {drWkf["IdUser"].ToString()}
                                                            "));
                                                            var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";
                                                            mensagem = mensagem.Replace("{" + tempoI + "}", status);
                                                        }
                                                        else if (drCampo["Campo"].ToString() == "Caixa de entrada")
                                                        {
                                                            var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                                SELECT GrupoEmail.Nome
                                                                FROM Email (NOLOCK)
                                                                    INNER JOIN GrupoEmail (NOLOCK) ON GrupoEmail.Id = Email.IdGrupoEmail
                                                                WHERE Email.Id = {drWkf["IdUser"].ToString()}
                                                            "));
                                                            var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";
                                                            mensagem = mensagem.Replace("{" + tempoI + "}", status);
                                                        }
                                                        else if (drCampo["Campo"].ToString() == "De")
                                                        {
                                                            var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                                SELECT Email.De
                                                                FROM Email (NOLOCK)
                                                                WHERE Email.Id = {drWkf["IdUser"].ToString()}
                                                            "));
                                                            var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";
                                                            mensagem = mensagem.Replace("{" + tempoI + "}", status);
                                                        }
                                                        else if (drCampo["Campo"].ToString() == "Para")
                                                        {
                                                            var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                                SELECT Email.Para
                                                                FROM Email (NOLOCK)
                                                                WHERE Email.Id = {drWkf["IdUser"].ToString()}
                                                            "));
                                                            var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";
                                                            mensagem = mensagem.Replace("{" + tempoI + "}", status);
                                                        }
                                                        else if (drCampo["Campo"].ToString() == "Cópia")
                                                        {
                                                            var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                                SELECT Email.Copia
                                                                FROM Email (NOLOCK)
                                                                WHERE Email.Id = {drWkf["IdUser"].ToString()}
                                                            "));
                                                            var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";
                                                            mensagem = mensagem.Replace("{" + tempoI + "}", status);
                                                        }
                                                        else if (drCampo["Campo"].ToString() == "Cópia oculta")
                                                        {
                                                            var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                                SELECT Email.CopiaOculta
                                                                FROM Email (NOLOCK)
                                                                WHERE Email.Id = {drWkf["IdUser"].ToString()}
                                                            "));
                                                            var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";
                                                            mensagem = mensagem.Replace("{" + tempoI + "}", status);
                                                        }
                                                        else if (drCampo["Campo"].ToString() == "Texto")
                                                        {
                                                            var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                                SELECT Email.Texto
                                                                FROM Email (NOLOCK)
                                                                WHERE Email.Id = {drWkf["IdUser"].ToString()}
                                                            "));
                                                            var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";
                                                            mensagem = mensagem.Replace("{" + tempoI + "}", status);
                                                        }
                                                        else if (drCampo["Campo"].ToString() == "Departamento do proprietário")
                                                        {
                                                            var status = GVPFramework.getDepartamentoProprietarioByModel(executaAcao[0]["IdModulo"].ToString(), drWkf["IdUser"].ToString());
                                                            mensagem = mensagem.Replace("{" + tempoI + "}", status);
                                                        }
                                                        else if (drCampo["Campo"].ToString() == "Departamento de quem cadastrou")
                                                        {
                                                            var status = GVPFramework.getDepartamentoUsuarioCadastroByModel(executaAcao[0]["IdModulo"].ToString(), drWkf["IdUser"].ToString());
                                                            mensagem = mensagem.Replace("{" + tempoI + "}", status);
                                                        }
                                                        else if (drCampo["Campo"].ToString() == "Token")
                                                        {
                                                            var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                                SELECT Token
                                                                FROM {table}
                                                                WHERE Id = {drWkf["IdUser"].ToString()}
                                                            "));
                                                            var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";
                                                            mensagem = mensagem.Replace("{" + tempoI + "}", status);
                                                        }
                                                        else if (drCampo["Campo"].ToString() == "Data de criação")
                                                        {
                                                            var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                                SELECT FORMAT(dateadd(HOUR,-3,DataCriacao),'dd/MM/yyyy HH:mm:ss') DataCriacao
                                                                FROM {table}
                                                                WHERE Id = {drWkf["IdUser"].ToString()}
                                                            "));
                                                            var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";
                                                            mensagem = mensagem.Replace("{" + tempoI + "}", status);
                                                        }
                                                        else if (drCampo["Campo"].ToString() == "Data de conclusão")
                                                        {
                                                            var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                                SELECT FORMAT(dateadd(HOUR,-3,DataConclusao),'dd/MM/yyyy HH:mm:ss') DataConclusao
                                                                FROM {table}
                                                                WHERE Id = {drWkf["IdUser"].ToString()}
                                                            "));
                                                            var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";
                                                            mensagem = mensagem.Replace("{" + tempoI + "}", status);
                                                        }
                                                    }

                                                    tempoI++;
                                                }
                                            }
                                            else
                                            {
                                                mensagem = executaAcao[0]["Mensagem"].ToString();
                                            }

                                            var enviarCliente = executaAcao[0]["Acao"].ToString().Split('|');

                                            if (enviarCliente.Length == 3)
                                            {
                                                const string somenteEmailDaCaixaDeEntrada = "1";
                                                string idPropriedade = "0";
                                                var email = enviarCliente[0];
                                                var para = string.Empty;
                                                var idGrupo = enviarCliente[1];
                                                var codicaoDaAcao = enviarCliente[2];

                                                if (codicaoDaAcao == "Proprietario")
                                                {
                                                    var dvProprietario = new DataView(GVPFramework.RetornaDataTable($@"
                                                        SELECT Email FROM Usuario WHERE Id = (SELECT ISNULL(IdProprietario, 0) FROM {table} WHERE Id = {drWkf["IdUser"].ToString()})
                                                    "));

                                                    if (dvProprietario.Count > 0)
                                                        para = dvProprietario[0][0].ToString();
                                                }
                                                else if (codicaoDaAcao == "Contato")
                                                {
                                                    var idContato = $"(SELECT IdContato FROM {table} (NOLOCK) WHERE Id = {drWkf["IdUser"].ToString()})";

                                                    var dvContato = new DataView(GVPFramework.RetornaDataTable($@"
                                                        SELECT Resposta
                                                        FROM PropriedadeResposta (NOLOCK)
                                                        WHERE IdUser = {idContato}
                                                            AND IdPropriedade = (
		                                                        SELECT Id FROM Propriedade WHERE IdConta = {executaAcao[0]["IdConta"].ToString()} AND Nome = 'E-mail' AND IdPropriedadeGrupo IN (
			                                                        SELECT Id FROM PropriedadeGrupo WHERE IdConta = {executaAcao[0]["IdConta"].ToString()} AND IdTipoCadastro = 1
		                                                        )
	                                                        )
                                                    "));

                                                    if (dvContato.Count > 0)
                                                        para = dvContato[0][0].ToString();
                                                }
                                                else
                                                {
                                                    para = codicaoDaAcao;
                                                }

                                                var conta = new DataView(GVPFramework.RetornaDataTable($"SELECT Email, IdConta from GrupoEmail (NOLOCK) WHERE ID = {idGrupo}"));

                                                var EmailDaCaixaDeEntrada = "1";
                                                var emailBase = new DataView();

                                                if (table == "Email")
                                                {
                                                    emailBase = new DataView(GVPFramework.RetornaDataTable($"SELECT IdStatus,IdConta,IdContato,IdUsuarioCriacao,IdProprietario from {table} (NOLOCK) WHERE ID = {drWkf["IdUser"].ToString()}"));
                                                    EmailDaCaixaDeEntrada = emailBase[0]["IdStatus"].ToString();
                                                }
                                                else
                                                {
                                                    emailBase = new DataView(GVPFramework.RetornaDataTable($"SELECT IdConta,IdContato,IdUsuarioCriacao,IdProprietario from {table} (NOLOCK) WHERE ID = {drWkf["IdUser"].ToString()}"));
                                                }

                                                if (emailBase.Count > 0)
                                                {
                                                    if (EmailDaCaixaDeEntrada == somenteEmailDaCaixaDeEntrada)
                                                    {
                                                        var queryStatus = $"select top 1 ID from PipelineEmail (NOLOCK) where IdConta = {conta[0]["IdConta"].ToString()} and Nome = 'Concluido'";
                                                        var idStatus = "0";
                                                        var assunto = string.Empty;

                                                        var queryAssunto = $"select top 1 nome from WorkflowGatilhos (NOLOCK) WHERE WorkflowGatilhos.Id = {drWkf["IdGatilho"].ToString()}";

                                                        var dvAssunto = new DataView(GVPFramework.RetornaDataTable(queryAssunto));
                                                        if (dvAssunto.Count > 0)
                                                            assunto = dvAssunto[0]["nome"].ToString();

                                                        var status = new DataView(GVPFramework.RetornaDataTable(queryStatus));
                                                        if (status.Count > 0)
                                                            idStatus = status[0]["ID"].ToString();

                                                        var idEmail = GVPFramework.ExecutaQueryWithReturn($@"
                                                            INSERT INTO Email(IdModulo,Modulo,IdConta,IdContato,IdUsuarioCriacao,DataCriacao,IdProprietario,IdPipelineEmail,IdStatus,IdGrupoEmail,Assunto,De,Para,Texto)
                                                            VALUES(
                                                                    {drWkf["IdUser"].ToString()},    
                                                                    '{table}',    
                                                                    {emailBase[0]["IdConta"].ToString()},
                                                                    {emailBase[0]["IdContato"].ToString()},
                                                                    {emailBase[0]["IdUsuarioCriacao"].ToString()},
                                                                    GETDATE(),
                                                                    '{emailBase[0]["IdProprietario"].ToString()}',
                                                                    '{idStatus}',
                                                                    3,
                                                                    '{idGrupo.ToString()}',
                                                                    '{assunto}',
                                                                    '{email}',
                                                                    '{para}',
                                                                    '{mensagem.Replace("\n", "</br>").Replace("'", "''")}')
                                                            SELECT  SCOPE_IDENTITY()
                                                        ");

                                                        GVPFramework.ExecutaQuery($"UPDATE Email SET TOKEN = 'EM{idEmail}' WHERE ID = {idEmail}");

                                                        var dvPropriedade = new DataView(GVPFramework.RetornaDataTable($@" SELECT p.id FROM Propriedade  p 
		                                                                                                                join PropriedadeGrupo  g  on p.IdPropriedadeGrupo  = g.Id
		                                                                                                                where g.idtipoCadastro = 11 and g.idconta = {emailBase[0]["IdConta"].ToString()}
		                                                                                                                and p.NOME = 'Assunto' AND p.IdConta = {emailBase[0]["IdConta"].ToString()} "));

                                                        if (dvPropriedade.Count > 0)
                                                            idPropriedade = dvPropriedade[0][0].ToString();

                                                        GVPFramework.ExecutaQuery($"INSERT INTO PropriedadeResposta (IdPropriedade, IdUser, Resposta, DataResposta) VALUES ({idPropriedade},{idEmail},'{assunto}',GETDATE())");

                                                        if (!string.IsNullOrEmpty(para))
                                                        {
                                                            GVPFramework.EnviarEmailWithMailGun(
                                                                conta[0]["Email"].ToString(),
                                                                mensagem,
                                                                para,
                                                                assunto,
                                                                executaAcao[0]["IdConta"].ToString(),
                                                                idGrupo,
                                                                idEmail.ToString()
                                                             );
                                                        }

                                                    }
                                                }
                                            }
                                            else if (executaAcao[0]["Acao"].ToString() == "Contato")
                                            {
                                                var idContato = "";

                                                if (executaAcao[0]["IdModulo"].ToString() == "1")
                                                    idContato = drWkf["IdUser"].ToString();
                                                else
                                                    idContato = $"(SELECT IdContato FROM {table} (NOLOCK) WHERE Id = {drWkf["IdUser"].ToString()})";

                                                var email = new DataView(GVPFramework.RetornaDataTable($@"
                                                    SELECT Resposta
                                                    FROM PropriedadeResposta (NOLOCK)
                                                    WHERE IdUser = {idContato}
                                                        AND IdPropriedade = (
		                                                    SELECT Id FROM Propriedade WHERE IdConta = {executaAcao[0]["IdConta"].ToString()} AND Nome = 'E-mail' AND IdPropriedadeGrupo IN (
			                                                    SELECT Id FROM PropriedadeGrupo WHERE IdConta = {executaAcao[0]["IdConta"].ToString()} AND IdTipoCadastro = 1
		                                                    )
	                                                    )
                                                "));

                                                if (email.Count > 0)
                                                    destinatario = email[0][0].ToString();
                                            }
                                            else if (executaAcao[0]["Acao"].ToString() == "Proprietario")
                                            {
                                                var email = new DataView(GVPFramework.RetornaDataTable($@"
                                                    SELECT Email FROM Usuario (NOLOCK) WHERE Id = (SELECT ISNULL(IdProprietario, 0) FROM {table} WHERE Id = {drWkf["IdUser"].ToString()})
                                                "));

                                                if (email.Count > 0)
                                                    destinatario = email[0][0].ToString();
                                            }
                                            else
                                            {
                                                destinatario = executaAcao[0]["Acao"].ToString();
                                            }

                                            if (destinatario.Length > 0 && enviarCliente.Length != 3)
                                                GVPFramework.EnviarEmail(mensagem, destinatario, executaAcao[0]["Nome"].ToString(), executaAcao[0]["IdConta"].ToString());
                                            #endregion
                                        }
                                        if (executaAcao[0]["IdTipoAcao"].ToString() == "5")
                                        {
                                            #region MandaPesquisaViaEmail
                                            var table = executaAcao[0]["IdModulo"].ToString() == "1" ? "Contato" :
                                                executaAcao[0]["IdModulo"].ToString() == "2" ? "Empresa" :
                                                executaAcao[0]["IdModulo"].ToString() == "4" ? "Oportunidade" :
                                                executaAcao[0]["IdModulo"].ToString() == "5" ? "Telefone" :
                                                executaAcao[0]["IdModulo"].ToString() == "6" ? "Ticket" :
                                                executaAcao[0]["IdModulo"].ToString() == "9" ? "Tarefa" :
                                                executaAcao[0]["IdModulo"].ToString() == "10" ? "Chat" :
                                                executaAcao[0]["IdModulo"].ToString() == "11" ? "Email" :
                                                executaAcao[0]["IdModulo"].ToString() == "17" ? "Atributo" :
                                                executaAcao[0]["IdModulo"].ToString() == "12" ? "WhatsApp" : "";

                                            var mensagem = "";
                                            var destinatario = "";

                                            var dvCampos = new DataView(GVPFramework.RetornaDataTable("SELECT IdCampo, Campo, Valor FROM WorkflowGatilhosAcoes(NOLOCK) WHERE IdGatilho = " + drWkf["IdGatilho"].ToString()));

                                            if (dvCampos.Count > 0)
                                            {
                                                var tempoI = 0;
                                                mensagem = executaAcao[0]["Mensagem"].ToString();

                                                foreach (DataRowView drCampo in dvCampos)
                                                {
                                                    if (drCampo["IdCampo"].ToString() != "" && drCampo["IdCampo"].ToString() != "-1")
                                                    {
                                                        var campo = new DataView(GVPFramework.RetornaDataTable($@"
                                                            SELECT Resposta
                                                            FROM PropriedadeResposta (NOLOCK)
                                                            WHERE IdUser = {drWkf["IdUser"].ToString()}
                                                                AND IdPropriedade = {drCampo["IdCampo"].ToString()}
                                                        "));

                                                        if (campo.Count > 0)
                                                            mensagem = mensagem.Replace("{" + tempoI + "}", campo[0][0].ToString());
                                                        else
                                                            mensagem = mensagem.Replace("{" + tempoI + "}", drCampo["Campo"].ToString());
                                                    }
                                                    else
                                                    {
                                                        if (drCampo["Campo"].ToString() == "Status")
                                                        {
                                                            var status = GVPFramework.getStatusByModel(executaAcao[0]["IdModulo"].ToString(), drWkf["IdUser"].ToString());
                                                            mensagem = mensagem.Replace("{" + tempoI + "}", status);
                                                        }
                                                        else if (drCampo["Campo"].ToString() == "Fila")
                                                        {
                                                            var status = GVPFramework.getFilaByModel(executaAcao[0]["IdModulo"].ToString(), drWkf["IdUser"].ToString());
                                                            mensagem = mensagem.Replace("{" + tempoI + "}", status);
                                                        }
                                                        else if (drCampo["Campo"].ToString() == "Empresa")
                                                        {
                                                            var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                                SELECT Empresa.Nome 
                                                                FROM vwEmpresa({executaAcao[0]["IdConta"].ToString()}) Empresa
                                                                WHERE Id = (SELECT IdEmpresa FROM Contato(NOLOCK) WHERE Id = {drWkf["IdUser"].ToString()})
                                                            "));
                                                            var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";
                                                            mensagem = mensagem.Replace("{" + tempoI + "}", status);
                                                        }
                                                        else if (drCampo["Campo"].ToString() == "Grupo empresarial")
                                                        {
                                                            var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                                SELECT Empresa.Nome 
                                                                FROM vwEmpresa({executaAcao[0]["IdConta"].ToString()}) Empresa
                                                                WHERE Id = (SELECT IdEmpresa FROM Empresa(NOLOCK) WHERE Id = {drWkf["IdUser"].ToString()})
                                                            "));
                                                            var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";
                                                            mensagem = mensagem.Replace("{" + tempoI + "}", status);
                                                        }
                                                        else if (drCampo["Campo"].ToString() == "Grupo")
                                                        {
                                                            var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                                SELECT Nome 
                                                                FROM PropriedadeGrupo(NOLOCK)
                                                                WHERE Id = (SELECT IdGrupo FROM Atributo(NOLOCK) WHERE Id = {drWkf["IdUser"].ToString()})
                                                            "));
                                                            var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";
                                                            mensagem = mensagem.Replace("{" + tempoI + "}", status);
                                                        }
                                                        else if (drCampo["Campo"].ToString() == "Canal de origem")
                                                        {
                                                            var status = GVPFramework.getCanalByModel(executaAcao[0]["IdModulo"].ToString(), drWkf["IdUser"].ToString());
                                                            mensagem = mensagem.Replace("{" + tempoI + "}", status);
                                                        }
                                                        else if (drCampo["Campo"].ToString() == "Etapa")
                                                        {
                                                            var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                                SELECT Oportunidade.Nome 
                                                                FROM Oportunidade (NOLOCK)
                                                                    INNER JOIN OportunidadeStatus (NOLOCK) ON OportunidadeStatus.Id = Oportunidade.IdOportunidadeStatus
                                                                WHERE Oportunidade.Id = {drWkf["IdUser"].ToString()}
                                                            "));
                                                            var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";
                                                            mensagem = mensagem.Replace("{" + tempoI + "}", status);
                                                        }
                                                        else if (drCampo["Campo"].ToString() == "Empresa do contato")
                                                        {
                                                            var status = GVPFramework.getEmpresaDoContatoByModel(executaAcao[0]["IdConta"].ToString(), executaAcao[0]["IdModulo"].ToString(), drWkf["IdUser"].ToString());
                                                            mensagem = mensagem.Replace("{" + tempoI + "}", status);
                                                        }
                                                        else if (drCampo["Campo"].ToString() == "Nome do contato")
                                                        {
                                                            var status = GVPFramework.getContatoByModel(executaAcao[0]["IdConta"].ToString(), executaAcao[0]["IdModulo"].ToString(), drWkf["IdUser"].ToString());
                                                            mensagem = mensagem.Replace("{" + tempoI + "}", status);
                                                        }
                                                        else if (drCampo["Campo"].ToString() == "Cidade do contato")
                                                        {
                                                            var status = GVPFramework.getCamposContatoByModel(executaAcao[0]["IdConta"].ToString(), executaAcao[0]["IdModulo"].ToString(), drWkf["IdUser"].ToString(), "Cidade");
                                                            mensagem = mensagem.Replace("{" + tempoI + "}", status);
                                                        }
                                                        else if (drCampo["Campo"].ToString() == "Estado do contato")
                                                        {
                                                            var status = GVPFramework.getCamposContatoByModel(executaAcao[0]["IdConta"].ToString(), executaAcao[0]["IdModulo"].ToString(), drWkf["IdUser"].ToString(), "Estado");
                                                            mensagem = mensagem.Replace("{" + tempoI + "}", status);
                                                        }
                                                        else if (drCampo["Campo"].ToString() == "Sobrenome do contato")
                                                        {
                                                            var status = GVPFramework.getCamposContatoByModel(executaAcao[0]["IdConta"].ToString(), executaAcao[0]["IdModulo"].ToString(), drWkf["IdUser"].ToString(), "Sobrenome");
                                                            mensagem = mensagem.Replace("{" + tempoI + "}", status);
                                                        }
                                                        else if (drCampo["Campo"].ToString() == "Grupo de chat")
                                                        {
                                                            var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                                SELECT GrupoChat.Nome 
                                                                FROM Chat (NOLOCK)
                                                                    INNER JOIN GrupoChat (NOLOCK) ON GrupoChat.Id = Chat.IdGrupoChat
                                                                WHERE Chat.Id = {drWkf["IdUser"].ToString()}
                                                            "));
                                                            var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";
                                                            mensagem = mensagem.Replace("{" + tempoI + "}", status);
                                                        }
                                                        else if (drCampo["Campo"].ToString() == "Grupo de WhatsApp")
                                                        {
                                                            var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                                SELECT GrupoWhatsApp.Nome + ' (' + Numero + ')'
                                                                FROM WhatsApp (NOLOCK)
                                                                    INNER JOIN GrupoWhatsApp(NOLOCK) ON GrupoWhatsApp.Id = WhatsApp.IdGrupoWhatsApp
                                                                WHERE WhatsApp.Id = {drWkf["IdUser"].ToString()}
                                                            "));
                                                            var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";
                                                            mensagem = mensagem.Replace("{" + tempoI + "}", status);
                                                        }
                                                        else if (drCampo["Campo"].ToString() == "Caixa de entrada")
                                                        {
                                                            var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                                SELECT GrupoEmail.Nome
                                                                FROM Email (NOLOCK)
                                                                    INNER JOIN GrupoEmail (NOLOCK) ON GrupoEmail.Id = Email.IdGrupoEmail
                                                                WHERE Email.Id = {drWkf["IdUser"].ToString()}
                                                            "));
                                                            var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";
                                                            mensagem = mensagem.Replace("{" + tempoI + "}", status);
                                                        }
                                                        else if (drCampo["Campo"].ToString() == "De")
                                                        {
                                                            var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                                SELECT Email.De
                                                                FROM Email (NOLOCK)
                                                                WHERE Email.Id = {drWkf["IdUser"].ToString()}
                                                            "));
                                                            var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";
                                                            mensagem = mensagem.Replace("{" + tempoI + "}", status);
                                                        }
                                                        else if (drCampo["Campo"].ToString() == "Para")
                                                        {
                                                            var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                                SELECT Email.Para
                                                                FROM Email (NOLOCK)
                                                                WHERE Email.Id = {drWkf["IdUser"].ToString()}
                                                            "));
                                                            var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";
                                                            mensagem = mensagem.Replace("{" + tempoI + "}", status);
                                                        }
                                                        else if (drCampo["Campo"].ToString() == "Cópia")
                                                        {
                                                            var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                                SELECT Email.Copia
                                                                FROM Email (NOLOCK)
                                                                WHERE Email.Id = {drWkf["IdUser"].ToString()}
                                                            "));
                                                            var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";
                                                            mensagem = mensagem.Replace("{" + tempoI + "}", status);
                                                        }
                                                        else if (drCampo["Campo"].ToString() == "Cópia oculta")
                                                        {
                                                            var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                                SELECT Email.CopiaOculta
                                                                FROM Email (NOLOCK)
                                                                WHERE Email.Id = {drWkf["IdUser"].ToString()}
                                                            "));
                                                            var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";
                                                            mensagem = mensagem.Replace("{" + tempoI + "}", status);
                                                        }
                                                        else if (drCampo["Campo"].ToString() == "Texto")
                                                        {
                                                            var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                                SELECT Email.Texto
                                                                FROM Email (NOLOCK)
                                                                WHERE Email.Id = {drWkf["IdUser"].ToString()}
                                                            "));
                                                            var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";
                                                            mensagem = mensagem.Replace("{" + tempoI + "}", status);
                                                        }
                                                        else if (drCampo["Campo"].ToString() == "Departamento do proprietário")
                                                        {
                                                            var status = GVPFramework.getDepartamentoProprietarioByModel(executaAcao[0]["IdModulo"].ToString(), drWkf["IdUser"].ToString());
                                                            mensagem = mensagem.Replace("{" + tempoI + "}", status);
                                                        }
                                                        else if (drCampo["Campo"].ToString() == "Departamento de quem cadastrou")
                                                        {
                                                            var status = GVPFramework.getDepartamentoUsuarioCadastroByModel(executaAcao[0]["IdModulo"].ToString(), drWkf["IdUser"].ToString());
                                                            mensagem = mensagem.Replace("{" + tempoI + "}", status);
                                                        }
                                                        else if (drCampo["Campo"].ToString() == "Token")
                                                        {
                                                            var dvStatus = new DataView(GVPFramework.RetornaDataTable($@"
                                                                SELECT Token
                                                                FROM {table} (NOLOCK)
                                                                WHERE Id = {drWkf["IdUser"].ToString()}
                                                            "));
                                                            var status = dvStatus.Count > 0 ? dvStatus[0][0].ToString() : "";
                                                            mensagem = mensagem.Replace("{" + tempoI + "}", status);
                                                        }
                                                    }

                                                    tempoI++;
                                                }
                                            }
                                            else
                                            {
                                                mensagem = executaAcao[0]["Mensagem"].ToString().Replace("\n", "</br>");
                                            }

                                            var enviarCliente = executaAcao[0]["Acao"].ToString().Split('|');

                                            if (enviarCliente.Length == 4)
                                            {
                                                string idPropriedade = "0";
                                                var email = enviarCliente[0];
                                                var para = string.Empty;
                                                var idConta = enviarCliente[1];
                                                var codicaoDaAcao = enviarCliente[2];
                                                var idPesquisa = enviarCliente[3];
                                                var idContato = string.Empty;
                                                var nomePesquisa = string.Empty;

                                                var queryPesquisa = $"SELECT NOME FROM PESQUISASATISFACAO (NOLOCK) WHERE ID = {idPesquisa}";
                                                var dvPesquisa = new DataView(GVPFramework.RetornaDataTable(queryPesquisa));

                                                if (dvPesquisa.Count > 0)
                                                    nomePesquisa = dvPesquisa[0][0].ToString();

                                                var queryContato = $"SELECT IdContato FROM {table} (NOLOCK) WHERE Id = {drWkf["IdUser"].ToString()}";

                                                if (table == "Contato")
                                                    queryContato = $"SELECT Id FROM {table} (NOLOCK) WHERE Id = {drWkf["IdUser"].ToString()}";

                                                var dvContato = new DataView(GVPFramework.RetornaDataTable(queryContato));

                                                if (dvContato.Count > 0)
                                                    idContato = dvContato[0][0].ToString() == "" ? "NULL" : dvContato[0][0].ToString();

                                                var token = Guid.NewGuid().ToString().Replace("-", "");

                                                var queryToken = $"INSERT INTO DisparoPesquisaSatisfacao (IdPesquisa,IdContato,Modulo,IdModulo,Token,Data) VALUES ({idPesquisa},{idContato},'{table}',{drWkf["IdUser"].ToString()},'{token}',GETDATE()) ";
                                                GVPFramework.ExecutaQuery(queryToken);

                                                var url = $"{appUrl}/embed/pesquisa.html?token={token}";
                                                mensagem = mensagem.Replace("ABGHVRGYORB5bwIKPrAPmlng3g2tiQ", url);

                                                if (codicaoDaAcao == "Proprietario")
                                                {
                                                    var dvProprietario = new DataView(GVPFramework.RetornaDataTable($@"
                                                        SELECT Email FROM Usuario (NOLOCK) WHERE Id = (SELECT ISNULL(IdProprietario, 0) FROM {table}(NOLOCK) WHERE Id = {drWkf["IdUser"].ToString()})
                                                    "));

                                                    if (dvProprietario.Count > 0)
                                                        para = dvProprietario[0][0].ToString();
                                                }
                                                else if (codicaoDaAcao == "Contato")
                                                {
                                                    idContato = $"(SELECT IdContato FROM {table} (NOLOCK) WHERE Id = {drWkf["IdUser"].ToString()})";

                                                    if (table == "Contato")
                                                        idContato = $"(SELECT Id FROM {table} (NOLOCK) WHERE Id = {drWkf["IdUser"].ToString()})";

                                                    dvContato = new DataView(GVPFramework.RetornaDataTable($@"
                                                        SELECT Resposta
                                                        FROM PropriedadeResposta (NOLOCK)
                                                        WHERE IdUser = {idContato}
                                                            AND IdPropriedade = (
		                                                        SELECT Id FROM Propriedade(NOLOCK) WHERE IdConta = {executaAcao[0]["IdConta"].ToString()} AND Nome = 'E-mail' AND IdPropriedadeGrupo IN (
			                                                        SELECT Id FROM PropriedadeGrupo(NOLOCK) WHERE IdConta = {executaAcao[0]["IdConta"].ToString()} AND IdTipoCadastro = 1
		                                                        )
	                                                        )
                                                    "));

                                                    if (dvContato.Count > 0)
                                                        para = dvContato[0][0].ToString();
                                                }
                                                else
                                                {
                                                    para = codicaoDaAcao;
                                                }

                                                var conta = new DataView(GVPFramework.RetornaDataTable($"SELECT Email, IdConta from GrupoEmail (NOLOCK) WHERE ID = {idConta}"));

                                                var campo = string.Empty;
                                                var status = $"IdPipeline{table}";
                                                var IdContato = "IdContato";

                                                if (table == "Ticket" || table == "Email")
                                                    campo = "Assunto";
                                                else if (table == "Telefone" || table == "Tarefa")
                                                    campo = "Título";
                                                else if (table == "Contato")
                                                {
                                                    IdContato = "Id IdContato";
                                                    campo = "Nome";
                                                }
                                                else if (table == "Empresa")
                                                {
                                                    IdContato = "Id IdContato";
                                                    campo = "Razão Social";
                                                }
                                                else if (table == "Oportunidade")
                                                {
                                                    campo = "Título";
                                                    status = "IdOportunidadeEtapa";
                                                }
                                                else if (table == "Oportunidade")
                                                {
                                                    campo = "Título";
                                                    status = "IdOportunidadeEtapa";
                                                }

                                                if (executaAcao[0]["IdModulo"].ToString() == "17")
                                                {
                                                    var emailBase = new DataView(GVPFramework.RetornaDataTable($@"
                                                        SELECT IdConta,{IdContato},IdUsuarioCriacao,DataCriacao,Token,{idConta} IdGrupoEmail,
                                                            (select top 1  r.Resposta from Propriedade p (nolock)
				                                            join PropriedadeResposta r (nolock) on r.IdPropriedade = p.Id
				                                            where r.IdUser = {table}.id and p.Nome = '{campo}' and p.IdConta = {conta[0]["IdConta"].ToString()}) Assunto 
                                                            FROM {table} (NOLOCK) 
                                                                WHERE ID = {drWkf["IdUser"].ToString()}
                                                                        AND {table}.IdConta = {conta[0]["IdConta"].ToString()}
                                                    "));

                                                    nomePesquisa = executaAcao[0]["Nome"].ToString();

                                                    var queryAssunto = $"select top 1 nome from WorkflowGatilhos (NOLOCK) WHERE WorkflowGatilhos.Id = {drWkf["IdGatilho"].ToString()}";

                                                    var dvAssunto = new DataView(GVPFramework.RetornaDataTable(queryAssunto));
                                                    if (dvAssunto.Count > 0)
                                                        nomePesquisa = dvAssunto[0]["nome"].ToString();

                                                    var idEmail = GVPFramework.ExecutaQueryWithReturn($@"
                                                        INSERT INTO Email(IdModulo,Modulo,IdConta,IdContato,IdUsuarioCriacao,DataCriacao,IdProprietario,IdPipelineEmail,IdStatus,IdGrupoEmail,Assunto,De,Para,Texto)
                                                        VALUES(
                                                                {drWkf["IdUser"].ToString()},    
                                                                '{table}',    
                                                                {emailBase[0]["IdConta"].ToString()},
                                                                {(emailBase[0]["IdContato"].ToString() == "" ? "NULL" : emailBase[0]["IdContato"].ToString())},
                                                                {emailBase[0]["IdUsuarioCriacao"].ToString()},
                                                                GETDATE(),
                                                                NULL,
                                                                NULL,
                                                                3,
                                                                '{emailBase[0]["IdGrupoEmail"].ToString()}',
                                                                '{nomePesquisa}',
                                                                '{email}',
                                                                '{para}',
                                                                '{mensagem}')
                                                        SELECT  SCOPE_IDENTITY()
                                                    ");

                                                    GVPFramework.ExecutaQuery($"UPDATE Email SET TOKEN = 'EM{idEmail}' WHERE ID = {idEmail}");

                                                    var dvPropriedade = new DataView(GVPFramework.RetornaDataTable($@"
                                                        SELECT p.id FROM Propriedade(NOLOCK)  p 
		                                                join PropriedadeGrupo(NOLOCK)  g  on p.IdPropriedadeGrupo  = g.Id
		                                                where g.idtipoCadastro = 11 and g.idconta = {emailBase[0]["IdConta"].ToString()}
		                                                and p.NOME = 'Assunto' AND p.IdConta = {emailBase[0]["IdConta"].ToString()} 
                                                    "));

                                                    if (dvPropriedade.Count > 0)
                                                        idPropriedade = dvPropriedade[0][0].ToString();

                                                    GVPFramework.ExecutaQuery($"INSERT INTO PropriedadeResposta (IdPropriedade, IdUser, Resposta, DataResposta) VALUES ({idPropriedade},{idEmail},'{emailBase[0]["Assunto"].ToString()}',GETDATE())");

                                                    GVPFramework.AdicionaLinhaTempo(executaAcao[0]["IdConta"].ToString(), "11", idEmail.ToString(), "1", $"E-mail cadastrado a partir da trilha do workflow " + executaAcao[0]["Nome"].ToString() + ".", "1", DateTime.Now.AddHours(3).ToString("yyyy-MM-dd HH:mm:ss"));

                                                    if (!string.IsNullOrEmpty(para))
                                                    {
                                                        GVPFramework.EnviarEmailWithMailGun(
                                                         conta[0]["Email"].ToString(),
                                                         mensagem.Replace("\n", "</br>"),
                                                         para,
                                                         nomePesquisa,
                                                         executaAcao[0]["IdConta"].ToString(),
                                                         emailBase[0]["IdGrupoEmail"].ToString(),
                                                         idEmail.ToString()
                                                        );
                                                    }
                                                }
                                                else
                                                {
                                                    var emailBase = new DataView(GVPFramework.RetornaDataTable($@"
                                                        SELECT IdConta,{IdContato},IdUsuarioCriacao,DataCriacao,Token,IdProprietario,{status},{idConta} IdGrupoEmail,
                                                            (select top 1  r.Resposta from Propriedade p (nolock)
				                                            join PropriedadeResposta r (nolock) on r.IdPropriedade = p.Id
				                                            where r.IdUser = {table}.id and p.Nome = '{campo}' and p.IdConta = {conta[0]["IdConta"].ToString()} ) Assunto 
                                                            FROM {table} (NOLOCK) 
                                                                WHERE ID = {drWkf["IdUser"].ToString()}
                                                                        AND {table}.IdConta = {conta[0]["IdConta"].ToString()}
                                                    "));

                                                    nomePesquisa = executaAcao[0]["Nome"].ToString();
                                                    var queryAssunto = $"select top 1 nome from WorkflowGatilhos (NOLOCK) WHERE WorkflowGatilhos.Id = {drWkf["IdGatilho"].ToString()}";

                                                    var dvAssunto = new DataView(GVPFramework.RetornaDataTable(queryAssunto));
                                                    if (dvAssunto.Count > 0)
                                                        nomePesquisa = dvAssunto[0]["nome"].ToString();

                                                    if (emailBase.Count > 0)
                                                    {
                                                        var idEmail = GVPFramework.ExecutaQueryWithReturn($@"
                                                        INSERT INTO Email(IdModulo,Modulo,IdConta,IdContato,IdUsuarioCriacao,DataCriacao,IdProprietario,IdPipelineEmail,IdStatus,IdGrupoEmail,Assunto,De,Para,Texto)
                                                        VALUES(
                                                                {drWkf["IdUser"].ToString()},    
                                                                '{table}',    
                                                                {emailBase[0]["IdConta"].ToString()},
                                                                {emailBase[0]["IdContato"].ToString()},
                                                                {emailBase[0]["IdUsuarioCriacao"].ToString()},
                                                                GETDATE(),
                                                                '{emailBase[0]["IdProprietario"].ToString()}',
                                                                '{emailBase[0][status].ToString()}',
                                                                3,
                                                                '{emailBase[0]["IdGrupoEmail"].ToString()}',
                                                                '{nomePesquisa}',
                                                                '{email}',
                                                                '{para}',
                                                                '{mensagem}')
                                                        SELECT  SCOPE_IDENTITY()
                                                    ");

                                                        GVPFramework.ExecutaQuery($"UPDATE Email SET TOKEN = 'EM{idEmail}' WHERE ID = {idEmail}");

                                                        var dvPropriedade = new DataView(GVPFramework.RetornaDataTable($@"
                                                        SELECT p.id FROM Propriedade (NOLOCK) p 
		                                                join PropriedadeGrupo (NOLOCK) g  on p.IdPropriedadeGrupo  = g.Id
		                                                where g.idtipoCadastro = 11 and g.idconta = {emailBase[0]["IdConta"].ToString()}
		                                                and p.NOME = 'Assunto' AND p.IdConta = {emailBase[0]["IdConta"].ToString()} 
                                                    "));

                                                        if (dvPropriedade.Count > 0)
                                                            idPropriedade = dvPropriedade[0][0].ToString();

                                                        GVPFramework.ExecutaQuery($"INSERT INTO PropriedadeResposta (IdPropriedade, IdUser, Resposta, DataResposta) VALUES ({idPropriedade},{idEmail},'{emailBase[0]["Assunto"].ToString()}',GETDATE())");

                                                        GVPFramework.AdicionaLinhaTempo(executaAcao[0]["IdConta"].ToString(), "11", idEmail.ToString(), "1", $"E-mail cadastrado a partir da trilha do workflow " + executaAcao[0]["Nome"].ToString() + ".", "1", DateTime.Now.AddHours(3).ToString("yyyy-MM-dd HH:mm:ss"));

                                                        if (!string.IsNullOrEmpty(para))
                                                        {
                                                            GVPFramework.EnviarEmailWithMailGun(
                                                             conta[0]["Email"].ToString(),
                                                             mensagem.Replace("\n", "</br>"),
                                                             para,
                                                             nomePesquisa,
                                                             executaAcao[0]["IdConta"].ToString(),
                                                             emailBase[0]["IdGrupoEmail"].ToString(),
                                                             idEmail.ToString()
                                                            );
                                                        }
                                                    }
                                                }
                                            }

                                            if (enviarCliente.Length == 5)
                                            {
                                                var queryContato = $"SELECT IdContato FROM {table} (NOLOCK) WHERE Id = {drWkf["IdUser"].ToString()}";
                                                var dvContato = new DataView(GVPFramework.RetornaDataTable(queryContato));
                                                var id = string.Empty;
                                                var idPesquisa = enviarCliente[3];
                                                var nomePesquisa = string.Empty;
                                                var codicaoDaAcao = enviarCliente[2];
                                                var idContato = string.Empty;
                                                var para = string.Empty;

                                                var queryPesquisa = $"SELECT NOME FROM PESQUISASATISFACAO (NOLOCK) WHERE ID = {idPesquisa}";
                                                var dvPesquisa = new DataView(GVPFramework.RetornaDataTable(queryPesquisa));

                                                if (dvPesquisa.Count > 0)
                                                    nomePesquisa = dvPesquisa[0][0].ToString();

                                                var queryAssunto = $"select top 1 nome from WorkflowGatilhos (NOLOCK) WHERE WorkflowGatilhos.Id = {drWkf["IdGatilho"].ToString()}";

                                                var dvAssunto = new DataView(GVPFramework.RetornaDataTable(queryAssunto));
                                                if (dvAssunto.Count > 0)
                                                    nomePesquisa = dvAssunto[0]["nome"].ToString();

                                                if (dvContato.Count > 0)
                                                {
                                                    id = dvContato[0][0].ToString();
                                                }
                                                if (id != "0" && id != "")
                                                {
                                                    var token = Guid.NewGuid().ToString().Replace("-", "");

                                                    var queryToken = $"INSERT INTO DisparoPesquisaSatisfacao (IdPesquisa,IdContato,Modulo,IdModulo,Token,Data) VALUES ({idPesquisa},{id},'{table}',{drWkf["IdUser"].ToString()},'{token}',GETDATE())";
                                                    GVPFramework.ExecutaQuery(queryToken);

                                                    var url = $"{appUrl}/embed/pesquisa.html?token={token}";
                                                    mensagem = mensagem.Replace("ABGHVRGYORB5bwIKPrAPmlng3g2tiQ", url);
                                                }
                                                if (codicaoDaAcao == "Proprietario")
                                                {
                                                    var dvProprietario = new DataView(GVPFramework.RetornaDataTable($@"
                                                        SELECT Email FROM Usuario (NOLOCK) WHERE Id = (SELECT ISNULL(IdProprietario, 0) FROM {table}(NOLOCK) WHERE Id = {drWkf["IdUser"].ToString()})
                                                    "));

                                                    if (dvProprietario.Count > 0)
                                                        para = dvProprietario[0][0].ToString();
                                                }
                                                else if (codicaoDaAcao == "Contato")
                                                {
                                                    idContato = $"(SELECT IdContato FROM {table} (NOLOCK) WHERE Id = {drWkf["IdUser"].ToString()})";

                                                    if (table == "Contato")
                                                        idContato = $"(SELECT Id FROM {table} (NOLOCK) WHERE Id = {drWkf["IdUser"].ToString()})";

                                                    dvContato = new DataView(GVPFramework.RetornaDataTable($@"
                                                        SELECT Resposta
                                                        FROM PropriedadeResposta (NOLOCK)
                                                        WHERE IdUser = {idContato}
                                                            AND IdPropriedade = (
		                                                        SELECT Id FROM Propriedade(NOLOCK) WHERE IdConta = {executaAcao[0]["IdConta"].ToString()} AND Nome = 'E-mail' AND IdPropriedadeGrupo IN (
			                                                        SELECT Id FROM PropriedadeGrupo(NOLOCK) WHERE IdConta = {executaAcao[0]["IdConta"].ToString()} AND IdTipoCadastro = 1
		                                                        )
	                                                        )
                                                    "));

                                                    if (dvContato.Count > 0)
                                                        para = dvContato[0][0].ToString();
                                                }
                                                else
                                                {
                                                    para = codicaoDaAcao;
                                                }
                                                if (!String.IsNullOrEmpty(para))
                                                {
                                                    nomePesquisa = executaAcao[0]["Nome"].ToString();


                                                    if (dvAssunto.Count > 0)
                                                        nomePesquisa = dvAssunto[0]["nome"].ToString();

                                                    GVPFramework.EnviarEmail(mensagem.Replace("\n", "</br>"), para, nomePesquisa, executaAcao[0]["IdConta"].ToString());

                                                }
                                            }

                                            #endregion
                                        }
                                        if (executaAcao[0]["IdTipoAcao"].ToString() == "6")
                                        {
                                            #region MandaTemplateWP

                                            var idTemplate = executaAcao[0]["Acao"].ToString().Split('_')[0].ToString();
                                            var isPesquisaSatisfacao = executaAcao[0]["Acao"].ToString().Split('_').Length > 0 ? executaAcao[0]["Acao"].ToString().Split('_')[1].ToString() == "True" : false;
                                            var idPesquisa = executaAcao[0]["Acao"].ToString().Split('_').Length > 0 ? executaAcao[0]["Acao"].ToString().Split('_')[2].ToString() : "0";

                                            var queryTemplate = $@"
                                                SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
                                                SELECT TOP 1 g.Token, t.NomeTemplate, g.NameSpace, g.Id360,
	                                                g.Email, g.Senha, g.IdServidor, g.URL, t.Botoes, t.Campos, G.Numero, t.Texto, t.Nome
                                                FROM GrupoWhatsApp  g (NOLOCK) 
                                                    JOIN Template t (NOLOCK) ON g.Id = t.IdGrupo
                                                WHERE t.Id = {idTemplate}";

                                            var dvTemplate = new DataView(GVPFramework.RetornaDataTable(queryTemplate));

                                            if (dvTemplate.Count > 0)
                                            {
                                                var tokenGrupo = dvTemplate[0][0].ToString();
                                                var nomeTemplate = dvTemplate[0][1].ToString();
                                                var nameSpace = dvTemplate[0][2].ToString();
                                                var id360 = dvTemplate[0][3].ToString();
                                                var parameters = new List<object>();
                                                var Texto = dvTemplate[0]["Texto"].ToString();
                                                var Nome = dvTemplate[0]["Nome"].ToString();

                                                var buttons = Newtonsoft.Json.JsonConvert.DeserializeObject<JArray>(dvTemplate[0]["Botoes"].ToString());
                                                var dinamicInputs = Newtonsoft.Json.JsonConvert.DeserializeObject<JArray>(dvTemplate[0]["Campos"].ToString());

                                                var components = new[]
                                                {
                                                    new
                                                    {   type = "body",
                                                        parameters = parameters.ToArray()
                                                    },
                                                };

                                                ServicePointManager.ServerCertificateValidationCallback += (senders, certificate, chain, sslPolicyErrors) => true;

                                                var IdContato = "0";
                                                var table = "";

                                                if (executaAcao[0]["IdModulo"].ToString() == "1") { table = "Contato"; }
                                                else if (executaAcao[0]["IdModulo"].ToString() == "2") { table = "Empresa"; }
                                                else if (executaAcao[0]["IdModulo"].ToString() == "4") { table = "Oportunidade"; }
                                                else if (executaAcao[0]["IdModulo"].ToString() == "5") { table = "Telefone"; }
                                                else if (executaAcao[0]["IdModulo"].ToString() == "6") { table = "Ticket"; }
                                                else if (executaAcao[0]["IdModulo"].ToString() == "9") { table = "Tarefa"; }
                                                else if (executaAcao[0]["IdModulo"].ToString() == "10") { table = "Chat"; }
                                                else if (executaAcao[0]["IdModulo"].ToString() == "11") { table = "Email"; }
                                                else if (executaAcao[0]["IdModulo"].ToString() == "12") { table = "WhatsApp"; }
                                                else if (executaAcao[0]["IdModulo"].ToString() == "17") { table = "Atributo"; }

                                                if (executaAcao[0]["IdModulo"].ToString() == "1")
                                                    IdContato = drWkf["IdUser"].ToString();
                                                else
                                                    IdContato = new DataView(GVPFramework.RetornaDataTable($"SELECT ISNULL(IdContato, '') FROM {table} WHERE Id = {drWkf["IdUser"].ToString()}"))[0][0].ToString();

                                                if (IdContato != "0")
                                                {
                                                    var queryNumber = $@" 
                                                        SELECT 
                                                            PropriedadeResposta.IdUser AS Id,
                                                            Nome, Resposta
                                                        FROM PropriedadeResposta (NOLOCK)
	                                                        INNER JOIN Propriedade (NOLOCK) ON Propriedade.Id = PropriedadeResposta.IdPropriedade
		                                                        AND IdTipoPropriedade = 14
		                                                        AND IdPropriedadeGrupo IN (
			                                                        SELECT Id FROM PropriedadeGrupo (NOLOCK) WHERE IdTipoCadastro = 1
		                                                        )
                                                        WHERE PropriedadeResposta.IdUser = {IdContato}
                                                            AND ISNULL(Resposta, '') <> ''
                                                        ORDER BY PropriedadeResposta.IdUser DESC
                                                    ";

                                                    var dvContato = new DataView(GVPFramework.RetornaDataTable(queryNumber));
                                                    var iContatoTemp = "";

                                                    foreach (DataRowView drContato in dvContato)
                                                    {
                                                        if (iContatoTemp != drContato["Id"].ToString())
                                                        {
                                                            iContatoTemp = drContato["Id"].ToString();

                                                            dvContato.RowFilter = "Id = " + drContato["Id"].ToString();
                                                            if (dvContato.Count > 1)
                                                                dvContato.RowFilter = "Nome = 'Celular' AND Id = " + drContato["Id"].ToString();
                                                            
                                                            if (dvContato.Count == 0)
                                                                continue;

                                                            var numero = dvContato[0]["Resposta"].ToString().Replace("-", "").Replace("(", "")
                                                                                                  .Replace(")", "").Replace(" ", "")
                                                                                                  .Replace("+", "");

                                                            var to = "";

                                                            var dvConfirmSala = new DataView(GVPFramework.RetornaDataTable($@"SELECT COUNT(Id) FROM WhatsApp (NOLOCK) WHERE Number = '{numero}'"));

                                                            if (dvConfirmSala.Count == 0) { to = numero.Length == 11 ? numero.PadLeft(13, '5') : numero.Length == 10 ? numero.PadLeft(12, '5') : numero; }
                                                            else { to = numero; }

                                                            if (dvTemplate[0]["IdServidor"].ToString() == "1")
                                                            {
                                                                to = getNumeroOficial(tokenGrupo, to);
                                                                if (to != "")
                                                                {
                                                                    if (dinamicInputs.Count > 0)
                                                                    {
                                                                        int iTempWP = 0;
                                                                        foreach (JObject input in dinamicInputs)
                                                                        {
                                                                            if (input["index"].ToString() == iTempWP.ToString())
                                                                            {
                                                                                string[] separatingStrings = { "_dinamicParam_" };
                                                                                string[] words = input["nome"].ToString().Split(separatingStrings, System.StringSplitOptions.RemoveEmptyEntries);

                                                                                var IdPropriedade = words[1].ToString();

                                                                                var queryWP = "SELECT Resposta FROM PropriedadeResposta WHERE IdUser = " + dvContato[0]["Id"].ToString() + " AND IdPropriedade = " + IdPropriedade;
                                                                                var dvWP = new DataView(GVPFramework.RetornaDataTable(queryWP));

                                                                                if (dvWP.Count > 0)
                                                                                {
                                                                                    var obj = new { type = "text", text = dvWP[0][0].ToString() == "" ? "undefined" : dvWP[0][0].ToString() };
                                                                                    parameters.Add(obj);

                                                                                    Texto = Texto.Replace("{{" + (iTempWP + 1) + "}}", (dvWP[0][0].ToString() == "" ? "undefined" : dvWP[0][0].ToString()));
                                                                                }
                                                                                else
                                                                                {
                                                                                    var obj = new { type = "text", text = "undefined" };
                                                                                    parameters.Add(obj);

                                                                                    Texto = Texto.Replace("{{" + (iTempWP + 1) + "}}", "undefined");
                                                                                }
                                                                            }

                                                                            iTempWP++;
                                                                        }

                                                                        components = new[]
                                                                        {
                                                                            new
                                                                            {   type = "body",
                                                                                parameters = parameters.ToArray()
                                                                            },
                                                                        };
                                                                    }

                                                                    var msg = new
                                                                    {
                                                                        recipient_type = "individual",
                                                                        to = to,
                                                                        type = "template",
                                                                        template = new
                                                                        {
                                                                            nameSpace = nameSpace,
                                                                            name = nomeTemplate,
                                                                            language = new { code = "pt_BR", policy = "deterministic" },
                                                                            components
                                                                        }
                                                                    };

                                                                    var json = Newtonsoft.Json.JsonConvert.SerializeObject(msg).Replace("nameSpace", "namespace");

                                                                    var URL360 = "https://waba.360dialog.io/";
                                                                    var getURL360 = new DataView(GVPFramework.RetornaDataTable("SELECT Ativo, Valor FROM Config (NOLOCK) WHERE Nome = 'URL WhatsApp 360'"));
                                                                    if (getURL360.Count > 0)
                                                                    {
                                                                        if (getURL360[0]["Ativo"].ToString() == "True")
                                                                            URL360 = getURL360[0]["Valor"].ToString();
                                                                    }

                                                                    var clientTemplate = new RestClient(URL360 + "v1/messages");
                                                                    clientTemplate.Timeout = -1;
                                                                    var requestTemplate = new RestRequest(Method.POST);
                                                                    requestTemplate.AddHeader("D360-API-KEY", tokenGrupo);
                                                                    requestTemplate.AddHeader("Content-Type", "application/json");
                                                                    requestTemplate.AddParameter("application/json", json, ParameterType.RequestBody);
                                                                    var result = clientTemplate.Execute(requestTemplate);

                                                                    if (result.StatusCode.ToString() == "OK" || result.StatusCode.ToString() == "Created")
                                                                    {
                                                                        var WhatsResponse = Newtonsoft.Json.JsonConvert.DeserializeObject<JObject>(result.Content);

                                                                        GVPFramework.ExecutaQuery($@"
                                                                            INSERT INTO EnvioTemplate (IdContato, Telefone, Template, DataDisparo, Token, IdUsuario, Texto)
                                                                                VALUES ({dvContato[0]["Id"].ToString()}, '{to}', '{nomeTemplate}', GETDATE(), '{WhatsResponse["messages"][0]["id"].ToString().TextoParaQuery()}', 1, N'{Texto.TextoParaQuery()}')
                                                                        ");

                                                                        GVPFramework.AdicionaLinhaTempo(executaAcao[0]["IdConta"].ToString(), "1", dvContato[0]["Id"].ToString(), "3", Nome, "1");

                                                                        if (isPesquisaSatisfacao)
                                                                        {
                                                                            var queryToken = $"INSERT INTO DisparoPesquisaSatisfacao (IdPesquisa, IdContato, Modulo, IdModulo, Token, Data) VALUES ({idPesquisa}, {dvContato[0]["Id"].ToString()}, '{table}', {drWkf["IdUser"].ToString()}, '', GETDATE()); SELECT @@IDENTITY;";
                                                                            var dvToken = new DataView(GVPFramework.RetornaDataTable(queryToken));

                                                                            //var dvPesq = new DataView(GVPFramework.RetornaDataTable("SELECT Nome, Descricao, Alert FROM PesquisaSatisfacao WHERE Id = " + idPesquisa));

                                                                            //var dvSurvey = new DataView(GVPFramework.RetornaDataTable($@"
                                                                            //    INSERT INTO WPSurvey (IdCliente, TransactionId, AttemptId, NameSurvey, SuccessMessage, DataCadastro)
                                                                            //        VALUES ({dvContato[0]["Id"].ToString()}, {dvToken[0][0].ToString()}, {idPesquisa}, '{dvPesq[0]["Nome"].ToString().TextoParaQuery()}', '{dvPesq[0]["Alert"].ToString().TextoParaQuery()}', GETDATE())
                                                                            //    SELECT @@IDENTITY;
                                                                            //"));

                                                                            //var IdSurvey = dvSurvey[0][0].ToString();

                                                                            //GVPFramework.ExecutaQuery($@"
                                                                            //    INSERT INTO WPSurveyQuestions 
                                                                            //        SELECT {IdSurvey}, IdPropriedade, ISNULL(Ordem, 0), Questionario, ISNULL(TipoNPS, 0), NULL, NULL
                                                                            //        FROM PesquisaSatisfacaoQuestionario(NOLOCK)
                                                                            //        WHERE IdPesquisaSatisfacao = {idPesquisa}
                                                                            //");
                                                                        }
                                                                    }
                                                                    else
                                                                    {
                                                                        GVPFramework.ExecutaQuery($@"
                                                                            INSERT INTO EnvioTemplate (IdContato, Telefone, Template, DataDisparo, IdUsuario, Texto)
                                                                                VALUES ({dvContato[0]["Id"].ToString()}, '{to}', '{nomeTemplate}', GETDATE(), 1, N'{Texto.TextoParaQuery()}')
                                                                        ");
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    GVPFramework.ExecutaQuery($@"
                                                                        INSERT INTO EnvioTemplate (IdContato, Telefone, Template, DataDisparo, IdUsuario, Texto)
                                                                            VALUES ({dvContato[0]["Id"].ToString()}, '{numero}', '{nomeTemplate}', GETDATE(), 1, N'{Texto.TextoParaQuery()}')
                                                                    ");
                                                                }
                                                            }
                                                            else if (dvTemplate[0]["IdServidor"].ToString() == "6")
                                                            {

                                                                var URLWhatsAppCloud = "https://graph.facebook.com/v13.0/";

                                                                if (to != "")
                                                                {
                                                                    if (dinamicInputs.Count > 0)
                                                                    {
                                                                        int iTempWP = 0;
                                                                        foreach (JObject input in dinamicInputs)
                                                                        {
                                                                            if (input["index"].ToString() == iTempWP.ToString())
                                                                            {
                                                                                string[] separatingStrings = { "_dinamicParam_" };
                                                                                string[] words = input["nome"].ToString().Split(separatingStrings, System.StringSplitOptions.RemoveEmptyEntries);

                                                                                if (words.Length > 1)
                                                                                {
                                                                                    var IdPropriedade = words[1].ToString();

                                                                                    var queryWP = "SELECT Resposta FROM PropriedadeResposta WHERE IdUser = " + dvContato[0]["Id"].ToString() + " AND IdPropriedade = " + IdPropriedade;
                                                                                    var dvWP = new DataView(GVPFramework.RetornaDataTable(queryWP));

                                                                                    if (dvWP.Count > 0)
                                                                                    {
                                                                                        var obj = new { type = "text", text = dvWP[0][0].ToString() == "" ? "undefined" : dvWP[0][0].ToString() };
                                                                                        parameters.Add(obj);

                                                                                        Texto = Texto.Replace("{{" + (iTempWP + 1) + "}}", (dvWP[0][0].ToString() == "" ? "undefined" : dvWP[0][0].ToString()));
                                                                                    }
                                                                                    else
                                                                                    {
                                                                                        var obj = new { type = "text", text = "undefined" };
                                                                                        parameters.Add(obj);

                                                                                        Texto = Texto.Replace("{{" + (iTempWP + 1) + "}}", "undefined");
                                                                                    }
                                                                                }
                                                                                else
                                                                                {
                                                                                    var obj = new { type = "text", text = words[0].ToString() };
                                                                                    parameters.Add(obj);

                                                                                    Texto = Texto.Replace("{{" + (iTempWP + 1) + "}}", words[0].ToString());
                                                                                }
                                                                            }

                                                                            iTempWP++;
                                                                        }

                                                                        components = new[]
                                                                        {
                                                                            new
                                                                            {   type = "body",
                                                                                parameters = parameters.ToArray()
                                                                            },
                                                                        };
                                                                    }

                                                                    var msg = new
                                                                    {
                                                                        messaging_product = "whatsapp",
                                                                        recipient_type = "individual",
                                                                        to = to,
                                                                        type = "template",
                                                                        template = new
                                                                        {
                                                                            name = nomeTemplate,
                                                                            language = new { code = "pt_BR" },
                                                                            components
                                                                        }
                                                                    };

                                                                    var json = Newtonsoft.Json.JsonConvert.SerializeObject(msg);

                                                                    var clientTemplate = new RestClient(URLWhatsAppCloud + id360 + "/messages/");
                                                                    var requestTemplate = new RestRequest(Method.POST);
                                                                    requestTemplate.AddHeader("Authorization", "Bearer " + tokenGrupo);
                                                                    requestTemplate.AddHeader("Content-Type", "application/json");
                                                                    requestTemplate.AddParameter("application/json", json, ParameterType.RequestBody);
                                                                    var result = clientTemplate.Execute(requestTemplate);

                                                                    if (result.StatusCode.ToString() == "OK" || result.StatusCode.ToString() == "Created")
                                                                    {
                                                                        var WhatsResponse = Newtonsoft.Json.JsonConvert.DeserializeObject<JObject>(result.Content);

                                                                        GVPFramework.ExecutaQuery($@"
                                                                            INSERT INTO EnvioTemplate (IdContato, Telefone, Template, DataDisparo, Token, IdUsuario, Texto)
                                                                                VALUES ({dvContato[0]["Id"].ToString()}, '{to}', '{nomeTemplate}', GETDATE(), '{WhatsResponse["messages"][0]["id"].ToString().TextoParaQuery()}', 1, N'{Texto.TextoParaQuery()}')
                                                                        ");

                                                                        GVPFramework.AdicionaLinhaTempo(executaAcao[0]["IdConta"].ToString(), "1", dvContato[0]["Id"].ToString(), "3", Nome, "1");

                                                                        if (isPesquisaSatisfacao)
                                                                        {
                                                                            var queryToken = $"INSERT INTO DisparoPesquisaSatisfacao (IdPesquisa, IdContato, Modulo, IdModulo, Token, Data) VALUES ({idPesquisa}, {dvContato[0]["Id"].ToString()}, '{table}', {drWkf["IdUser"].ToString()}, '', GETDATE()); SELECT @@IDENTITY;";
                                                                            var dvToken = new DataView(GVPFramework.RetornaDataTable(queryToken));

                                                                            var dvPesq = new DataView(GVPFramework.RetornaDataTable("SELECT Nome, Descricao, Alert FROM PesquisaSatisfacao WHERE Id = " + idPesquisa));

                                                                            var dvSurvey = new DataView(GVPFramework.RetornaDataTable($@"
                                                                                INSERT INTO WPSurvey (IdCliente, TransactionId, AttemptId, NameSurvey, SuccessMessage, DataCadastro)
                                                                                    VALUES ({dvContato[0]["Id"].ToString()}, {dvToken[0][0].ToString()}, {idPesquisa}, '{dvPesq[0]["Nome"].ToString().TextoParaQuery()}', '{dvPesq[0]["Alert"].ToString().TextoParaQuery()}', GETDATE())
                                                                                SELECT @@IDENTITY;
                                                                            "));

                                                                            var IdSurvey = dvSurvey[0][0].ToString();

                                                                            GVPFramework.ExecutaQuery($@"
                                                                                INSERT INTO WPSurveyQuestions 
                                                                                    SELECT {IdSurvey}, IdPropriedade, ISNULL(Ordem, 0), Questionario, ISNULL(TipoNPS, 0), NULL, NULL
                                                                                    FROM PesquisaSatisfacaoQuestionario(NOLOCK)
                                                                                    WHERE IdPesquisaSatisfacao = {idPesquisa}
                                                                            ");
                                                                        }
                                                                    }
                                                                    else
                                                                    {
                                                                        GVPFramework.ExecutaQuery($@"
                                                                            INSERT INTO EnvioTemplate (IdContato, Telefone, Template, DataDisparo, IdUsuario, Texto)
                                                                                VALUES ({dvContato[0]["Id"].ToString()}, '{to}', '{nomeTemplate}', GETDATE(), 1, N'{Texto.TextoParaQuery()}')
                                                                        ");
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    GVPFramework.ExecutaQuery($@"
                                                                        INSERT INTO EnvioTemplate (IdContato, Telefone, Template, DataDisparo, IdUsuario, Texto)
                                                                            VALUES ({dvContato[0]["Id"].ToString()}, '{numero}', '{nomeTemplate}', GETDATE(), 1, N'{Texto.TextoParaQuery()}')
                                                                    ");
                                                                }
                                                            }
                                                            else if (dvTemplate[0]["IdServidor"].ToString() == "5")
                                                            {
                                                                string base64Decoded = dvTemplate[0]["Email"].ToString() + ":" + dvTemplate[0]["Senha"].ToString();
                                                                byte[] data = System.Text.ASCIIEncoding.ASCII.GetBytes(base64Decoded);
                                                                var EncodedPass = Convert.ToBase64String(data);

                                                                var webHook = dvTemplate[0]["URL"].ToString();
                                                                var client = new RestClient(webHook + $"v1/users/login");
                                                                var request = new RestRequest(Method.POST);
                                                                request.AddHeader("Authorization", "Basic " + EncodedPass);

                                                                var response = client.Execute(request);
                                                                if (response.StatusCode.ToString() == "OK")
                                                                {
                                                                    var WhatsResponse = Newtonsoft.Json.JsonConvert.DeserializeObject<JObject>(response.Content);
                                                                    var token = WhatsResponse["users"][0]["token"].ToString();

                                                                    client = new RestClient(webHook + $"v1/contacts");
                                                                    request = new RestRequest(RestSharp.Method.POST);
                                                                    request.AddHeader("Authorization", "Bearer " + token);
                                                                    request.AddHeader("Content-type", "application/json");

                                                                    var TelefoneDeContato = to;
                                                                    if (TelefoneDeContato[0].ToString() != "5" && TelefoneDeContato[1].ToString() != "5")
                                                                        TelefoneDeContato = "55" + TelefoneDeContato;

                                                                    request.AddParameter("application/json", "{ \"blocking\": \"wait\", \"contacts\": [ \"+" + TelefoneDeContato + "\" ] }", RestSharp.ParameterType.RequestBody);

                                                                    response = client.Execute(request);
                                                                    if (response.StatusCode.ToString() == "OK")
                                                                    {
                                                                        WhatsResponse = Newtonsoft.Json.JsonConvert.DeserializeObject<JObject>(response.Content);
                                                                        if (WhatsResponse["contacts"][0]["status"].ToString() == "valid")
                                                                        {
                                                                            var numeroReal = WhatsResponse["contacts"][0]["wa_id"].ToString();

                                                                            client = new RestSharp.RestClient(webHook + $"v1/messages/");
                                                                            request = new RestSharp.RestRequest(RestSharp.Method.POST);
                                                                            request.AddHeader("Authorization", "Bearer " + token);
                                                                            request.AddHeader("Content-type", "application/json");

                                                                            request.AddParameter("application/json", "{\"to\": \"" + numeroReal + "\",\"type\": \"template\", \"template\": {\"namespace\": \"" + nameSpace + "\",\"name\": \"" + nomeTemplate + "\",\"language\": {\"policy\": \"deterministic\",\"code\": \"pt_BR\"}}}", RestSharp.ParameterType.RequestBody);

                                                                            response = client.Execute(request);
                                                                            if (response.StatusCode.ToString() == "OK" || response.StatusCode.ToString() == "Created")
                                                                            {
                                                                                WhatsResponse = Newtonsoft.Json.JsonConvert.DeserializeObject<JObject>(response.Content);

                                                                                GVPFramework.ExecutaQuery($@"
                                                                                    INSERT INTO EnvioTemplate (IdContato, Telefone, Template, DataDisparo, Token, IdUsuario, Texto)
                                                                                        VALUES ({dvContato[0]["Id"].ToString()}, '{TelefoneDeContato}', '{nomeTemplate}', GETDATE(), '{WhatsResponse["messages"][0]["id"].ToString().TextoParaQuery()}', 1, N'{Texto.TextoParaQuery()}')
                                                                                ");

                                                                                GVPFramework.AdicionaLinhaTempo(executaAcao[0]["IdConta"].ToString(), "1", dvContato[0]["Id"].ToString(), "3", Nome, "1");
                                                                            }
                                                                            else
                                                                            {
                                                                                GVPFramework.ExecutaQuery($@"
                                                                                    INSERT INTO EnvioTemplate (IdContato, Telefone, Template, DataDisparo, IdUsuario, Texto)
                                                                                        VALUES ({dvContato[0]["Id"].ToString()}, '{TelefoneDeContato}', '{nomeTemplate}', GETDATE(), 1, N'{Texto.TextoParaQuery()}')
                                                                                ");
                                                                            }
                                                                        }
                                                                        else
                                                                        {
                                                                            GVPFramework.ExecutaQuery($@"
                                                                                INSERT INTO EnvioTemplate (IdContato, Telefone, Template, DataDisparo, IdUsuario, Texto)
                                                                                    VALUES ({dvContato[0]["Id"].ToString()}, '{TelefoneDeContato}', '{nomeTemplate}', GETDATE(), 1, N'{Texto.TextoParaQuery()}')
                                                                            ");
                                                                        }
                                                                    }
                                                                    else
                                                                    {
                                                                        GVPFramework.ExecutaQuery($@"
                                                                            INSERT INTO EnvioTemplate (IdContato, Telefone, Template, DataDisparo, IdUsuario, Texto)
                                                                                VALUES ({dvContato[0]["Id"].ToString()}, '{TelefoneDeContato}', '{nomeTemplate}', GETDATE(), 1, N'{Texto.TextoParaQuery()}')
                                                                        ");
                                                                    }
                                                                }
                                                            }
                                                            else if (dvTemplate[0]["IdServidor"].ToString() == "7")
                                                            {
                                                                var URL = dvTemplate[0]["URL"].ToString();
                                                                var Numero = dvTemplate[0]["Numero"].ToString();
                                                                //  O envio de template vai ser igual a uma mensagem normal ... tem que ajustar o cadastro para que consiga trazer os parametros da forma correta

                                                                if (to != "")
                                                                {
                                                                    Texto = executaAcao[0]["Mensagem"].ToString();
                                                                    if (dinamicInputs.Count > 0)
                                                                    {
                                                                        int iTempTemplate = 0;
                                                                        foreach (JObject input in dinamicInputs)
                                                                        {
                                                                            if (input["index"].ToString() == iTempTemplate.ToString())
                                                                            {
                                                                                string[] separatingStrings = { "_dinamicParam_" };
                                                                                string[] words = input["nome"].ToString().Split(separatingStrings, System.StringSplitOptions.RemoveEmptyEntries);

                                                                                if (words.Length > 1)
                                                                                { 
                                                                                    var IdPropriedade = words[1].ToString();

                                                                                    var queryP = "SELECT Resposta FROM PropriedadeResposta WHERE IdUser = " + dvContato[0]["Id"].ToString() + " AND IdPropriedade = " + IdPropriedade;
                                                                                    var dvP = new DataView(GVPFramework.RetornaDataTable(queryP));

                                                                                    if (dvP.Count > 0)
                                                                                    {
                                                                                        Texto = Texto.Replace("{{" + (iTempTemplate + 1) + "}}", dvP[0][0].ToString() == "" ? "undefined" : dvP[0][0].ToString());
                                                                                    }
                                                                                    else
                                                                                    {
                                                                                        Texto = Texto.Replace("{{" + (iTempTemplate + 1) + "}}", "undefined");
                                                                                    }
                                                                                }
                                                                            }

                                                                            iTempTemplate++;
                                                                        }
                                                                    }

                                                                    var client = new RestClient(URL + "/message/button?key=" + Numero);
                                                                    var request = new RestRequest(Method.POST);

                                                                    if (buttons.Count > 0)
                                                                    {
                                                                        var jButtons = "";
                                                                        foreach (JObject button in buttons)
                                                                        {
                                                                            jButtons += (jButtons.Length > 0 ? ", " : "") + @"{""type"": ""replyButton"", ""title"": """ + button["nome"].ToString().Replace("\n", "\\n").Replace("\r\n", "\\n").Replace("<br>", "\\n") + @"""}";
                                                                        }

                                                                        client = new RestClient(URL + "/message/button?key=" + Numero);
                                                                        request.AddHeader("Content-Type", "application/json");
                                                                        var body = @"{   " + "\n" +
                                                                        @"    ""id"": """ + to + @"""," + "\n" +
                                                                        @"    ""btndata"": {" + "\n" +
                                                                        @"        ""text"": """ + Texto.Replace("\n", "\\n").Replace("\r\n", "\\n").Replace("<br>", "\\n") + @"""," + "\n" +
                                                                        @"        ""buttons"": [" + jButtons + @"]" + "\n" +
                                                                        @"    }" + "\n" +
                                                                        @"}";
                                                                        request.AddParameter("application/json", body, ParameterType.RequestBody);
                                                                    }
                                                                    else
                                                                    {
                                                                        client = new RestClient(URL + "/message/text?key=" + Numero);
                                                                        request.AddHeader("Content-Type", "application/x-www-form-urlencoded");
                                                                        request.AddParameter("id", to);
                                                                        request.AddParameter("message", Texto);
                                                                    }

                                                                    IRestResponse response = client.Execute(request);

                                                                    if (response.StatusCode.ToString() == "OK" || response.StatusCode.ToString() == "Created")
                                                                    {
                                                                        var WhatsResponse = Newtonsoft.Json.JsonConvert.DeserializeObject<JObject>(response.Content);

                                                                        GVPFramework.ExecutaQuery($@"
                                                                            INSERT INTO EnvioTemplate (IdContato, Telefone, Template, DataDisparo, Token, IdUsuario, Texto)
                                                                                VALUES ({dvContato[0]["Id"].ToString()}, '{to}', '{nomeTemplate}', GETDATE(), '{WhatsResponse["data"]["key"]["id"].ToString().TextoParaQuery()}', 1, '{Texto.TextoParaQuery()}')
                                                                        ");

                                                                        GVPFramework.AdicionaLinhaTempo(executaAcao[0]["IdConta"].ToString(), "1", dvContato[0]["Id"].ToString(), "3", Nome, "1");

                                                                        if (isPesquisaSatisfacao)
                                                                        {
                                                                            var queryToken = $"INSERT INTO DisparoPesquisaSatisfacao (IdPesquisa, IdContato, Modulo, IdModulo, Token, Data) VALUES ({idPesquisa}, {dvContato[0]["Id"].ToString()}, '{table}', {drWkf["IdUser"].ToString()}, '', GETDATE()); SELECT @@IDENTITY;";
                                                                            var dvToken = new DataView(GVPFramework.RetornaDataTable(queryToken));

                                                                            //var dvPesq = new DataView(GVPFramework.RetornaDataTable("SELECT Nome, Descricao, Alert FROM PesquisaSatisfacao WHERE Id = " + idPesquisa));

                                                                            //var dvSurvey = new DataView(GVPFramework.RetornaDataTable($@"
                                                                            //    INSERT INTO WPSurvey (IdCliente, TransactionId, AttemptId, NameSurvey, SuccessMessage, DataCadastro)
                                                                            //        VALUES ({dvContato[0]["Id"].ToString()}, {dvToken[0][0].ToString()}, {idPesquisa}, '{dvPesq[0]["Nome"].ToString().TextoParaQuery()}', '{dvPesq[0]["Alert"].ToString().TextoParaQuery()}', GETDATE())
                                                                            //    SELECT @@IDENTITY;
                                                                            //"));

                                                                            //var IdSurvey = dvSurvey[0][0].ToString();

                                                                            //GVPFramework.ExecutaQuery($@"
                                                                            //    INSERT INTO WPSurveyQuestions 
                                                                            //        SELECT {IdSurvey}, IdPropriedade, ISNULL(Ordem, 0), Questionario, ISNULL(TipoNPS, 0), NULL, NULL
                                                                            //        FROM PesquisaSatisfacaoQuestionario(NOLOCK)
                                                                            //        WHERE IdPesquisaSatisfacao = {idPesquisa}
                                                                            //");
                                                                        }                                                                            
                                                                    }
                                                                    else
                                                                    {
                                                                        GVPFramework.ExecutaQuery($@"
                                                                            INSERT INTO EnvioTemplate (IdContato, Telefone, Template, DataDisparo, IdUsuario)
                                                                                VALUES ({dvContato[0]["Id"].ToString()}, '{to}', '{nomeTemplate}', GETDATE(), 1)
                                                                        ");
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    GVPFramework.ExecutaQuery($@"
                                                                        INSERT INTO EnvioTemplate (IdContato, Telefone, Template, DataDisparo, IdUsuario)
                                                                            VALUES ({dvContato[0]["Id"].ToString()}, '{numero}', '{nomeTemplate}', GETDATE(), 1)
                                                                    ");
                                                                }
                                                            }

                                                            dvContato.RowFilter = "";
                                                        }
                                                    }
                                                }
                                            }

                                            #endregion
                                        }
                                        else if (executaAcao[0]["IdTipoAcao"].ToString() == "2")
                                        {
                                            #region AcionaWebHook
                                            if (executaAcao[0]["Acao"].ToString() != "")
                                            {
                                                try
                                                {
                                                    var client = new RestSharp.RestClient(executaAcao[0]["Acao"].ToString());
                                                    var request = new RestSharp.RestRequest(RestSharp.Method.POST);
                                                    var dadosJson = getPropriedadesByUser(executaAcao[0]["IdConta"].ToString(), executaAcao[0]["IdModulo"].ToString(), drWkf["IdUser"].ToString());
                                                    client.Timeout = 10000;
                                                    request.AddHeader("Content-Type", "application/json");
                                                    request.AddParameter("application/json", dadosJson, RestSharp.ParameterType.RequestBody);
                                                    
                                                    var response = client.Execute(request);

                                                    if (response.StatusCode.ToString() == "0")
                                                    {
                                                        GVPFramework.ExecutaQuery("INSERT INTO Danger (Local, Erro, Data) VALUES ('Workflow Service', 'Erro de timeout ao enviar dados para a API " + executaAcao[0]["Acao"].ToString() + "', GETDATE())");
                                                    }
                                                    else if (response.StatusCode.ToString() == "BadRequest")
                                                    {
                                                        if (executaAcao[0]["Acao"].ToString().Contains("api/Ticket/IntegrarSCCD"))
                                                        {
                                                            client = new RestSharp.RestClient(executaAcao[0]["Acao"].ToString());
                                                            request = new RestSharp.RestRequest(RestSharp.Method.POST);
                                                            dadosJson = getDadosSimplesByUser(executaAcao[0]["IdConta"].ToString(), executaAcao[0]["IdModulo"].ToString(), drWkf["IdUser"].ToString());
                                                            client.Timeout = 10000;
                                                            request.AddHeader("Content-Type", "application/json");
                                                            request.AddParameter("application/json", dadosJson, RestSharp.ParameterType.RequestBody);

                                                            response = client.Execute(request);
                                                        }
                                                        else if (executaAcao[0]["Acao"].ToString().Contains("Intermediary"))
                                                        {
                                                            client = new RestSharp.RestClient(executaAcao[0]["Acao"].ToString());
                                                            request = new RestSharp.RestRequest(RestSharp.Method.POST);
                                                            dadosJson = getDadosSimplesByUser(executaAcao[0]["IdConta"].ToString(), executaAcao[0]["IdModulo"].ToString(), drWkf["IdUser"].ToString());
                                                            client.Timeout = 10000;
                                                            request.AddHeader("Content-Type", "application/json");
                                                            request.AddParameter("application/json", dadosJson, RestSharp.ParameterType.RequestBody);

                                                            response = client.Execute(request);
                                                        }
                                                    }
                                                }
                                                catch (Exception)
                                                {

                                                }
                                            }
                                            #endregion
                                        }
                                        else if (executaAcao[0]["IdTipoAcao"].ToString() == "3")
                                        {
                                            #region AbreTicket
                                            var dvCampos = new DataView(GVPFramework.RetornaDataTable("SELECT IdCampo, Campo, Valor FROM WorkflowGatilhosAcoes (NOLOCK) WHERE IdGatilho = " + drWkf["IdGatilho"].ToString()));

                                            if (dvCampos.Count > 0)
                                            {
                                                var model = "";
                                                var table = "";

                                                if (executaAcao[0]["IdModulo"].ToString() == "1") { model = "Contato"; table = "Contato"; }
                                                else if (executaAcao[0]["IdModulo"].ToString() == "2") { model = "Empresa"; table = "Empresa"; }
                                                else if (executaAcao[0]["IdModulo"].ToString() == "4") { model = "Negócio"; table = "Oportunidade"; }
                                                else if (executaAcao[0]["IdModulo"].ToString() == "5") { model = "Ligação"; table = "Telefone"; }
                                                else if (executaAcao[0]["IdModulo"].ToString() == "6") { model = "Ticket"; table = "Ticket"; }
                                                else if (executaAcao[0]["IdModulo"].ToString() == "9") { model = "Tarefa"; table = "Tarefa"; }
                                                else if (executaAcao[0]["IdModulo"].ToString() == "10") { model = "Chat"; table = "Chat"; }
                                                else if (executaAcao[0]["IdModulo"].ToString() == "11") { model = "Email"; table = "Email"; }
                                                else if (executaAcao[0]["IdModulo"].ToString() == "12") { model = "WhatsApp"; table = "WhatsApp"; }
                                                else if (executaAcao[0]["IdModulo"].ToString() == "17") { model = "Atributo"; table = "Atributo"; }

                                                query = $@"
                                                    INSERT INTO Ticket (IdConta, DataCriacao, IdModulo, Modulo) 
                                                    VALUES ({executaAcao[0]["IdConta"].ToString()}, GETDATE(), {drWkf["IdUser"].ToString()}, '{model}'); 
                                                    SELECT @@IDENTITY;
                                                ";

                                                var dvNewTicket = new DataView(GVPFramework.RetornaDataTable(query));
                                                var idNewTicket = dvNewTicket[0][0].ToString();

                                                var queryInsertProperties = "";
                                                var updatesOnTikcet = $"Token = '{idNewTicket.PadLeft(3, '0')}', IdProprietario = (SELECT IdProprietario FROM {table}(NOLOCK) WHERE Id = {drWkf["IdUser"].ToString()})";
                                                var filaUpdate = "";
                                                var nomeFila = "";

                                                if (model == "Contato")
                                                    updatesOnTikcet += $", IdContato = {drWkf["IdUser"].ToString()}";
                                                else if (model != "Empresa")
                                                    updatesOnTikcet += $", IdContato = (SELECT IdContato FROM {table}(NOLOCK) WHERE Id = {drWkf["IdUser"].ToString()})";

                                                foreach (DataRowView campos in dvCampos)
                                                {
                                                    if (campos["IdCampo"].ToString() != "" && campos["IdCampo"].ToString() != "-1")
                                                        queryInsertProperties += (queryInsertProperties.Length > 0 ? ", " : "") + $"({campos["IdCampo"].ToString()}, {idNewTicket}, '{campos["Valor"].ToString().TextoParaQuery()}', GETDATE())";
                                                    else
                                                    {
                                                        if (campos["Campo"].ToString() == "Fila")
                                                        {
                                                            var dvFila = new DataView(GVPFramework.RetornaDataTable($"SELECT Id FROM Fila(NOLOCK) WHERE IdConta = {executaAcao[0]["IdConta"].ToString()} AND Nome = '{campos["Valor"].ToString().TextoParaQuery()}'"));
                                                            if (dvFila.Count > 0)
                                                            {
                                                                var idProprietarioByFilaId = GVPFramework.ReturnProprietarioByFilaId(dvFila[0][0].ToString(), executaAcao[0]["IdConta"].ToString());

                                                                if (idProprietarioByFilaId != "")
                                                                {
                                                                    filaUpdate += $"IdProprietario = {idProprietarioByFilaId}, IdFila = {dvFila[0][0].ToString()}";
                                                                    nomeFila = campos["Valor"].ToString();
                                                                }
                                                            }
                                                        }
                                                        else if (campos["Campo"].ToString() == "Status")
                                                        {
                                                            var dvStatus = new DataView(GVPFramework.RetornaDataTable($"SELECT Id FROM PipelineTicket(NOLOCK) WHERE IdConta = {executaAcao[0]["IdConta"].ToString()} AND Nome = '{campos["Valor"].ToString().TextoParaQuery()}'"));
                                                            if (dvStatus.Count > 0)
                                                            {
                                                                updatesOnTikcet += $", IdPipelineTicket = {dvStatus[0][0].ToString()}";
                                                                GVPFramework.ExecutaQuery($"INSERT INTO TicketSLA (IdTicket, IdStatus, IdUsuarioCadastro, DataCadastro) VALUES ({idNewTicket}, {dvStatus[0][0].ToString()}, 1, GETDATE())");
                                                            }
                                                        }
                                                    }
                                                }

                                                if (queryInsertProperties.Length > 0)
                                                    GVPFramework.ExecutaQuery("INSERT INTO PropriedadeResposta (IdPropriedade, IdUser, Resposta, DataResposta) VALUES " + queryInsertProperties);
                                                if (updatesOnTikcet.Length > 0)
                                                    GVPFramework.ExecutaQuery("UPDATE Ticket SET " + updatesOnTikcet + " WHERE Id = " + idNewTicket);

                                                if (filaUpdate.Length > 0)
                                                {
                                                    GVPFramework.ExecutaQuery("UPDATE Ticket SET " + filaUpdate + " WHERE Id = " + idNewTicket);
                                                    GVPFramework.AdicionaLinhaTempo(executaAcao[0]["IdConta"].ToString(), "6", idNewTicket, "1", "Ticket cadastrado a partir da trilha do workflow " + executaAcao[0]["Nome"].ToString() + ". <br>Proprietário selecionado a partir da regra da fila " + nomeFila + ".", "1", DateTime.Now.AddHours(3).ToString("yyyy-MM-dd HH:mm:ss"));
                                                }
                                                else
                                                {
                                                    GVPFramework.AdicionaLinhaTempo(executaAcao[0]["IdConta"].ToString(), "6", idNewTicket, "1", "Ticket cadastrado a partir da trilha do workflow " + executaAcao[0]["Nome"].ToString() + ".", "1", DateTime.Now.AddHours(3).ToString("yyyy-MM-dd HH:mm:ss"));
                                                }

                                                GVPFramework.AdicionaLinhaTempo(executaAcao[0]["IdConta"].ToString(), "6", idNewTicket, "1", "Código: <b>" + "TKT" + drWkf["IdUser"].ToString().PadLeft(3, '0') + "</b>.", "1", DateTime.Now.AddHours(3).ToString("yyyy-MM-dd HH:mm:ss"));

                                                var wkfTarefa = new JObject();
                                                wkfTarefa.Add("IdConta", executaAcao[0]["IdConta"].ToString());
                                                wkfTarefa.Add("IdUser", idNewTicket);
                                                wkfTarefa.Add("IdModulo", "6");
                                                wkfTarefa.Add("Tipo", "IsCreate");

                                                GVPFramework.SetWorkflow(wkfTarefa);
                                            }
                                            #endregion
                                        }
                                        else if (executaAcao[0]["IdTipoAcao"].ToString() == "1")
                                        {
                                            #region AlteraDados
                                            var dvCampos = new DataView(GVPFramework.RetornaDataTable("SELECT IdCondicao, IdCampo, Campo, Valor FROM WorkflowGatilhosAcoes WHERE IdGatilho = " + drWkf["IdGatilho"].ToString()));

                                            if (dvCampos.Count > 0)
                                            {
                                                var statusTable = "";
                                                var idStatus = "";
                                                var table = "";

                                                if (executaAcao[0]["IdModulo"].ToString() == "1") { statusTable = "PipelineContato"; table = "Contato"; idStatus = "IdPipelineContato"; }
                                                else if (executaAcao[0]["IdModulo"].ToString() == "2") { statusTable = "PipelineEmpresa"; table = "Empresa"; idStatus = "IdPipelineEmpresa"; }
                                                else if (executaAcao[0]["IdModulo"].ToString() == "4") { statusTable = "OportunidadeEtapa"; table = "Oportunidade"; idStatus = "IdOportunidadeEtapa"; }
                                                else if (executaAcao[0]["IdModulo"].ToString() == "5") { statusTable = "PipelineTelefone"; table = "Telefone"; idStatus = "IdPipelineTelefone"; }
                                                else if (executaAcao[0]["IdModulo"].ToString() == "6") { statusTable = "PipelineTicket"; table = "Ticket"; idStatus = "IdPipelineTicket"; }
                                                else if (executaAcao[0]["IdModulo"].ToString() == "9") { statusTable = "PipelineTarefa"; table = "Tarefa"; idStatus = "IdPipelineTarefa"; }
                                                else if (executaAcao[0]["IdModulo"].ToString() == "10") { statusTable = "StatusChat"; table = "Chat"; idStatus = "IdStatus"; }
                                                else if (executaAcao[0]["IdModulo"].ToString() == "11") { statusTable = "PipelineEmail"; table = "Email"; idStatus = "IdPipelineEmail"; }
                                                else if (executaAcao[0]["IdModulo"].ToString() == "12") { statusTable = "StatusWhatsApp"; table = "WhatsApp"; idStatus = "IdStatus"; }
                                                else if (executaAcao[0]["IdModulo"].ToString() == "17") { statusTable = "PropriedadeGrupo"; table = "Atributo"; idStatus = "IdGrupo"; }

                                                var IdContatoParaAlterar = "";
                                                var updatesOnTable = "";
                                                var InsertMaluko = new JArray();
                                                var UpdateMaluko = new JArray();
                                                var alteracao = string.Empty;

                                                foreach (DataRowView campos in dvCampos)
                                                {
                                                    if (campos["IdCondicao"].ToString() == "Contato")
                                                    {
                                                        if (executaAcao[0]["IdModulo"].ToString() == "1")
                                                            IdContatoParaAlterar = drWkf["IdUser"].ToString();
                                                        else
                                                            IdContatoParaAlterar = $"(SELECT IdContato FROM {table} WHERE Id = {drWkf["IdUser"].ToString()})";
                                                    }

                                                    if (campos["IdCampo"].ToString() != "" && campos["IdCampo"].ToString() != "-1")
                                                    {
                                                        if (campos["IdCondicao"].ToString() == "Contato")
                                                        {
                                                            if (executaAcao[0]["IdModulo"].ToString() == "1")
                                                            {
                                                                var consulta = new DataView(GVPFramework.RetornaDataTable($"SELECT Id FROM PropriedadeResposta (NOLOCK) WHERE IdPropriedade = {campos["IdCampo"].ToString()} AND IdUser = {drWkf["IdUser"].ToString()}"));
                                                                if (consulta.Count > 0)
                                                                {
                                                                    UpdateMaluko.Add($"UPDATE PropriedadeResposta SET Resposta = '{campos["Valor"].ToString().TextoParaQuery()}', DataResposta = GETDATE() WHERE Id = {consulta[0][0].ToString()}");
                                                                }
                                                                else
                                                                {
                                                                    InsertMaluko.Add($"INSERT INTO PropriedadeResposta (IdPropriedade, IdUser, Resposta, DataResposta) VALUES ({campos["IdCampo"].ToString()}, {drWkf["IdUser"].ToString()}, '{campos["Valor"].ToString().TextoParaQuery()}', GETDATE())");
                                                                }
                                                            }
                                                            else
                                                            {
                                                                var consulta = new DataView(GVPFramework.RetornaDataTable($"SELECT Id FROM PropriedadeResposta (NOLOCK) WHERE IdPropriedade = {campos["IdCampo"].ToString()} AND IdUser = (SELECT IdContato FROM {table} WHERE Id = {drWkf["IdGatilho"].ToString()})"));
                                                                if (consulta.Count > 0)
                                                                {
                                                                    UpdateMaluko.Add($"UPDATE PropriedadeResposta SET Resposta = '{campos["Valor"].ToString().TextoParaQuery()}', DataResposta = GETDATE() WHERE Id = (SELECT IdContato FROM {table} WHERE Id = {drWkf["IdGatilho"].ToString()})");
                                                                }
                                                                else
                                                                {
                                                                    InsertMaluko.Add($"INSERT INTO PropriedadeResposta (IdPropriedade, IdUser, Resposta, DataResposta) VALUES ({campos["IdCampo"].ToString()}, (SELECT IdContato FROM {table} WHERE Id = {drWkf["IdGatilho"].ToString()}), '{campos["Valor"].ToString().TextoParaQuery()}', GETDATE())");
                                                                }
                                                            }
                                                        }
                                                        else
                                                        {
                                                            var consulta = new DataView(GVPFramework.RetornaDataTable($"SELECT Id FROM PropriedadeResposta (NOLOCK) WHERE IdPropriedade = {campos["IdCampo"].ToString()} AND IdUser = {drWkf["IdUser"].ToString()}"));
                                                            if (consulta.Count > 0)
                                                            {
                                                                UpdateMaluko.Add($"UPDATE PropriedadeResposta SET Resposta = '{campos["Valor"].ToString().TextoParaQuery()}', DataResposta = GETDATE() WHERE Id = {consulta[0][0].ToString()}");
                                                            }
                                                            else
                                                            {
                                                                InsertMaluko.Add($"INSERT INTO PropriedadeResposta (IdPropriedade, IdUser, Resposta, DataResposta) VALUES ({campos["IdCampo"].ToString()}, {drWkf["IdUser"].ToString()}, '{campos["Valor"].ToString().TextoParaQuery()}', GETDATE())");
                                                            }
                                                        }
                                                    }
                                                    else
                                                    {
                                                        if (campos["Campo"].ToString() == "Fila")
                                                        {
                                                            if (executaAcao[0]["IdModulo"].ToString() != "17")
                                                            {
                                                                var dvFila = new DataView(GVPFramework.RetornaDataTable($"SELECT Id FROM Fila WHERE IdConta = {executaAcao[0]["IdConta"].ToString()} AND Nome = '{campos["Valor"].ToString().TextoParaQuery()}'"));
                                                                if (dvFila.Count > 0)
                                                                {
                                                                    var idProprietarioByFilaId = GVPFramework.ReturnProprietarioByFilaId(dvFila[0][0].ToString(), executaAcao[0]["IdConta"].ToString());

                                                                    if (idProprietarioByFilaId != "")
                                                                    {
                                                                        updatesOnTable += (updatesOnTable.Length > 0 ? ", " : "") + $"IdProprietario = {idProprietarioByFilaId}, IdFila = {dvFila[0][0].ToString()}";
                                                                    }
                                                                }
                                                            }
                                                        }
                                                        else if (campos["Campo"].ToString() == "Status")
                                                        {
                                                            if (executaAcao[0]["IdModulo"].ToString() != "17")
                                                            {
                                                                var dvStatus = new DataView(GVPFramework.RetornaDataTable($"SELECT Id FROM {statusTable} WHERE IdConta = {executaAcao[0]["IdConta"].ToString()} AND Nome = '{campos["Valor"].ToString().TextoParaQuery()}'"));
                                                                if (dvStatus.Count > 0)
                                                                {
                                                                    updatesOnTable += (updatesOnTable.Length > 0 ? ", " : "") + $"{idStatus} = {dvStatus[0][0].ToString()}";

                                                                    if (campos["Valor"].ToString().ToLower() == "concluído" || campos["Valor"].ToString().ToLower() == "concluido")
                                                                    { 
                                                                        if (executaAcao[0]["IdModulo"].ToString() == "6" || executaAcao[0]["IdModulo"].ToString() == "11")
                                                                            updatesOnTable += (updatesOnTable.Length > 0 ? ", " : "") + $"DataConclusao = GETDATE() ";
                                                                    }

                                                                    if (executaAcao[0]["IdModulo"].ToString() != "10" && executaAcao[0]["IdModulo"].ToString() != "12")
                                                                    {
                                                                        if (campos["IdCondicao"].ToString() == "Contato")
                                                                        {
                                                                            if (executaAcao[0]["IdModulo"].ToString() == "1")
                                                                            {
                                                                                if (executaAcao[0]["IdModulo"].ToString() == "4")
                                                                                {
                                                                                    GVPFramework.ExecutaQuery($"DELETE FROM {table}SLA WHERE Id{table} = " + drWkf["IdUser"].ToString());
                                                                                    GVPFramework.ExecutaQuery($"INSERT INTO {table}SLA (Id{table}, IdEtapa, IdUsuarioCadastro, DataCadastro) VALUES ({drWkf["IdUser"].ToString()}, {dvStatus[0][0].ToString()}, 1, GETDATE())");
                                                                                }
                                                                                else
                                                                                {
                                                                                    GVPFramework.ExecutaQuery($"DELETE FROM {table}SLA WHERE Id{table} = " + drWkf["IdUser"].ToString());
                                                                                    GVPFramework.ExecutaQuery($"INSERT INTO {table}SLA (Id{table}, IdStatus, IdUsuarioCadastro, DataCadastro) VALUES ({drWkf["IdUser"].ToString()}, {dvStatus[0][0].ToString()}, 1, GETDATE())");
                                                                                }
                                                                            }
                                                                            else
                                                                            {
                                                                                if (executaAcao[0]["IdModulo"].ToString() == "4")
                                                                                {
                                                                                    GVPFramework.ExecutaQuery($"DELETE FROM {table}SLA WHERE Id{table} = (SELECT IdContato FROM {table} WHERE Id = {drWkf["IdGatilho"].ToString()})");
                                                                                    GVPFramework.ExecutaQuery($"INSERT INTO {table}SLA (Id{table}, IdEtapa, IdUsuarioCadastro, DataCadastro) VALUES ((SELECT IdContato FROM {table} WHERE Id = {drWkf["IdGatilho"].ToString()}), {dvStatus[0][0].ToString()}, 1, GETDATE())");
                                                                                }
                                                                                else
                                                                                {
                                                                                    GVPFramework.ExecutaQuery($"DELETE FROM {table}SLA WHERE Id{table} = (SELECT IdContato FROM {table} WHERE Id = {drWkf["IdGatilho"].ToString()})");
                                                                                    GVPFramework.ExecutaQuery($"INSERT INTO {table}SLA (Id{table}, IdStatus, IdUsuarioCadastro, DataCadastro) VALUES ((SELECT IdContato FROM {table} WHERE Id = {drWkf["IdGatilho"].ToString()}), {dvStatus[0][0].ToString()}, 1, GETDATE())");
                                                                                }
                                                                            }
                                                                        }
                                                                        else
                                                                        {
                                                                            if (executaAcao[0]["IdModulo"].ToString() == "4")
                                                                            {
                                                                                GVPFramework.ExecutaQuery($"DELETE FROM {table}SLA WHERE Id{table} = " + drWkf["IdUser"].ToString());
                                                                                GVPFramework.ExecutaQuery($"INSERT INTO {table}SLA (Id{table}, IdEtapa, IdUsuarioCadastro, DataCadastro) VALUES ({drWkf["IdUser"].ToString()}, {dvStatus[0][0].ToString()}, 1, GETDATE())");
                                                                            }
                                                                            else
                                                                            {
                                                                                GVPFramework.ExecutaQuery($"DELETE FROM {table}SLA WHERE Id{table} = " + drWkf["IdUser"].ToString());
                                                                                GVPFramework.ExecutaQuery($"INSERT INTO {table}SLA (Id{table}, IdStatus, IdUsuarioCadastro, DataCadastro) VALUES ({drWkf["IdUser"].ToString()}, {dvStatus[0][0].ToString()}, 1, GETDATE())");
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                        else if (campos["Campo"].ToString() == "Data de conclusão")
                                                        {
                                                            updatesOnTable += (updatesOnTable.Length > 0 ? ", " : "") + $"DataConclusao = GETDATE() ";
                                                        }
                                                        else if (campos["Campo"].ToString() == "Pasta")
                                                        {
                                                            var dvStatus = new DataView(GVPFramework.RetornaDataTable($"SELECT Id FROM EmailStatus WHERE Nome = '{campos["Valor"].ToString().TextoParaQuery()}'"));
                                                            if (dvStatus.Count > 0)
                                                            {
                                                                updatesOnTable += (updatesOnTable.Length > 0 ? ", " : "") + $"IdStatus = {dvStatus[0][0].ToString()}";
                                                            }
                                                        }
                                                    }

                                                    var atividade = table == "Telefone" ? "Ligação" : table;

                                                    alteracao += (alteracao.Length > 0 ? "</br>" : "") + "WorkFlow:" + executaAcao[0]["Nome"].ToString() + " alterou o campo " + campos["Campo"].ToString() + $" do {atividade} para <b>" + (campos["Valor"].ToString() ?? string.Empty).Replace("'", "''") + "</b>.";

                                                }

                                                GVPFramework.AdicionaLinhaTempo(executaAcao[0]["IdConta"].ToString(), executaAcao[0]["IdModulo"].ToString(), drWkf["IdUser"].ToString(), "3", alteracao, "1");

                                                if (IdContatoParaAlterar.Length > 0)
                                                {
                                                    GVPFramework.ExecutaQuery($"UPDATE Contato SET {updatesOnTable}, DataAlteracao = GETDATE() WHERE Id = {IdContatoParaAlterar}");

                                                    var wkfTarefa = new JObject();
                                                    wkfTarefa.Add("IdConta", executaAcao[0]["IdConta"].ToString());
                                                    wkfTarefa.Add("IdUser", IdContatoParaAlterar);
                                                    wkfTarefa.Add("IdModulo", "1");
                                                    wkfTarefa.Add("Tipo", "IsUpdate");

                                                    GVPFramework.SetWorkflow(wkfTarefa);
                                                }

                                                if (IdContatoParaAlterar != drWkf["IdUser"].ToString())
                                                {
                                                    if (updatesOnTable.Length > 0)
                                                    {
                                                        GVPFramework.ExecutaQuery($"UPDATE {table} SET {updatesOnTable}, DataAlteracao = GETDATE() WHERE Id = " + drWkf["IdUser"].ToString());

                                                        var wkfTarefa = new JObject();
                                                        wkfTarefa.Add("IdConta", executaAcao[0]["IdConta"].ToString());
                                                        wkfTarefa.Add("IdUser", drWkf["IdUser"].ToString());
                                                        wkfTarefa.Add("IdModulo", executaAcao[0]["IdModulo"].ToString());
                                                        wkfTarefa.Add("Tipo", "IsUpdate");

                                                        GVPFramework.SetWorkflow(wkfTarefa);
                                                    }
                                                }

                                                foreach (var item in InsertMaluko)
                                                {
                                                    GVPFramework.ExecutaQuery(item.ToString());
                                                }
                                                foreach (var item in UpdateMaluko)
                                                {
                                                    GVPFramework.ExecutaQuery(item.ToString());
                                                }
                                            }

                                            #endregion
                                        }
                                        else if (executaAcao[0]["IdTipoAcao"].ToString() == "7")
                                        {
                                            #region SLA

                                            var idSla = executaAcao[0]["Acao"].ToString();

                                            var regraSla = new DataView(GVPFramework.RetornaDataTable($@"
                                                SELECT Id
                                                FROM NivelServico (NOLOCK) 
                                                WHERE Id = {idSla}
                                                    AND IdConta = {executaAcao[0]["IdConta"].ToString()} 
                                                    AND IdModulo = {executaAcao[0]["IdModulo"].ToString()}
                                                    AND Ativo = 1 
                                            ")).ToTable();

                                            if (regraSla.Rows.Count > 0)
                                            {
                                                var idUser = drWkf["IdUser"].ToString();

                                                new Sla().ExecutarRegraSla(idUser, idSla);
                                            }

                                            #endregion
                                        }
                                        else if (executaAcao[0]["IdTipoAcao"].ToString() == "9")
                                        {
                                            #region EncerraSLA

                                            var idSla = executaAcao[0]["Acao"].ToString();

                                            var queryUpdateSLA = $@"
                                                UPDATE NivelServicoJornada SET DataFim = GETDATE()
                                                WHERE DataFim IS NULL 
                                                    AND IdModulo = {executaAcao[0]["IdModulo"].ToString()}
                                                    AND IdNivelServico = {executaAcao[0]["Acao"].ToString()}
                                                    AND Modulo = {drWkf["IdUser"].ToString()}
                                            ";
                                            GVPFramework.ExecutaQuery(queryUpdateSLA);

                                            #endregion
                                        }
                                        else if (executaAcao[0]["IdTipoAcao"].ToString() == "8")
                                        {
                                            #region MandaPesquisaViaWhatsApp

                                            ServicePointManager.ServerCertificateValidationCallback += (senders, certificate, chain, sslPolicyErrors) => true;

                                            var queryDadosWP = $@"SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
                                                SELECT WhatsApp.IdContato, GrupoWhatsApp.Email, GrupoWhatsApp.Senha, WhatsApp.Number, IdServidor, Id360, GrupoWhatsApp.Token, GrupoWhatsApp.IdServidor, 
                                                    ISNULL(Telefone.Resposta, '') Telefone, ISNULL(Celular.Resposta, '') Celular, URL, GrupoWhatsApp.Token, GrupoWhatsApp.Numero
                                                FROM WhatsApp
                                                    INNER JOIN GrupoWhatsApp ON GrupoWhatsApp.Id = WhatsApp.IdGrupoWhatsApp
	                                                LEFT JOIN PropriedadeResposta Telefone ON Telefone.IdUser = WhatsApp.IdContato AND Telefone.IdPropriedade = (
		                                                SELECT Id FROM Propriedade WHERE Nome = 'Telefone' AND IdConta = WhatsApp.IdConta AND IdPropriedadeGrupo IN (
			                                                SELECT Id FROM PropriedadeGrupo WHERE IdConta = WhatsApp.IdConta AND IdTipoCadastro = 1
		                                                )
	                                                )
	                                                LEFT JOIN PropriedadeResposta Celular ON Celular.IdUser = WhatsApp.IdContato AND Celular.IdPropriedade = (
		                                                SELECT Id FROM Propriedade WHERE Nome = 'Celular' AND IdConta = WhatsApp.IdConta AND IdPropriedadeGrupo IN (
			                                                SELECT Id FROM PropriedadeGrupo WHERE IdConta = WhatsApp.IdConta AND IdTipoCadastro = 1
		                                                )
	                                                )
                                                WHERE WhatsApp.Id = {drWkf["IdUser"].ToString()}
                                            ";
                                            var dvDadosWP = new DataView(GVPFramework.RetornaDataTable(queryDadosWP));

                                            var TelefoneDeContato = (dvDadosWP[0]["Celular"].ToString() != "" ? dvDadosWP[0]["Celular"].ToString() : dvDadosWP[0]["Telefone"].ToString() != "" ? dvDadosWP[0]["Telefone"].ToString() : dvDadosWP[0]["Number"].ToString()).Replace("(", "").Replace(")", "").Replace(" ", "").Replace("-", "").Replace("+55", "");
                                            if (TelefoneDeContato != "" || TelefoneDeContato != null)
                                            {
                                                var TokenWhatsApp = "";

                                                if (TelefoneDeContato[0].ToString() != "5" && TelefoneDeContato[1].ToString() != "5")
                                                {
                                                    var dvConfirmSala = new DataView(GVPFramework.RetornaDataTable($@"SELECT COUNT(Id) FROM WhatsApp (NOLOCK) WHERE Number = '{TelefoneDeContato}'"));

                                                    if (dvConfirmSala.Count == 0)
                                                    {
                                                        TelefoneDeContato = "55" + TelefoneDeContato;
                                                    }
                                                }
                                                    

                                                var dvPesq = new DataView(GVPFramework.RetornaDataTable("SELECT Nome, Descricao, Alert FROM PesquisaSatisfacao WHERE Id = " + executaAcao[0]["Acao"].ToString()));

                                                if (dvDadosWP[0]["IdServidor"].ToString() == "6")
                                                {
                                                    var json = "{ \"messaging_product\": \"whatsapp\", \"preview_url\": \"false\", \"recipient_type\": \"individual\", \"to\": \"" + TelefoneDeContato + "\", \"type\": \"interactive\", \"interactive\": { \"type\": \"button\", \"body\": { \"text\": \"" + dvPesq[0]["Descricao"].ToString().Replace("\\n", "\n") + "\" }, \"action\": { \"buttons\": [ { \"type\": \"reply\", \"reply\": { \"id\": 1, \"title\": \"Sim\" } }, { \"type\": \"reply\", \"reply\": { \"id\": 0, \"title\": \"Não\" } } ]}}}";

                                                    var client = new RestClient("https://graph.facebook.com/v13.0/" + dvDadosWP[0]["Id360"].ToString() + "/messages/");
                                                    var request = new RestRequest(Method.POST);
                                                    request.AddHeader("Authorization", "Bearer " + dvDadosWP[0]["Token"].ToString());
                                                    request.AddHeader("Content-Type", "application/json");
                                                    request.AddParameter("application/json", json, ParameterType.RequestBody);
                                                    var response = client.Execute(request);

                                                    if (response.StatusCode.ToString() == "OK" || response.StatusCode.ToString() == "Created")
                                                    {
                                                        var WhatsResponse = Newtonsoft.Json.JsonConvert.DeserializeObject<JObject>(response.Content);
                                                        TokenWhatsApp = WhatsResponse["messages"][0]["id"].ToString();
                                                    }
                                                }
                                                else if (dvDadosWP[0]["IdServidor"].ToString() == "7")
                                                {
                                                    var client = new RestClient(dvDadosWP[0]["URL"].ToString() + "/message/button?key=" + dvDadosWP[0]["Numero"].ToString());
                                                    var request = new RestRequest(Method.POST);
                                                    request.AddHeader("Content-Type", "application/json");

                                                    var jButtons = @"{""type"": ""replyButton"", ""title"": ""Sim""}";
                                                    jButtons += (jButtons.Length > 0 ? ", " : "") + @"{""type"": ""replyButton"", ""title"": ""Não""}";

                                                    var body = @"{   " + "\n" +
                                                    @"    ""id"": """ + TelefoneDeContato + @"""," + "\n" +
                                                    @"    ""btndata"": {" + "\n" +
                                                    @"        ""text"": """ + dvPesq[0]["Descricao"].ToString().Replace("\n", "\\n").Replace("\r\n", "\\n").Replace("<br>", "\\n") + @"""," + "\n" +
                                                    @"        ""buttons"": [" + jButtons + @"]" + "\n" +
                                                    @"    }" + "\n" +
                                                    @"}";

                                                    request.AddParameter("application/json", body, ParameterType.RequestBody);
                                                    var response = client.Execute(request);

                                                    if (response.StatusCode.ToString() == "OK" || response.StatusCode.ToString() == "Created")
                                                    {
                                                        var WhatsResponse = Newtonsoft.Json.JsonConvert.DeserializeObject<JObject>(response.Content);
                                                        TokenWhatsApp = WhatsResponse["data"]["key"]["id"].ToString();
                                                    }
                                                }

                                                if (TokenWhatsApp.Length > 0)
                                                {
                                                    var queryToken = $"INSERT INTO DisparoPesquisaSatisfacao (IdPesquisa, IdContato, Modulo, IdModulo, Token, Data) VALUES ({executaAcao[0]["Acao"].ToString()}, {dvDadosWP[0]["IdContato"].ToString()}, 'WhatsApp', {drWkf["IdUser"].ToString()}, '{TokenWhatsApp.TextoParaQuery()}', GETDATE()); SELECT @@IDENTITY;";
                                                    var dvToken = new DataView(GVPFramework.RetornaDataTable(queryToken));

                                                    var dvSurvey = new DataView(GVPFramework.RetornaDataTable($@"
                                                        INSERT INTO WPSurvey (IdCliente, TransactionId, AttemptId, NameSurvey, SuccessMessage, DataCadastro)
                                                            VALUES ({dvDadosWP[0]["IdContato"].ToString()}, {dvToken[0][0].ToString()}, {executaAcao[0]["Acao"].ToString()}, '{dvPesq[0]["Nome"].ToString().TextoParaQuery()}', '{dvPesq[0]["Alert"].ToString().TextoParaQuery()}', GETDATE())
                                                        SELECT @@IDENTITY;
                                                    "));

                                                    var IdSurvey = dvSurvey[0][0].ToString();

                                                    GVPFramework.ExecutaQuery($@"
                                                        INSERT INTO WPSurveyQuestions 
                                                            SELECT {IdSurvey}, IdPropriedade, ISNULL(Ordem, 0), Questionario, ISNULL(TipoNPS, 0), NULL, NULL
                                                            FROM PesquisaSatisfacaoQuestionario(NOLOCK)
                                                            WHERE IdPesquisaSatisfacao = {executaAcao[0]["Acao"].ToString()}
                                                    ");
                                                }
                                            }

                                            #endregion
                                        }
                                        #endregion
                                    }

                                    GVPFramework.ExecutaQuery("UPDATE WorkflowReguaGatilhos SET IsConcluido = 1 WHERE Id = " + drWkf["Id"].ToString());

                                    //  CHAMA PRÓXIMO GATILHO OU FINALIZA WORKFLOW

                                    if (passaCondicao)
                                    {
                                        query = $@"
                                        SELECT TOP 1 Id 
                                        FROM WorkflowGatilhos (NOLOCK)
                                        WHERE IdWorkflow = {drWkf["IdWorkflow"].ToString()}
                                            AND Id > {drWkf["IdGatilho"].ToString()}
                                        ORDER BY Id ASC
                                    ";

                                        var dvWorkflowGatilhos = new DataView(GVPFramework.RetornaDataTable(query));

                                        if (dvWorkflowGatilhos.Count > 0)
                                        {
                                            query = $@"
                                            INSERT INTO WorkflowReguaGatilhos (IdRegua, IdGatilho, IsConcluido, DataExecucao)
                                            VALUES ({drWkf["IdRegua"].ToString()}, {dvWorkflowGatilhos[0]["Id"].ToString()}, 0, {(isTimeout ? "'" + dateTimeout.ToString("yyyy-MM-dd HH:mm:ss") + "'" : "GETDATE()")})
                                        ";
                                            GVPFramework.ExecutaQuery(query);
                                        }
                                        else
                                        {
                                            GVPFramework.ExecutaQuery("UPDATE WorkflowRegua SET IdStatus = 2 WHERE Id = " + drWkf["IdRegua"].ToString());
                                        }
                                    }
                                    else
                                    {
                                        GVPFramework.ExecutaQuery("UPDATE WorkflowRegua SET IdStatus = 2 WHERE Id = " + drWkf["IdRegua"].ToString());
                                    }
                                }
                            }
                        }
                        #endregion

                        iTemp++;
                        Application.DoEvents();
                    }
                }
                else
                {
                    foreach (DataRowView dr in dv)
                    {
                        var strSplit = dr["UTCOFFSET"].ToString().Split(':');
                        var TimeZoneValue = double.Parse(strSplit[0] + "." + strSplit[1]);

                        lblContaLength.Text = iTemp + "/" + dv.Count;

                        lblStatus.Text = "Notify da conta " + dr["Id"].ToString();
                        Application.DoEvents();
                        #region Notify
                        query = $@"
	                            SELECT 'Tarefa' Tipo, 9 IdModulo, Tarefa.Id, Tarefa.Nome, Tarefa.StartDatetime, TarefaAlerta.Nome, Tarefa.Alerta, Tarefa.IdProprietario, Usuario.Nome, Usuario.Email 
	                            FROM vwTarefa({dr["Id"].ToString()}) Tarefa
		                            INNER JOIN Usuario(NOLOCK) ON Usuario.Id = Tarefa.IdProprietario
		                            INNER JOIN TarefaAlerta(NOLOCK) ON TarefaAlerta.Id = Tarefa.Alerta
		                            INNER JOIN PipelineTarefa Status(NOLOCK) ON Status.Id = Tarefa.IdPipelineTarefa
	                            WHERE Tarefa.Id NOT IN (SELECT IdUser FROM Notify(NOLOCK) WHERE IdModulo = 9 AND IdUsuarioNotificacao = Tarefa.IdProprietario AND IdUser = Tarefa.Id) 
		                            AND DATEADD(DAY, -1, Tarefa.StartDatetime) <= GETDATE()
                                    AND Tarefa.StartDatetime > '2024-02-18 00:00:00.000'
                            UNION ALL
	                            SELECT 'Telefone', 5 IdModulo, Ligacao.Id, Ligacao.Nome, Ligacao.StartDatetime, TarefaAlerta.Nome, Ligacao.Alerta, Ligacao.IdProprietario , Usuario.Nome, Usuario.Email
	                            FROM vwTelefone({dr["Id"].ToString()}) Ligacao
		                            INNER JOIN Usuario(NOLOCK) ON Usuario.Id = Ligacao.IdProprietario
		                            INNER JOIN TarefaAlerta(NOLOCK) ON TarefaAlerta.Id = Ligacao.Alerta
		                            INNER JOIN PipelineTelefone(NOLOCK) Status ON Status.Id = Ligacao.IdPipelineTelefone
	                            WHERE Ligacao.Id NOT IN (SELECT IdUser FROM Notify(NOLOCK) WHERE IdModulo = 5 AND IdUsuarioNotificacao = Ligacao.IdProprietario AND IdUser = Ligacao.Id) 
		                            AND DATEADD(DAY, -1, Ligacao.StartDatetime) <= GETDATE()
                                    AND Ligacao.StartDatetime > '2024-02-18 00:00:00.000'
                            ORDER BY StartDatetime
                        ";

                        var dvTarefas = new DataView(GVPFramework.RetornaDataTable(isWorkFlowService ? "" : query));

                        if (dvTarefas.Count > 0)
                        {
                            pbEnvio.Value = 0;
                            pbEnvio.Maximum = dv.Count;

                            foreach (DataRowView tarefa in dvTarefas)
                            {
                                try
                                {
                                    pbEnvio.Value++;
                                }
                                catch (Exception)
                                {

                                }

                                var minuteAdd = int.Parse(alertaArray[int.Parse(tarefa["Alerta"].ToString()) - 1].ToString()) * -1;
                                var DataNotificacao = DateTime.Parse(tarefa["StartDatetime"].ToString()).AddMinutes(minuteAdd);

                                query = $@"
                                    INSERT INTO Notify (IdTipoNotificacao, IdModulo, IdUser, IdUsuarioNotificacao, DataNotificacao, DataCadastro, Ativo)
                                    VALUES (1, {tarefa["IdModulo"].ToString()}, {tarefa["Id"].ToString()}, {tarefa["IdProprietario"].ToString()}, '{DataNotificacao.ToString("yyyy-MM-dd HH:mm")}', GETDATE(), 1)
                                ";

                                GVPFramework.ExecutaQuery(query);
                            }
                        }
                        #endregion
                        lblStatus.Text = "DerrubaContatoInativo da conta " + dr["Id"].ToString();
                        Application.DoEvents();
                        #region DerrubaContatoInativo
                        query = $@"
	                        SELECT Id
	                        FROM ChatMonitoramento (NOLOCK)
	                        WHERE Id IN (SELECT IdCHatMonitoramento FROM Chat (NOLOCK) WHERE ISNULL(IdProprietario, 1) = 1 AND IdStatus IN (1, 13, 14))
		                        AND IsOnline = 1   
		                        AND GETDATE() > DATEADD(MINUTE, 3, ISNULL(DataAlteracao, DataCadastro))                 
                        ";

                        var dvDerrubaContatoInativo = new DataView(GVPFramework.RetornaDataTable(isWorkFlowService ? "" : query));

                        if (dvDerrubaContatoInativo.Count > 0)
                        {
                            foreach (DataRowView caras in dvDerrubaContatoInativo)
                            {
                                GVPFramework.ExecutaQuery("UPDATE ChatMonitoramento SET IsOnline = 0, IP = IP + ' service' WHERE Id = " + caras["Id"].ToString());
                                GVPFramework.ExecutaQuery("UPDATE Chat SET IdStatus = 8, DataConclusao = (SELECT ISNULL(DataAlteracao, GETDATE()) FROM ChatMonitoramento(NOLOCK) WHERE Id = Chat.IdChatMonitoramento) WHERE IdStatus = 1 AND IdProprietario IS NULL AND IdChatMonitoramento = " + caras["Id"].ToString());
                            }
                        }

                        query = $@"ProcChatMonitoramentoInativo";


                        dvDerrubaContatoInativo = new DataView(GVPFramework.RetornaDataTable(isWorkFlowService ? "" : query));

                        if (dvDerrubaContatoInativo.Count > 0)
                        {
                            foreach (DataRowView caras in dvDerrubaContatoInativo)
                            {
                                GVPFramework.ExecutaQuery("UPDATE ChatMonitoramento SET IsOnline = 0, IP = IP + ' service' WHERE Id = " + caras["Id"].ToString());
                                GVPFramework.ExecutaQuery("UPDATE Chat SET IdStatus = 7, DataConclusao = (SELECT ISNULL(DataAlteracao, GETDATE()) FROM ChatMonitoramento(NOLOCK) WHERE Id = Chat.IdChatMonitoramento) WHERE IdStatus = 1 AND IdProprietario IS NOT NULL AND IdChatMonitoramento = " + caras["Id"].ToString());
                            }
                        }

                        query = $@"
                            SELECT Id
                            FROM Chat (NOLOCK)
                            WHERE IdProprietario > 1
	                            AND IdStatus IN (7)
	                            AND IdConta = {dr["Id"].ToString()}
	                            AND GETDATE() > DATEADD(HOUR, 11, ISNULL(DataConclusao, DataCriacao))
                        ";

                        var dvDerrubaChatAntigo = new DataView(GVPFramework.RetornaDataTable(isWorkFlowService ? "" : query));

                        if (dvDerrubaChatAntigo.Count > 0)
                        {
                            foreach (DataRowView caras in dvDerrubaChatAntigo)
                            {
                                GVPFramework.ExecutaQuery("UPDATE Chat SET IdStatus = 3, DataConclusao = GETDATE() WHERE Id = " + caras["Id"].ToString());
                            }
                        }

                        #endregion
                        lblStatus.Text = "DerrubaUsuarioInativo da conta " + dr["Id"].ToString();
                        Application.DoEvents();
                        #region DerrubaUsuarioInativo
                        query = $@"
                            SELECT Usuario.Id, CASE WHEN DATEADD(MINUTE, 10, DataStatus) > GETDATE() THEN 1 ELSE 0 END AS Status 
                            FROM Usuario (NOLOCK) 
	                            INNER JOIN UsuarioFilaStatus (NOLOCK)  ON UsuarioFilaStatus.Id = Usuario.IdStatus
                            WHERE Usuario.IdConta = {dr["Id"].ToString()}
	                             AND UsuarioFilaStatus.Id <> 3
                        ";

                        var dvDerrubaUsuarioInativo = new DataView(GVPFramework.RetornaDataTable(isWorkFlowService ? "" : query));
                        if (dvDerrubaUsuarioInativo.Count > 0)
                        {
                            foreach (DataRowView caras in dvDerrubaUsuarioInativo)
                            {
                                if (caras["Status"].ToString() == "0")
                                {
                                    GVPFramework.ExecutaQuery($"DELETE FROM PrePausa WHERE IdUsuario = {caras["Id"].ToString()}");

                                    var dvFilas = new DataView(GVPFramework.RetornaDataTable($@"
			                            SELECT UsuarioFila.Id, UsuarioFila.IdStatus, UsuarioFila.IdFila, UsuarioFilaStatus.IsOnline
			                            FROM UsuarioFila (NOLOCK)
				                            INNER JOIN UsuarioFilaStatus(NOLOCK) ON UsuarioFilaStatus.Id = UsuarioFila.IdStatus
			                            WHERE UsuarioFila.IdUsuario = {caras["Id"].ToString()}
				                            AND UsuarioFilaStatus.IsOnline = 1"));

                                    foreach (DataRowView fila in dvFilas)
                                    {
                                        GVPFramework.ExecutaQuery($"UPDATE GestaoPausa SET DataFim = GETDATE() WHERE IdFila = {fila["IdFila"].ToString()} AND IdUsuario = {caras["Id"].ToString()} AND DataFim IS NULL");
                                        GVPFramework.ExecutaQuery($@"
                                            INSERT INTO GestaoPausa (IdUsuario, IdFila, IdStatus, DataInicio)
                                            VALUES ({caras["Id"].ToString()}, {fila["IdFila"].ToString()}, 3, GETDATE())
                                        ");
                                    }

                                    GVPFramework.ExecutaQuery($"UPDATE UsuarioFila SET IdStatus = 3, IdUsuarioAlteracao = {caras["Id"].ToString()}, DataAlteracao = GETDATE() WHERE IdUsuario = {caras["Id"].ToString()}");
                                    GVPFramework.ExecutaQuery($"UPDATE Usuario SET IdStatus = 3, DataStatus = GETDATE() WHERE Id = {caras["Id"].ToString()}");

                                    GVPFramework.ExecutaQuery($"INSERT INTO LOG_HISACS (IdAcesso, Historico, DataHistorico) VALUES ((SELECT TOP 1 Id FROM LOG_USRACS (NOLOCK) WHERE IdUsuario = {caras["Id"].ToString()} ORDER BY Id DESC), 'Sistema derrubou usuário do sistema.', GETDATE())");

                                    query = $@"
                                        SELECT UsuarioFilaTelefonia.Id, IdPbx fila, Usuario.UserPBX agent
                                        FROM UsuarioFilaTelefonia(NOLOCK)
	                                        INNER JOIN FilaTelefonia(NOLOCK) ON FilaTelefonia.Id = UsuarioFilaTelefonia.IdFila
	                                        INNER JOIN Usuario (NOLOCK) ON Usuario.Id = UsuarioFilaTelefonia.IdUsuario
                                        WHERE FilaTelefonia.IdConta = {dr["Id"].ToString()}
	                                        AND UsuarioFilaTelefonia.IdUsuario = {caras["Id"].ToString()}
                                    ";
                                    var dvFilaUsuario = new System.Data.DataView(GVPFramework.RetornaDataTable(query));

                                    foreach (System.Data.DataRowView drFilaUsuario in dvFilaUsuario)
                                    {
                                        var command = "";

                                        command += String.Format(
                                            "Action: QueueRemove\r\n" +
                                            "Queue: {0}\r\n" +
                                            "Interface: {1}\r\n\r\n",
                                        drFilaUsuario["fila"].ToString(), "SIP/" + drFilaUsuario["agent"].ToString());

                                        //command += String.Format(
                                        //    "Action: QueueRemove\r\n" +
                                        //    "Queue: {0}\r\n" +
                                        //    "Interface: {1}\r\n\r\n",
                                        //drFilaUsuario["fila"].ToString(), "Local/" + drFilaUsuario["agent"].ToString() + "@from-queue/n");

                                        GVPFramework.ExecutaQuery($"INSERT INTO Command VALUES ('{command}', {caras["Id"].ToString()}, GETDATE(), NULL, NULL);");
                                        GVPFramework.ExecutaQuery($"UPDATE UsuarioFilaTelefonia SET IdStatus = 0, DataStatus = GETDATE() WHERE Id = {drFilaUsuario["Id"].ToString()}");
                                    }
                                }
                            }
                        }
                        #endregion
                        lblStatus.Text = "DerrubaMessengerAntigo da conta " + dr["Id"].ToString();
                        Application.DoEvents();
                        #region DerrubaMessengerAntigo
                        query = $@"
                            SELECT Id
                            FROM Messenger (NOLOCK)
                            WHERE IdStatus IN (1)
	                            AND IdConta = {dr["Id"].ToString()}
	                            AND GETDATE() > DATEADD(HOUR, 24, DataCriacao)
                        ";

                        var dvDerrubaMessengerAntigo = new DataView(GVPFramework.RetornaDataTable(isWorkFlowService ? "" : query));

                        if (dvDerrubaMessengerAntigo.Count > 0)
                        {
                            foreach (DataRowView caras in dvDerrubaMessengerAntigo)
                            {
                                GVPFramework.ExecutaQuery("UPDATE Messenger SET IdStatus = 3, DataConclusao = GETDATE() WHERE Id = " + caras["Id"].ToString());
                            }
                        }
                        #endregion
                        lblStatus.Text = "SLA da conta " + dr["Id"].ToString();
                        Application.DoEvents();
                        #region SLA
                        //#region Empresa
                        //query = $@"
                        //    SELECT Tabela.Id, Tabela.Nome, Tabela.ItemDangerColor StatusAtual,
                        //     SLA.DataCadastro, DATEADD(HOUR, Status.TempoSLA, SLA.DataCadastro) AS Data
                        //    FROM vwEmpresa({dr["Id"].ToString()}) Tabela
                        //     INNER JOIN EmpresaSLA SLA ON SLA.IdEmpresa = Tabela.Id
                        //     INNER JOIN PipelineEmpresa Status ON Status.Id = SLA.IdStatus
                        //    WHERE SLA.DataCadastro > '2020-02-18 00:00:00.000'
                        //     AND DATEADD(HOUR, Status.TempoSLA, SLA.DataCadastro) <= GETDATE()
                        //     AND ISNULL(Tabela.ItemDangerColor, '') NOT IN ('SLA', 'Ambos')
                        //";
                        //var dvSLA = new DataView(GVPFramework.RetornaDataTable(query));
                        //foreach (DataRowView item in dvSLA)
                        //{
                        //    GVPFramework.ExecutaQuery("UPDATE Empresa SET ItemDangerColor = '" + (item["StatusAtual"].ToString() == "" ? "SLA" : "Ambos") + "' WHERE Id = " + item["Id"].ToString());
                        //    GVPFramework.AdicionaLinhaTempo(dr["Id"].ToString(), "2", item["Id"].ToString(), "4", "SLA da etapa da empresa foi ultrapassado!", "1", DateTime.Parse(item["Data"].ToString()).ToString("yyyy-MM-dd HH:mm"));
                        //}
                        //#endregion
                        //#region Contato
                        //query = $@"
                        //    SELECT Tabela.Id, Tabela.Nome, Tabela.ItemDangerColor StatusAtual,
                        //     SLA.DataCadastro, DATEADD(HOUR, Status.TempoSLA, SLA.DataCadastro) AS Data,
                        //        Empresa.Id AS IdEmpresa, Empresa.ItemDangerColor StatusEmpresa
                        //    FROM vwContato({dr["Id"].ToString()}) Tabela
                        //     INNER JOIN ContatoSLA SLA ON SLA.IdContato = Tabela.Id
                        //     INNER JOIN PipelineContato Status ON Status.Id = SLA.IdStatus
                        //     LEFT JOIN vwEmpresa({dr["Id"].ToString()}) Empresa ON Empresa.Id = Tabela.IdEmpresa
                        //    WHERE SLA.DataCadastro > '2020-02-18 00:00:00.000'
                        //     AND DATEADD(HOUR, Status.TempoSLA, SLA.DataCadastro) <= GETDATE()
                        //     AND ISNULL(Tabela.ItemDangerColor, '') NOT IN ('SLA', 'Ambos')
                        //";
                        //dvSLA = new DataView(GVPFramework.RetornaDataTable(query));
                        //foreach (DataRowView item in dvSLA)
                        //{
                        //    GVPFramework.ExecutaQuery("UPDATE Contato SET ItemDangerColor = '" + (item["StatusAtual"].ToString() == "" ? "SLA" : "Ambos") + "' WHERE Id = " + item["Id"].ToString());
                        //    GVPFramework.AdicionaLinhaTempo(dr["Id"].ToString(), "1", item["Id"].ToString(), "4", "SLA da etapa do contato foi ultrapassado!", "1", DateTime.Parse(item["Data"].ToString()).ToString("yyyy-MM-dd HH:mm"));

                        //    if (item["IdEmpresa"].ToString() != "" && item["StatusEmpresa"].ToString() != "Ambos" && item["StatusEmpresa"].ToString() != "Tarefa")
                        //        GVPFramework.ExecutaQuery("UPDATE Empresa SET ItemDangerColor = '" + (item["StatusEmpresa"].ToString() == "" ? "Tarefa" : "Ambos") + "' WHERE Id = " + item["IdEmpresa"].ToString());
                        //}
                        //#endregion

                        //#region Oportunidade
                        //query = $@"
                        //    SELECT Tabela.Id, Tabela.Nome, Tabela.ItemDangerColor StatusAtual,
                        //     SLA.DataCadastro, DATEADD(HOUR, Status.TempoSLA, SLA.DataCadastro) AS Data,
                        //        Contato.Id AS IdContato, Contato.ItemDangerColor StatusContato,
                        //        IdModulo, Modulo
                        //    FROM vwOportunidade({dr["Id"].ToString()}) Tabela
                        //     INNER JOIN OportunidadeSLA SLA ON SLA.IdOportunidade = Tabela.Id
                        //     INNER JOIN OportunidadeEtapa Status ON Status.Id = SLA.IdEtapa
                        //     LEFT JOIN vwContato({dr["Id"].ToString()}) Contato ON Contato.Id = Tabela.IdContato
                        //    WHERE SLA.DataCadastro > '2020-02-18 00:00:00.000'
                        //     AND DATEADD(HOUR, Status.TempoSLA, SLA.DataCadastro) <= GETDATE()
                        //     AND ISNULL(Tabela.ItemDangerColor, '') NOT IN ('SLA', 'Ambos')
                        //";
                        //dvSLA = new DataView(GVPFramework.RetornaDataTable(query));
                        //foreach (DataRowView item in dvSLA)
                        //{
                        //    GVPFramework.ExecutaQuery("UPDATE Oportunidade SET ItemDangerColor = '" + (item["StatusAtual"].ToString() == "" ? "SLA" : "Ambos") + "' WHERE Id = " + item["Id"].ToString());
                        //    GVPFramework.AdicionaLinhaTempo(dr["Id"].ToString(), "4", item["Id"].ToString(), "4", "SLA da etapa do negócio foi ultrapassado!", "1", DateTime.Parse(item["Data"].ToString()).ToString("yyyy-MM-dd HH:mm"));

                        //    if (item["IdContato"].ToString() != "" && item["StatusContato"].ToString() != "Ambos" && item["StatusContato"].ToString() != "Tarefa")
                        //        GVPFramework.ExecutaQuery("UPDATE Contato SET ItemDangerColor = '" + (item["StatusContato"].ToString() == "" ? "Tarefa" : "Ambos") + "' WHERE Id = " + item["IdContato"].ToString());

                        //    if (item["IdModulo"].ToString() != "" && item["Modulo"].ToString() != "")
                        //    {
                        //        var table = item["Modulo"].ToString() == "Negócio" ? "Oportunidade" :
                        //            item["Modulo"].ToString() == "Ligação" ? "Telefone" :
                        //            item["Modulo"].ToString() == "Ticket" ? "Ticket" :
                        //            item["Modulo"].ToString() == "Tarefa" ? "Tarefa" :
                        //            item["Modulo"].ToString() == "Email" ? "Email" : "";
                        //        GVPFramework.ExecutaQuery("UPDATE " + table + " SET ItemDangerColor = CASE WHEN ISNULL(ItemDangerColor, '') = '' THEN 'Tarefa' ELSE 'Ambos' END WHERE ISNULL(ItemDangerColor, '') NOT IN ('Ambos', 'Tarefa') AND Id = " + item["IdModulo"].ToString());
                        //    }
                        //}
                        //#endregion
                        //#region Telefone
                        //query = $@"
                        //    SELECT Tabela.Id, Tabela.Nome, Tabela.ItemDangerColor StatusAtual,
                        //     SLA.DataCadastro, DATEADD(HOUR, Status.TempoSLA, SLA.DataCadastro) AS Data,
                        //        Contato.Id AS IdContato, Contato.ItemDangerColor StatusContato,
                        //        IdModulo, Modulo
                        //    FROM vwTelefone({dr["Id"].ToString()}) Tabela
                        //     INNER JOIN TelefoneSLA SLA ON SLA.IdTelefone = Tabela.Id
                        //     INNER JOIN PipelineTelefone Status ON Status.Id = SLA.IdStatus
                        //     LEFT JOIN vwContato({dr["Id"].ToString()}) Contato ON Contato.Id = Tabela.IdContato
                        //    WHERE SLA.DataCadastro > '2020-02-18 00:00:00.000'
                        //     AND DATEADD(HOUR, Status.TempoSLA, SLA.DataCadastro) <= GETDATE()
                        //     AND ISNULL(Tabela.ItemDangerColor, '') NOT IN ('SLA', 'Ambos')
                        //";
                        //dvSLA = new DataView(GVPFramework.RetornaDataTable(query));
                        //foreach (DataRowView item in dvSLA)
                        //{
                        //    GVPFramework.ExecutaQuery("UPDATE Telefone SET ItemDangerColor = '" + (item["StatusAtual"].ToString() == "" ? "SLA" : "Ambos") + "' WHERE Id = " + item["Id"].ToString());
                        //    GVPFramework.AdicionaLinhaTempo(dr["Id"].ToString(), "5", item["Id"].ToString(), "4", "SLA da etapa da ligação foi ultrapassado!", "1", DateTime.Parse(item["Data"].ToString()).ToString("yyyy-MM-dd HH:mm"));

                        //    if (item["IdContato"].ToString() != "" && item["StatusContato"].ToString() != "Ambos" && item["StatusContato"].ToString() != "Tarefa")
                        //        GVPFramework.ExecutaQuery("UPDATE Contato SET ItemDangerColor = '" + (item["StatusContato"].ToString() == "" ? "Tarefa" : "Ambos") + "' WHERE Id = " + item["IdContato"].ToString());

                        //    if (item["IdModulo"].ToString() != "" && item["Modulo"].ToString() != "")
                        //    {
                        //        var table = item["Modulo"].ToString() == "Negócio" ? "Oportunidade" :
                        //            item["Modulo"].ToString() == "Ligação" ? "Telefone" :
                        //            item["Modulo"].ToString() == "Ticket" ? "Ticket" :
                        //            item["Modulo"].ToString() == "Tarefa" ? "Tarefa" :
                        //            item["Modulo"].ToString() == "Email" ? "Email" : "";
                        //        GVPFramework.ExecutaQuery("UPDATE " + table + " SET ItemDangerColor = CASE WHEN ISNULL(ItemDangerColor, '') = '' THEN 'Tarefa' ELSE 'Ambos' END WHERE ISNULL(ItemDangerColor, '') NOT IN ('Ambos', 'Tarefa') AND Id = " + item["IdModulo"].ToString());
                        //    }
                        //}
                        //#endregion
                        //#region Ticket
                        //query = $@"
                        //    SELECT Tabela.Id, Tabela.Nome, Tabela.ItemDangerColor StatusAtual,
                        //     SLA.DataCadastro, DATEADD(HOUR, Status.TempoSLA, SLA.DataCadastro) AS Data,
                        //        Contato.Id AS IdContato, Contato.ItemDangerColor StatusContato,
                        //        IdModulo, Modulo
                        //    FROM vwTicket({dr["Id"].ToString()}) Tabela
                        //     INNER JOIN TicketSLA SLA ON SLA.IdTicket = Tabela.Id
                        //     INNER JOIN PipelineTicket Status ON Status.Id = SLA.IdStatus
                        //     LEFT JOIN vwContato({dr["Id"].ToString()}) Contato ON Contato.Id = Tabela.IdContato
                        //    WHERE SLA.DataCadastro > '2020-02-18 00:00:00.000'
                        //     AND DATEADD(HOUR, Status.TempoSLA, SLA.DataCadastro) <= GETDATE()
                        //     AND ISNULL(Tabela.ItemDangerColor, '') NOT IN ('SLA', 'Ambos')
                        //";
                        //dvSLA = new DataView(GVPFramework.RetornaDataTable(query));
                        //foreach (DataRowView item in dvSLA)
                        //{
                        //    GVPFramework.ExecutaQuery("UPDATE Ticket SET ItemDangerColor = '" + (item["StatusAtual"].ToString() == "" ? "SLA" : "Ambos") + "' WHERE Id = " + item["Id"].ToString());
                        //    GVPFramework.AdicionaLinhaTempo(dr["Id"].ToString(), "6", item["Id"].ToString(), "4", "SLA da etapa do ticket foi ultrapassado!", "1", DateTime.Parse(item["Data"].ToString()).ToString("yyyy-MM-dd HH:mm"));

                        //    if (item["IdContato"].ToString() != "" && item["StatusContato"].ToString() != "Ambos" && item["StatusContato"].ToString() != "Tarefa")
                        //        GVPFramework.ExecutaQuery("UPDATE Contato SET ItemDangerColor = '" + (item["StatusContato"].ToString() == "" ? "Tarefa" : "Ambos") + "' WHERE Id = " + item["IdContato"].ToString());

                        //    if (item["IdModulo"].ToString() != "" && item["Modulo"].ToString() != "")
                        //    {
                        //        var table = item["Modulo"].ToString() == "Negócio" ? "Oportunidade" :
                        //            item["Modulo"].ToString() == "Ligação" ? "Telefone" :
                        //            item["Modulo"].ToString() == "Ticket" ? "Ticket" :
                        //            item["Modulo"].ToString() == "Tarefa" ? "Tarefa" :
                        //            item["Modulo"].ToString() == "Email" ? "Email" : "";
                        //        GVPFramework.ExecutaQuery("UPDATE " + table + " SET ItemDangerColor = CASE WHEN ISNULL(ItemDangerColor, '') = '' THEN 'Tarefa' ELSE 'Ambos' END WHERE ISNULL(ItemDangerColor, '') NOT IN ('Ambos', 'Tarefa') AND Id = " + item["IdModulo"].ToString());
                        //    }
                        //}
                        //#endregion
                        //#region Tarefa
                        //query = $@"
                        //    SELECT Tabela.Id, Tabela.Nome, Tabela.ItemDangerColor StatusAtual,
                        //     SLA.DataCadastro, DATEADD(HOUR, Status.TempoSLA, SLA.DataCadastro) AS Data,
                        //        Contato.Id AS IdContato, Contato.ItemDangerColor StatusContato,
                        //        IdModulo, Modulo
                        //    FROM vwTarefa({dr["Id"].ToString()}) Tabela
                        //     INNER JOIN TarefaSLA SLA ON SLA.IdTarefa = Tabela.Id
                        //     INNER JOIN PipelineTarefa Status ON Status.Id = SLA.IdStatus
                        //     LEFT JOIN vwContato({dr["Id"].ToString()}) Contato ON Contato.Id = Tabela.IdContato
                        //    WHERE SLA.DataCadastro > '2020-02-18 00:00:00.000'
                        //     AND DATEADD(HOUR, Status.TempoSLA, SLA.DataCadastro) <= GETDATE()
                        //     AND ISNULL(Tabela.ItemDangerColor, '') NOT IN ('SLA', 'Ambos')
                        //";
                        //dvSLA = new DataView(GVPFramework.RetornaDataTable(query));
                        //foreach (DataRowView item in dvSLA)
                        //{
                        //    GVPFramework.ExecutaQuery("UPDATE Tarefa SET ItemDangerColor = '" + (item["StatusAtual"].ToString() == "" ? "SLA" : "Ambos") + "' WHERE Id = " + item["Id"].ToString());
                        //    GVPFramework.AdicionaLinhaTempo(dr["Id"].ToString(), "9", item["Id"].ToString(), "4", "SLA da etapa da tarefa foi ultrapassado!", "1", DateTime.Parse(item["Data"].ToString()).ToString("yyyy-MM-dd HH:mm"));

                        //    if (item["IdContato"].ToString() != "" && item["StatusContato"].ToString() != "Ambos" && item["StatusContato"].ToString() != "Tarefa")
                        //        GVPFramework.ExecutaQuery("UPDATE Contato SET ItemDangerColor = '" + (item["StatusContato"].ToString() == "" ? "Tarefa" : "Ambos") + "' WHERE Id = " + item["IdContato"].ToString());

                        //    if (item["IdModulo"].ToString() != "" && item["Modulo"].ToString() != "")
                        //    {
                        //        var table = item["Modulo"].ToString() == "Negócio" ? "Oportunidade" :
                        //            item["Modulo"].ToString() == "Ligação" ? "Telefone" :
                        //            item["Modulo"].ToString() == "Ticket" ? "Ticket" :
                        //            item["Modulo"].ToString() == "Tarefa" ? "Tarefa" :
                        //            item["Modulo"].ToString() == "Email" ? "Email" : "";
                        //        GVPFramework.ExecutaQuery("UPDATE " + table + " SET ItemDangerColor = CASE WHEN ISNULL(ItemDangerColor, '') = '' THEN 'Tarefa' ELSE 'Ambos' END WHERE ISNULL(ItemDangerColor, '') NOT IN ('Ambos', 'Tarefa') AND Id = " + item["IdModulo"].ToString());
                        //    }
                        //}
                        //#endregion
                        //#region Email
                        //query = $@"
                        //    SELECT Tabela.Id, Tabela.Nome, Tabela.ItemDangerColor StatusAtual,
                        //     SLA.DataCadastro, DATEADD(HOUR, Status.TempoSLA, SLA.DataCadastro) AS Data,
                        //        Contato.Id AS IdContato, Contato.ItemDangerColor StatusContato,
                        //        IdModulo, Modulo
                        //    FROM vwEmail({dr["Id"].ToString()}) Tabela
                        //     INNER JOIN EmailSLA SLA ON SLA.IdEmail = Tabela.Id
                        //     INNER JOIN PipelineEmail Status ON Status.Id = SLA.IdStatus
                        //     LEFT JOIN vwContato({dr["Id"].ToString()}) Contato ON Contato.Id = Tabela.IdContato
                        //    WHERE SLA.DataCadastro > '2020-02-18 00:00:00.000'
                        //     AND DATEADD(HOUR, Status.TempoSLA, SLA.DataCadastro) <= GETDATE()
                        //     AND ISNULL(Tabela.ItemDangerColor, '') NOT IN ('SLA', 'Ambos')
                        //";
                        //dvSLA = new DataView(GVPFramework.RetornaDataTable(query));
                        //foreach (DataRowView item in dvSLA)
                        //{
                        //    GVPFramework.ExecutaQuery("UPDATE Email SET ItemDangerColor = '" + (item["StatusAtual"].ToString() == "" ? "SLA" : "Ambos") + "' WHERE Id = " + item["Id"].ToString());
                        //    GVPFramework.AdicionaLinhaTempo(dr["Id"].ToString(), "9", item["Id"].ToString(), "4", "SLA da etapa do e-mail foi ultrapassado!", "1", DateTime.Parse(item["Data"].ToString()).ToString("yyyy-MM-dd HH:mm"));

                        //    if (item["IdContato"].ToString() != "" && item["StatusContato"].ToString() != "Ambos" && item["StatusContato"].ToString() != "Tarefa")
                        //        GVPFramework.ExecutaQuery("UPDATE Contato SET ItemDangerColor = '" + (item["StatusContato"].ToString() == "" ? "Tarefa" : "Ambos") + "' WHERE Id = " + item["IdContato"].ToString());

                        //    if (item["IdModulo"].ToString() != "" && item["Modulo"].ToString() != "")
                        //    {
                        //        var table = item["Modulo"].ToString() == "Negócio" ? "Oportunidade" :
                        //            item["Modulo"].ToString() == "Ligação" ? "Telefone" :
                        //            item["Modulo"].ToString() == "Ticket" ? "Ticket" :
                        //            item["Modulo"].ToString() == "Tarefa" ? "Tarefa" :
                        //            item["Modulo"].ToString() == "Email" ? "Email" : "";
                        //        GVPFramework.ExecutaQuery("UPDATE " + table + " SET ItemDangerColor = CASE WHEN ISNULL(ItemDangerColor, '') = '' THEN 'Tarefa' ELSE 'Ambos' END WHERE ISNULL(ItemDangerColor, '') NOT IN ('Ambos', 'Tarefa') AND Id = " + item["IdModulo"].ToString());
                        //    }
                        //}
                        //#endregion
                        #endregion
                        lblStatus.Text = "Pausas da conta " + dr["Id"].ToString();
                        Application.DoEvents();
                        #region Pausas
                        query = $@"
                            SELECT Usuario.Id, Usuario.Nome, UsuarioFilaStatus.Nome AS StatusNome, Usuario.DataStatus, ISNULL(IdDepartamento, 0) AS IdDepartamento,
	                            UsuarioFilaStatus.IsRetorno, UsuarioFilaStatus.Duracao, UsuarioFilaStatus.EmailNotification,
                                DATEADD(MINUTE, UsuarioFilaStatus.Duracao, Usuario.DataStatus) AS Data, GETDATE() AS aNow
                            FROM Usuario (NOLOCK)
	                            INNER JOIN UsuarioFilaStatus (NOLOCK) ON UsuarioFilaStatus.Id = Usuario.IdStatus
                            WHERE Usuario.IdConta = {dr["Id"].ToString()}
	                            AND UsuarioFilaStatus.IdConta = {dr["Id"].ToString()}
	                            AND UsuarioFilaStatus.Id > 4
	                            AND GETDATE() > DATEADD(MINUTE, UsuarioFilaStatus.Duracao, Usuario.DataStatus) 
                        ";

                        var dvPausas = new DataView(GVPFramework.RetornaDataTable(isWorkFlowService ? "" : query));

                        foreach (DataRowView drPausa in dvPausas)
                        {
                            if (drPausa["EmailNotification"].ToString() != "")
                            {
                                var msg = $@"
                                    A pausa do {drPausa["Nome"].ToString()} utrapassou o limite.<br>
                                    Ele entrou na pausa às {DateTime.Parse(drPausa["DataStatus"].ToString()).AddHours(TimeZoneValue).ToString("dd/MM/yyyy HH:mm")} 
                                    e a pausa é somente de {drPausa["Duracao"].ToString()} minuto(s).
                                ";

                                var dvEmailEnviado = new DataView(GVPFramework.RetornaDataTable($@"
                                    SELECT Id FROM FilaMensagem (NOLOCK)
                                    WHERE IdConta = {dr["Id"].ToString()}
                                        AND Email = '{drPausa["EmailNotification"].ToString().TextoParaQuery()}'
                                        AND Mensagem = '{msg}'
                                        AND Enviado = 1
                                "));

                                if (dvEmailEnviado.Count == 0)
                                {
                                    GVPFramework.EnviarEmail(msg, drPausa["EmailNotification"].ToString(), "Pausa extrapolada", dr["Id"].ToString());
                                }
                            }

                            if (drPausa["IsRetorno"].ToString() == "True")
                            {
                                query = $@"
                                    SELECT DISTINCT Nome, Fila.Id, ISNULL(IdDepartamento, 0) IdDepartamento, IsAtualizacaoManual, IsFilaAutomatica, IsRandomica, IsOnline, LoginOnline
                                    FROM UsuarioFila (NOLOCK) 
	                                    INNER JOIN Fila (NOLOCK) ON Fila.Id = UsuarioFila.IdFila
                                    WHERE Ativo = 1
                                        AND IdUsuario = {drPausa["Id"].ToString()}

					                    UNION ALL

				                    SELECT Nome, Fila.Id, ISNULL(IdDepartamento, 0) IdDepartamento, IsAtualizacaoManual, IsFilaAutomatica, IsRandomica, IsOnline, LoginOnline
				                    FROM Fila (NOLOCK) 
				                    WHERE IdDepartamento IN (0, {drPausa["IdDepartamento"].ToString()})
					                    AND Ativo = 1
					                    AND IsFilaAutomatica = 1
                                        AND IdConta = {dr["Id"].ToString()}

                                    ORDER BY Nome
                                ";

                                var dvSet = new DataView(GVPFramework.RetornaDataTable(query));
                                var filaTemp = "";

                                foreach (DataRowView drSet in dvSet)
                                {
                                    if (filaTemp != drPausa["Id"].ToString())
                                    {
                                        dv = new DataView(GVPFramework.RetornaDataTable(
                                            "SELECT Id, ISNULL(IdStatus, '3') IdStatus FROM UsuarioFila (NOLOCK) WHERE IdFila = " + drSet["Id"].ToString() + " AND IdUsuario = " + drPausa["Id"].ToString()));
                                        if (dv.Count > 0)
                                        {
                                            if (int.Parse(dv[0]["IdStatus"].ToString()) > 2)
                                            {
                                                GVPFramework.ExecutaQuery($"UPDATE UsuarioFila SET IdStatus = {(drSet["LoginOnline"].ToString() == "True" ? "2" : "1")} WHERE Id = {dv[0]["Id"].ToString()}");
                                                GVPFramework.ADDGestaoPausa(drPausa["Id"].ToString(), drSet["Id"].ToString(), (drSet["LoginOnline"].ToString() == "True" ? "2" : "1"));
                                            }
                                        }
                                        else
                                        {
                                            GVPFramework.ExecutaQuery($@"
                                                INSERT INTO UsuarioFila (IdFila, IdUsuario, IdStatus, IdUsuarioCriacao, DataCriacao) VALUES (
                                                    {drSet["Id"].ToString()}, {drPausa["Id"].ToString()}, {(drSet["LoginOnline"].ToString() == "True" ? "2" : "1")}, {drPausa["Id"].ToString()}, GETDATE()
                                                )
                                            ");

                                            GVPFramework.ADDGestaoPausa(drPausa["Id"].ToString(), drSet["Id"].ToString(), (drSet["LoginOnline"].ToString() == "True" ? "2" : "1"));
                                        }
                                    }

                                    filaTemp = drSet["Id"].ToString();
                                }

                                GVPFramework.ExecutaQuery($"UPDATE Usuario SET IdStatus = 2, DataStatus = GETDATE() WHERE Id = {drPausa["Id"].ToString()}");
                            }
                        }
                        #endregion
                        iTemp++;
                    }
                }

                timer1.Enabled = true;
            }
            else
            {
                timer1.Enabled = true;
            }
        }